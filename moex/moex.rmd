---
title: "moex"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
# Setup
```{r setup, include=FALSE}
options(digits = 4)
options(scipen = 999)

library(statsr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)

source("./scripts/saveGGplot.r")
source("./scripts/opendir.r")
```

# Data

## Strategy
```{r}
# source("./scripts/get_strategies.r")
# df_strategy <- get_strategies()
# write.csv(x=df_strategy, file="./data/strategy/strategy.csv", row.names = F)
```

```{r}
df_strategy <- read.csv("./data/strategy/strategy.csv",
                        colClasses = c("factor","POSIXct","numeric","integer", "factor",
                                       rep("numeric",6),rep("factor",3)))
# str(df_strategy)
```


## Work set
```{r}
vYears <- c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018")

df_daily <- df_strategy %>%
#  filter(year %in% vYears[1:12]) %>%
  filter(strategy == "RTS_18_22")
df_daily$index <- row.names(df_daily)
df_daily$strategy <- as.factor(as.character(df_daily$strategy))

vStrategies <- unique(df_daily$strategy)
```

## MOEX

### read from moex
```{r}
# source("./scripts/get_turnover_moex.r")
# df_moex <- get_data_from_moex(startDate = "2012-01-01",endDate = "2020-03-31")
# write.csv(x=df_moex, file="./data/moex.csv")

# source("./scripts/get_index_moex.r")
# l_index_moex <- get_index_moex(startDate = "2008-01-01", endDate = "2020-03-31")
# df_index_moex <- l_index_moex[[1]]
# df_index_moex_readme <- l_index_moex[[2]]
# write.csv(x=df_index_moex, file="./data/index_moex_20080101_20200331.csv")
# write.csv(x=df_index_moex_readme, file="./data/index_moex_readme_20080101_20200331.csv")
```

```{r}
df_turnover_moex     <- read.csv("./data/moex.csv")
df_index_moex        <- read.csv("./data/index_moex_20080101_20200331.csv")
df_index_moex_readme <- read.csv("./data/index_moex_readme_20080101_20200331.csv")
```

# Get moex indexes
```{r}
vColNamesMoex <- names(df_index_moex)
vColNamesMoexRTS <- grep(("RTSI|IMOEX|MOEX10|MOEXFN|tradedate"), vColNamesMoex, value = T)
vColNamesMoexRTS <- c(vColNamesMoexRTS,c("value.RTStn", "capitalization.RTStn", 
                                         "value.RTStl", "capitalization.RTStl",
                                         "value.RTS2",  "capitalization.RTS2",  
                                         "value.RTSch", 
                                         "value.RTSeu", "capitalization.RTSeu", 
                                         "value.RTSfn", "capitalization.RTSfn",
                                         "value.RTSin", "capitalization.RTSin", 
                                         "value.RTSmm", "capitalization.RTSmm",
                                         "value.RTSSIB","capitalization.RTSSIB",
                                         "value.RTScr", "capitalization.RTScr",
                                         "value.RTSog", "capitalization.RTSog",
                                         "capitalization.RTSTR",
                                         "capitalization.RTSTRN",
                                         "capitalization.RTSTRR"))

df_index_moexRTS <- df_index_moex[,vColNamesMoexRTS]
drops <- c(grep(("RTSIN"), vColNamesMoexRTS, value = T),
           "capitalization.IMOEX",
           "capitalization.MOEX10",
           "capitalization.MOEXFN")
df_index_moexRTS <- df_index_moexRTS[ , !(names(df_index_moexRTS) %in% drops)]
df_index_moexRTS[sapply(df_index_moexRTS, is.infinite)] <- NA
df_index_moexRTS$tradedate <- as.Date(df_index_moexRTS$tradedate)
vColNamesMoexRTS <- names(df_index_moexRTS)
rm(df_index_moex)
```

# Merge index into work set

```{r}
df_daily$date <- as.Date(df_daily$date)
df_daily <- merge(df_daily, df_index_moexRTS, by.x = "date", by.y = "tradedate", all.x = TRUE)
```

# ProbTS

Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.
```{r}
sliding_depth <- 30
source("./scripts/makePrColForStrategy.r")
df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = "tradestop",
                                 sliding_depth = sliding_depth)
```

```{r}
for (n in 2:sliding_depth) {
  df_daily[,paste0("tradestop_MA",n)] <- apply(df_daily[,paste0("tradestop_Pr",1:n)],1,sum,na.rm = F)
}
```

Содадим функцию способную посчитать средние веростноти трейдстопа на основе бетта распределений по скользящим средним количеству трейдстопов на текущий день
т.е. например заглядываем на 10 дней вперед смотрим количество трейдстопов и на этих данных моделируем распределение, затем по этому рапределению считаем среднее значение и его и записываем

```{r}
get_MeanBetaDist <- function(df,col_names) {
  mean_rbeta <- function(x, col_name) {
  # calculating sliding depth
  n <- as.integer(sub("tradestop_MA|tradestop_MA","",col_name))
  # return mean of rbeta distribution
  shape1 = as.integer(x[col_name])
  shape2 = n-as.integer(x[col_name])
  mean(rbeta(1000, shape1 = shape1, shape2 = shape2))
  }
  
  for (col_name in col_names) {
    df[,paste0("prob_",col_name)] <- apply(df_daily, 1, FUN = function(x) mean_rbeta(x,col_name))  
  }
  
  df
}
```

Посчитаем средние вероятности трейдстопа по скользящим средним. Применим созданную функцию.
```{r, message=F,warning=F}
df_daily <- get_MeanBetaDist(df = df_daily, col_names = paste0("tradestop_MA",2:sliding_depth))
df_daily$probTS <- apply(df_daily[,paste0("prob_tradestop_MA",2:sliding_depth)],1,mean,na.rm = F)

drops <- c(paste0("tradestop_Pr",1:sliding_depth),
           paste0("tradestop_MA",2:sliding_depth),
           paste0("prob_tradestop_MA",2:sliding_depth))

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
```

```{r}
# ProbTS density
branch <- "./plots/eda/ProbTS_Density/"
for (vStrategy in vStrategies){
  
  index_ts <- which(df_daily$tradestop == T & df_daily$strategy == vStrategy)
  sGGplot <- ggplot() +
    geom_density(data = df_daily[-index_ts,], aes(x=probTS), color = "darkgreen", fill="green", alpha=.3) +
    geom_density(data = df_daily[index_ts,], aes(x=probTS), color = "darkred", fill="red", alpha=.3) +
    ggtitle(paste0("Trade stop probability calculated by calendar month ",vStrategy)) +
    scale_color_manual(values = colors)
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

### Table probTS - realTS

Calculating real cumulative trade stop probability for `probTS` scale. 

```{r}
df_tsprob <- data.frame(mean_probTS = numeric(),
                        mean_profit = numeric(),
                        mean_realTS = numeric(),
                        strategy = character())

# botstraping for each prob level

vStratedies <- unique(df_daily$strategy)

for (strategy in vStratedies) {
  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS >= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }

  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS <= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }
}

# transform data to predicted and ci values
df_tsprob <- df_tsprob %>% 
  group_by(strategy, gr=cut(mean_probTS, 
                            breaks = seq(from = 0, to = 1, length.out = 100) )) %>%
  summarise(n = n(), 
            mean_probTS = mean(mean_probTS),
            pred_realTS = mean(mean_realTS),
            low_realTS = qnorm(c(0.025), mean = mean(mean_realTS), sd = sd(mean_realTS)),
            hight_realTS = qnorm(c(0.975), mean = mean(mean_realTS), sd = sd(mean_realTS))) %>%
  filter(!is.na(pred_realTS))

df_tsprob <- df_tsprob %>%
  mutate(low_realTS = case_when(low_realTS < 0 ~ 0,
                                low_realTS > 1 ~ 1,
                                TRUE ~ low_realTS),
         hight_realTS = case_when(hight_realTS < 0 ~ 0,
                                hight_realTS > 1 ~ 1,
                                TRUE ~ hight_realTS))
rm(df_daily_nona)
```

```{r}
branch <- "./plots/eda/MAProbTS_RealProbTS_with_CI/"
for (vStrategy in vStrategies){
  sGGplot <- df_tsprob %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = mean_probTS, y = pred_realTS)) +
    geom_point(aes(x = mean_probTS, y = low_realTS)) +
    geom_point(aes(x = mean_probTS, y = hight_realTS)) +
    ggtitle(paste0("Relationship between MAProbTS & RealProbTS with CI for ",vStrategy)) +
    ylab("RealProbTS") +
    xlab("MAProbTS")

  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

### RealProbTS 

Correspond MAProbTS & RealProbTS in historical data.

```{r}
get_realCI95probTSbyMAprob <- function(prob, df_tsprob) {
  if (is.nan(prob) == T) {
    data.frame("pred_realTS" = NA,
               "low_realTS" = NA,
               "hight_realTS" = NA)
    
  } else {
      index <- which.min(abs(df_tsprob$mean_probTS-prob))
      df_tsprob[index,c("pred_realTS","low_realTS","hight_realTS")]
  }
}

df_daily$RealProbTS       <- as.numeric(NA)
df_daily$RealProbTS_low   <- as.numeric(NA)
df_daily$RealProbTS_hight <- as.numeric(NA)

for (index in 1:nrow(df_daily)) {
  strategy <- df_daily[index,"strategy"][[1]]
  realTS95CI <- get_realCI95probTSbyMAprob(df_daily[index,"probTS"][[1]], 
                                           df_tsprob = df_tsprob[which(df_tsprob$strategy == strategy),])
  df_daily[index,"RealProbTS"] <- realTS95CI[1,"pred_realTS"][[1]]
  df_daily[index,"RealProbTS_low"] <- realTS95CI[1,"low_realTS"][[1]]
  df_daily[index,"RealProbTS_hight"] <- realTS95CI[1,"hight_realTS"][[1]]
}
```

```{r}
branch <- "./plots/eda/RealProbTS TimeLine/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = date, y = RealProbTS)) +
    ggtitle(paste0("Trade stop probability timeline for ",vStrategy))
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

# Other MA variabels

```{r}
vColNames <- c("profit", "bartime", "barprofit", 
               "MAE", "MFE", "entryprice", "exitprice", 
               vColNamesMoexRTS[2:length(vColNamesMoexRTS)])

df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = vColNames,
                                 sliding_depth = sliding_depth)
# creating MA
for (vColName in vColNames) {
  for (n in 2:sliding_depth) {
    df_daily[,paste0(vColName,"_SDMA",n)]   <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,sd,  na.rm = F)
    df_daily[,paste0(vColName,"_meanMA",n)] <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,mean,na.rm = F)
  }
  # del _Pr columns
  drops <- c(paste0(vColName,"_Pr",1:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  
  df_daily[,paste0(vColName,"_SDSD")]   <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_SDmean")] <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,mean,na.rm = F)
  df_daily[,paste0(vColName,"_meanSD")]   <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_meanmean")] <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,mean,na.rm = F)
  
  # del _MA columns
  drops <- c(paste0(vColName,"_SDMA",  2:sliding_depth),
             paste0(vColName,"_meanMA",2:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
}

for (vColName in vColNames) {
  df_daily[,paste0(vColName,"_pred")]   <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_low")]   <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_hight")]   <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  
  df_daily[,paste0(vColName,"_predSD")] <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_lowSD")] <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_hightSD")] <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  # del _MA columns
  drops <- c(paste0(vColName,"_meanmean"),
             paste0(vColName,"_meanSD"),
             paste0(vColName,"_SDmean"),
             paste0(vColName,"_SDSD"))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  }
```

# ProfitTS
```{r}
df_dailyTS <- df_daily %>%
  filter(!is.na(probTS))

df_TSprofit <- df_dailyTS %>%
  filter(tradestop == 1) %>%
  group_by(strategy) %>%
  summarise(TSprofit = mean(profit))

df_dailyTS <- merge(df_dailyTS, df_TSprofit, by = "strategy", all.x = T)

df_dailyTS <- df_dailyTS %>%
  mutate(profitTS = case_when(tradestop == 1 ~ TSprofit*RealProbTS,
                              TRUE ~ profit+TSprofit*RealProbTS))
drops <- c("TSprofit")
df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% drops)]
```

```{r}
branch <- "./plots/eda/expected profit distribution/"
for (vStrategy in vStrategies){
  sGGplot <- df_dailyTS %>%
    filter(strategy == vStrategy) %>%
    ggplot() + 
    geom_density(aes(x = profit), color="cadetblue4", fill="cadetblue4", alpha=.3) +
    geom_density(aes(x = profitTS), color="darkred", fill="#FF6666", alpha=.3) +
    ggtitle(paste0("Expected profit distribution (profitTS) for ", vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```



# sGGplot for numeric variable
## profitTS
```{r, message=FALSE}
branch <- paste0("./plots/eda/profitTS/")
if (!file.exists(branch)) {
                dir.create(branch)
}

vVariables <- names(df_dailyTS)[c(16:376)]
df_dailyTS$sumVariable <- as.numeric(NA)

for (vStrategy in vStrategies) {
  indexSTR <- which(df_dailyTS$strategy == vStrategy)
  
  for (vVariable in vVariables) {
    
    vMin <- min(df_dailyTS[indexSTR,vVariable], na.rm = T)
    vMax <- max(df_dailyTS[indexSTR,vVariable], na.rm = T)
    
    df_dailyTS[,"gr"] <- NA
    df_dailyTS[indexSTR,"gr"] <- cut(df_dailyTS[indexSTR,vVariable], 
                                     breaks = seq(from = vMin,
                                                  to = vMax,
                                                  length.out = 50))
    df_dailyTS[indexSTR,"sumVariable"] <- df_dailyTS[indexSTR,vVariable]
    
    branch <- paste0("./plots/eda/profitTS/",vVariable,"/")
    sGGplot <- df_dailyTS[indexSTR,] %>% 
      group_by(gr) %>%
      summarise(sumVariable = mean(sumVariable),
                profitTS = mean(profitTS)) %>%
      filter(!is.na(sumVariable)) %>%
      ggplot(aes(x = sumVariable, y = profitTS)) +
      geom_point(size=5) +
      ggtitle(paste0("Relationship between ",vVariable," & profitTS for ", vStrategy)) +
      xlab(vVariable) +
      ylab("profitTS")
    
    saveGGplot(sGGplot,branch,vStrategy)
  }
}
```

# Decision-making section

## Grouping

```{r}
vVariables_row <- names(df_dailyTS)[c(13,14,16:376)]
vVariables <- grep(("_low|_hight|_pred"), vVariables_row, value = T)
vVariables <- c(vVariables,c("probTS","RealProbTS","month","wday"))
```

```{r, message=F, warning=F}
make_groups <- function(df_dailyTS, vVariables, nBoot = 8) {
  
  get_index <- function(df = df_dailyTS) {
      df_index <- df %>%
        group_by(strategy) %>%
        summarise(start = min(index),stop = max(index),strategy = strategy[1]) %>%
        group_by(strategy) %>%
        summarise(index = sample(start:stop, stop-start, replace = T))
      vIndex <- df_index$index
      vIndex
  }
  
  get_group <- function(df_dailyTS) {
    
    if (is.numeric(df_dailyTS$variable) == T) {
      
      df_group <- df_dailyTS %>%
        group_by(sumVariable) %>%
        summarise(variableName = vVariable,
                  variableValue  = mean(variable, na.rm = T),
                  variableFactor = "numeric",
                  profitMean = mean(profitTS),
                  ProfitSD = sd(profitTS),
                  n = n())
      
    } else {
      df_group <- df_dailyTS %>%
        group_by(sumVariable) %>%
        summarise(variableName = vVariable,
                  variableValue  = 0,
                  variableFactor = as.character(variable[1]),
                  profitMean = mean(profitTS),
                  ProfitSD = sd(profitTS),
                  n = n())
      }

        df_group$group <- row.names(df_group)
        df_group <- df_group[ , !(names(df_group) == "sumVariable")]

                df_group
                }
  
  create_grouping_variable <- function(df_dailyTS) {
    if (is.numeric(df_dailyTS[,"variable"][[1]])) {
      
      # for numeric
      df_dailyTS <- df_dailyTS %>%
        group_by(strategy) %>%
        arrange(variable) %>%
        mutate(gr_index = 1:max(n())) %>%
        group_by(gr_index,
                 sumVariable = cut(gr_index,
                                   breaks = seq(from = 1,
                                                to = max(n()),
                                                length.out = ceiling((max(n())/100)+1))))
      
    } else {
      df_dailyTS$sumVariable <- df_dailyTS[,"variable"]
    }
    df_dailyTS
    }

  df_groups <- data.frame(
                          variableName = character(),
                          variableFactor = character(),
                          variableValue = double(),
                          profitMean = double(),
                          ProfitSD = double(),
                          n = integer(),
                          group = character())
  
  # get bootstrap indexes 
  df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% c("index"))]
  df_dailyTS <- df_dailyTS %>%
    arrange(strategy,date)
  df_dailyTS$index <- 1:nrow(df_dailyTS)
  l_indexes <- list()
  for (boot in 1:nBoot) {
    l_indexes[[boot]] <- get_index(df = df_dailyTS)
  }
  
for (vVariable in vVariables) {
  # create grouping variable
  df_dailyTS[,"variable"] <- df_dailyTS[,vVariable]
  df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% c("sumVariable","cutVariable"))]
  df_dailyTS <- create_grouping_variable(df_dailyTS = df_dailyTS)
  
  # create bootstrap df
  l_dailyTS <- list()
  for (boot in 1:nBoot) {
    l_dailyTS[[boot]] <- df_dailyTS[l_indexes[[boot]],]
  }
  
  # create groops
  df_group <- dplyr::bind_rows(lapply(l_dailyTS,get_group))
  df_groups <- dplyr::bind_rows(list(df_groups, df_group))
}
  
df_groups
}
```


```{r, message=F, warning=F}
#Rprof()
#Rprof(NULL)
#s <- summaryRprof()
#s
```


```{r, message=F, warning=F}
df_groups <- make_groups(df_dailyTS = df_dailyTS, vVariables = vVariables, nBoot = 10)
# calculate prob0
df_groups <- df_groups %>%
  filter(n != 1) %>%
  mutate(profitSE = ProfitSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4))
```


```{r}
#write.csv(x=df_groups, file="./data/df_groups.csv", row.names = F)
```

### Stability for variable
```{r}
df_groups <- df_groups %>%
  group_by(variableName, group) %>%
  summarise(variableValue = mean(variableValue),
            variableFactor = variableFactor[1],
            sdProb0 = sd(prob0),
            n = n(),
            seProb0 = sdProb0/sqrt(n),
            prob0 = mean(prob0)) %>%
  mutate(seProb0 = if_else(seProb0 < 0.01, 0.01, seProb0),
         weight = 1/((6*seProb0)^2))

df_groups %>%
  group_by(variableName) %>%
  summarise(weight = median(weight), sd = median(sdProb0), se = median(seProb0)) %>%
  arrange(desc(weight))
```

```{r}
df_dailyTS[sapply(df_dailyTS, is.infinite)] <- NA
```

## Ploting

## prob0

```{r, message=FALSE}
branch <- paste0("./plots/eda/prob0_for_variable/")
if (!file.exists(branch)) {
                dir.create(branch)
}

vVariables <- names(df_dailyTS)[c(16:376)]

for (vStrategy in vStrategies) {
  for (vVariable in vVariables) {
    
    branch <- paste0("./plots/eda/prob0_for_variable/",vVariable,"/")
    sGGplot <- df_groups %>%
      filter(strategy == vStrategy & variableName == vVariable) %>%
      ggplot(aes(x = variableValue, y = prob0)) +
      geom_point(size=5) +
      ggtitle(paste0("Relationship between ",vVariable," & prob0 for ", vStrategy)) +
      xlab(vVariable) +
      ylab("prob0")
    
    saveGGplot(sGGplot,branch,vStrategy)
  }
}
```

## Full table

```{r}
vColumns <- c("variableName", "group", "prob0", "variableValue", "weight")
df_groups$group <- as.numeric(df_groups$group)

# get matrix for groups
df_groupsW <- reshape(data.frame(df_groups[,vColumns]),
                      idvar = "group",
                      v.names = c("prob0", "variableValue", "weight"),
                      timevar = "variableName",
                      direction = "wide")
m_groupsW <- as.matrix(df_groupsW)

m_variableValue <- m_groupsW[,paste0("variableValue.",vVariables)]
m_prob0 <-  m_groupsW[,paste0("prob0.",vVariables)]
m_weight <- m_groupsW[,paste0("weight.",vVariables)]
vNRow <- nrow(m_groupsW)
```

```{r}
get_prob0m <- function(vRow,vVariables,m_groupsW,m_variableValue,m_prob0,m_weight,vNRow) {
# prepare matrix from row from df_dayly
m_RowDaily <- as.matrix(as.numeric(vRow[vVariables]))
m_RowDaily <- matrix(rep(m_RowDaily,each=vNRow),nrow=vNRow)

# create abs diff
m_minVariableValue <- abs(m_variableValue - m_RowDaily)

# find index of abs diff
minindex <- apply(m_minVariableValue, 2, which.min)
if (is.list(minindex) == T) {
  minindex <- unlist(minindex)
  vColNamesM <- names(minindex)
  vColNamesM <- gsub("[0-9]+$","",vColNamesM)
  vColNamesM <- gsub("[.]$","",vColNamesM)
  m_prob0 <-  m_groupsW[,gsub("variableValue","prob0",vColNamesM)]
  m_weight <- m_groupsW[,gsub("variableValue","weight",vColNamesM)]
}

vNCol <- ncol(m_prob0)
dim(m_prob0) <- c(vNRow*vNCol,1)
dim(m_weight) <- c(vNRow*vNCol,1)



minindex[which(is.na(minindex))] <- 0 #temp
minindex_in_row <- minindex + vNRow*(0:(vNCol-1))

vProb0  <- m_prob0[minindex_in_row,1]
vWeight <- m_weight[minindex_in_row,1]
vWeight <- vWeight/sum(vWeight)

vProb0w <- sum(vProb0*vWeight)

vProb0w
}
```


```{r}
gsub("[0-9]+$","","variableValue10.entryprice_predSD.19")
```

```{r}
Rprof()
df_dailyTS[,"prob0"] <- apply(df_dailyTS,1,FUN = function(x) get_prob0m(x,
                                                                        vVariables,
                                                                        m_groupsW,
                                                                        m_variableValue,
                                                                        m_prob0,
                                                                        m_weight,
                                                                        vNRow))
Rprof(NULL)
s <- summaryRprof()
s
```

```{r}
df_dailyTS %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profitTS), color = "chocolate") 
```


## Checking result

### PLot
```{r}
branch <- paste0("./plots/eda/prob0/")
if (!file.exists(branch)) {
                dir.create(branch)
}

for (vStrategy in vStrategies) {
  branch <- paste0("./plots/eda/prob0/",vStrategy,"/")
  if (!file.exists(branch)) {
                dir.create(branch)
}
}

vYears <- unique(df_dailyTS$year)

for (vStrategy in vStrategies) {
  branch <- paste0("./plots/eda/prob0/",vStrategy,"/")
  for (vYear in vYears) {
  
  sGGplot <- df_dailyTS %>%
    filter(strategy == vStrategy) %>%
    filter(year == vYear) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = profitTS)) +
    ggtitle(paste0(vStrategy," in ",vYear))
  
  saveGGplot(sGGplot,branch,vYear)
  }
}
opendir(branch)

```

### Table
```{r, warning=F, message=F}
vProb0s <- seq(from = 0.01, to = 1, by = 0.01)
df_Prob0Profits <- data.frame(strategy = character(),
                             prob0 = double(),
                             profitMean = double(), 
                             profitTSMean = double(),
                             n = integer(),
                             bootstrap = integer())



for (vProb0 in vProb0s) {
  
  for (boot in 1:10) {
  df_index <- df_dailyTS %>%
    group_by(strategy) %>%
    summarise(start = min(index),stop = max(index),strategy = strategy[1]) %>%
    group_by(strategy) %>%
    summarise(index = sample(start:stop, stop-start, replace = T))
  vIndex <- intersect(which(df_dailyTS$prob0 <= vProb0),df_index$index)
  
  if (length(vIndex) == 0) next
  
  df_Prob0Profit <- df_dailyTS[vIndex,] %>%
    group_by(strategy) %>%
    summarise(strategy = as.character(strategy[1]), 
              prob0 = vProb0,
              profitMean = mean(profit), 
              profitTSMean = mean(profitTS),
              n = n(),
              bootstrap = boot)
  
  df_Prob0Profits <- dplyr::bind_rows(list(df_Prob0Profits,df_Prob0Profit))
  }
  }

df_Prob0Profits$strategy <- as.factor(df_Prob0Profits$strategy)
df_Prob0Profits <- df_Prob0Profits %>%
  group_by(strategy,bootstrap) %>%
  mutate(freq = n/max(n),
         totalProfit = n*profitMean)
```

```{r}
head(df_Prob0Profits)
```


```{r}
df_Prob0 <- df_Prob0Profits %>%
  group_by(prob0) %>%
  summarise(prob0 = prob0[1],
            profitMean = mean(profitMean),
            totalProfit = mean(totalProfit),
            freq = mean(freq))
```

```{r}
vProb0 <- df_Prob0[which.max(df_Prob0$totalProfit),"prob0"][[1]]
```

```{r}
df_profit <- df_dailyTS %>%
  mutate(profitProb0 = if_else(prob0 <= vProb0, profit, 0)) %>%
  group_by(strategy, year, month) %>%
  summarise(profit = sum(profit),
            profitProb0 = sum(profitProb0),
            Prob0 = vProb0)

df_profit %>%
  group_by(year) %>%
  summarise(profit = sum(profit),
            profitProb0 = sum(profitProb0))
```


```{r}
branch <- paste0("./plots/eda/prob0cum/")
if (!file.exists(branch)) {
                dir.create(branch)
}

for (vStrategy in vStrategies) {
  
  sGGplot <- df_Prob0Profits %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = profitMean, color = as.factor(bootstrap) )) +
    ggtitle(paste0("Mean profit for ",vStrategy))
  saveGGplot(sGGplot,branch,paste0("MeanProfit_",vStrategy))
  
  sGGplot <- df_Prob0Profits %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = totalProfit, color = as.factor(bootstrap))) +
    ggtitle(paste0("Total profit for ",vStrategy))
  
  saveGGplot(sGGplot,branch,paste0("TotalProfit_",vStrategy))

}
opendir(branch)
```

# Combine strategy

## Read prob0Gr

```{r}
# Read csv
vStrategiesFGr <- c()
l_StrategiesFGr <- list()
vPath <- "./data/output/"
vFiles <- list.files(vPath, pattern = ".csv"); vFiles <- grep("Int", vFiles, value = T)
vFiles <- vFiles[-grep("daily", vFiles)]

for(vFile in vFiles) {
        vDfName <- gsub("profit_","",vFile)
        vStrategiesFGr[length(vStrategiesFGr)+1] <- vDfName
        l_StrategiesFGr[[vDfName]] <- read.csv(paste0(vPath,vFile))
}
df_StrategiesFGr <- dplyr::bind_rows(l_StrategiesFGr)
```

```{r}
df_StrategiesFGr %>%
  group_by(year) %>%
  summarise(profit = mean(profit),
            profitProb0 = mean(profitProb0, na.rm = T),
            diff = (profitProb0-profit))
```

## Stat diff

```{r}
library(BayesFactor)
source("./scripts/bayes/bayes_inference.R")
source("./scripts/bayes/bayes_util.R")
source("./scripts/bayes/bayes_single_mean_JZS.R")
source("./scripts/bayes/bayes_two_mean.R")
```

```{r}
str(df_StrategiesFGr)
```

```{r}
df_StrategiesFGr <- df_StrategiesFGr %>%
  mutate(diff = (profitProb0-profit),
         forecast = if_else(year > 2018, T, F))
```


```{r}
vIndex <- which((df_StrategiesFGr$year < 2019) | (df_StrategiesFGr$year == 2019 & df_StrategiesFGr$month < 2))
bayes_inference(y = diff, x = forecast, data = df_StrategiesFGr[vIndex,], 
                statistic = "mean", 
                type = "ci", alternative = "twosided", null = 0, 
                prior = "JZS", rscale = 1, 
                method = "theoretical", show_plot = T)
```

```{r}
bayes_inference(y = profit, data = df_StrategiesFGr, 
                statistic = "mean", 
                type = "ci", alternative = "twosided", null = 0, 
                prior = "JZS", rscale = 1, 
                method = "theoretical", show_plot = T)
```



## Read df_daily

```{r}
# Read csv
vStrategiesF <- c()
l_StrategiesF <- list()
vPath <- "./data/output/"
vFiles <- list.files(vPath, pattern = ".csv")
vFiles <- grep("Int", vFiles, value = T)
vFiles <- grep("daily", vFiles, value = T)

for(vFile in vFiles) {
        vDfName <- gsub("profit_daily_","",vFile)
        vStrategiesF[length(vStrategiesF)+1] <- vDfName
        l_StrategiesF[[vDfName]] <- read.csv(paste0(vPath,vFile))
}

vNColToSelect <- c("date","strategy","profit","tradestop","prob0","year","month","wday")
for (vStrategyF in vStrategiesF) {
        l_StrategiesF[[vStrategyF]] <- l_StrategiesF[[vStrategyF]][,vNColToSelect]
}

df_StrategiesF <- dplyr::bind_rows(l_StrategiesF)
df_StrategiesF$date <- as.POSIXct(df_StrategiesF$date)

df_StrategiesF$start <- unlist(strsplit(as.character(df_StrategiesF$strategy),"_"))[(as.numeric(row.names(df_StrategiesF))-1)*4+as.numeric(row.names(df_StrategiesF))+1]
df_StrategiesF$start <- as.factor(df_StrategiesF$start)
```

# Grouping

```{r, warning=F, message=F}
vStrategies <- unique(df_StrategiesF$strategy)
df_profits <- data.frame(strategy = character(),
                         year = integer(),
                         month = integer(),
                         prob0 = double(),
                         profit = double(),
                         profitProb0 = double())

vProb0s <- seq(from = 0.01, to = 1, by = 0.01)

for (vStrategy in vStrategies) {
  df_dailyTS <- df_StrategiesF %>%
    filter(strategy == vStrategy)
  df_dailyTS$index <- as.numeric(row.names(df_dailyTS))
  vLength <- nrow(df_dailyTS)
  
  df_Prob0Profits <- data.frame(strategy = character(),
                                prob0 = double(),
                                profitMean = double(), 
                                n = integer(),
                                bootstrap = integer())

for (vProb0 in vProb0s) {
  
  for (boot in 1:10) {
  df_index <- df_dailyTS %>%
    summarise(index = sample(index, vLength, replace = T))
  vIndex <- intersect(which(df_dailyTS$prob0 <= vProb0),df_index$index)
  
  if (length(vIndex) == 0) next
  
  df_Prob0Profit <- df_dailyTS[vIndex,] %>%
    summarise(strategy = as.character(strategy[1]), 
              prob0 = vProb0,
              profitMean = mean(profit),
              n = n(),
              bootstrap = boot)
  
  df_Prob0Profits <- dplyr::bind_rows(list(df_Prob0Profits,df_Prob0Profit))
  }
  }

df_Prob0Profits$strategy <- as.factor(df_Prob0Profits$strategy)
df_Prob0Profits <- df_Prob0Profits %>%
  group_by(strategy,bootstrap) %>%
  mutate(freq = n/max(n),
         totalProfit = n*profitMean)

df_Prob0 <- df_Prob0Profits %>%
  group_by(prob0) %>%
  summarise(prob0 = prob0[1],
            profitMean = mean(profitMean),
            totalProfit = mean(totalProfit),
            freq = mean(freq))

vProb0 <- df_Prob0[which.max(df_Prob0$totalProfit),"prob0"][[1]]

df_profit <- df_dailyTS %>%
  mutate(profitProb0 = if_else(prob0 <= vProb0, profit, 0)) %>%
  group_by(strategy, year, month) %>%
  summarise(profit = sum(profit),
            profitProb0 = sum(profitProb0),
            prob0 = vProb0)

df_profits <- dplyr::bind_rows(list(df_profits,df_profit))

print(vStrategy)
}
```


```{r}
df_profitsGr <- df_profits %>%
  group_by(strategy) %>%
  summarise(bestProb0 = prob0[1],
            profitSD = sd(profit, na.rm = T),
            profit = mean(profit, na.rm = T),
            profitProb0SD = sd(profitProb0, na.rm = T),
            meanProfitByProb0 = mean(profitProb0, na.rm = T),
            diff = meanProfitByProb0 / profit)
```


```{r}
df_StrategiesFM <- merge(df_StrategiesF,df_profitsGr[,c("strategy", "bestProb0", "meanProfitByProb0")],by = "strategy", all.x = TRUE)
head(df_StrategiesFM)
```

```{r}
df_StrategiesFM <- df_StrategiesFM %>%
  mutate(tradeAllowed = if_else(prob0 <= bestProb0, T, F)) %>%
  mutate(profitTA = if_else(tradeAllowed == T, profit, 0)) %>%
  mutate(meanProfitByProb0TA = if_else(tradeAllowed == T, meanProfitByProb0, 0))
head(df_StrategiesFM)
```



```{r}
df_StrategiesFMR <- df_StrategiesFM %>%
  group_by(start, date) %>%
  mutate(sumMeanProfitByProb0TA = sum(meanProfitByProb0TA, na.rm = T)) %>%
  mutate(freq = (meanProfitByProb0TA)/(sumMeanProfitByProb0TA)) %>%
  mutate(freq = if_else(sumMeanProfitByProb0TA == 0, 0, freq)) %>%
  mutate(profitM = profit*freq) %>%
  group_by(start, year, month) %>%
  summarise(profitM = sum(profitM, na.rm = T),
            profit = mean(profit, na.rm = T))

df_StrategiesFMR %>%
  group_by(start, year) %>%
  summarise(profitM = sum(profitM),
            profit = sum(profit)*20)
```

```{r}
df_StrategiesFM %>%
  group_by(strategy) %>%
  mutate(profitTA = if_else(tradeAllowed == T, profit, 0),
         nTA = if_else(tradeAllowed == T, 1, 0)) %>%
  summarise(profit = sum(profit, na.rm = T),
            profitTA = sum(profitTA, na.rm = T),
            n = n(),
            nTA = sum(tradeAllowed))
```

```{r}
df_StrategiesFM %>%
  group_by(start, date, tradeAllowed) %>%
  summarise(profitM = sum(profit.x*profitProb0/sum(profitProb0, na.rm = T), na.rm = T),
            profit = sum(profit.x, na.rm = T),
            n = n(),
            month = month[1],
            year = year[1]) %>%
  mutate(profitM = if_else(tradeAllowed == T, profitM, 0)) %>%
  group_by(start, date) %>%
  arrange(start, date) %>%
  summarise(profitM = sum(profitM, na.rm = T),
            profit = sum(profit, na.rm = T)/sum(n, na.rm = T),
            month = month[1],
            year = year[1]) %>%
  group_by(start) %>%
  summarise(profitM = sum(profitM),
            profit = sum(profit))
```































