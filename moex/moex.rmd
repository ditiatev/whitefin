---
title: "moex"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
options(digits = 4)
options(scipen=999)
```

```{r, message=FALSE}
library(statsr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)
```

# Data set
```{r}
df_daily <- read.csv("./data/dailystrategydata.csv", encoding = "UTF-8")
#df_daily <- read.csv("./data/betweendailystrategydata.csv", encoding = "UTF-8")

df_daily <- df_daily[,c(2,8,15,32)]
names(df_daily) <- c("position","date","timeclose","profit")
str(df_daily)
```

```{r}
df_daily <- df_daily %>%
  mutate(date = as.Date(date, format = '%d.%m.%Y')) %>%
  mutate(date = as.POSIXct(date, format = '%d.%m.%Y')) %>%
  mutate(profit = gsub("%", "", profit)) %>%
  mutate(profit = gsub(",", ".", profit)) %>%
  mutate(profit = as.numeric(profit)) %>%
  mutate(year = as.factor(year(date))) %>%
  mutate(month = as.factor(month(date))) %>%
  mutate(wday = as.factor(wday(date, week_start = 1))) %>%
  mutate(timeclose = hms(df_daily$timeclose)) %>%
  mutate(tradestop = case_when(timeclose$hour == 22 ~ F, T ~ T)) # for indays trade
  #mutate(tradestop = case_when(profit < -1 ~ T, T ~ F)) # for betweendays trade

df_daily <- na.omit(df_daily)
```

```{r}
summary(df_daily)
```


# PROFIT

## All period

```{r}
ggplot(data = df_daily, aes(x = profit, fill= yday(date))) +
  geom_density(aes(x=profit), color="green4", fill="lightgreen", alpha=.3) +
  ggtitle("Profit distribution by all data")
```

## Years

```{r}
df_daily %>%
        group_by(year) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```

```{r}
df_daily %>%
  group_by(year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), year = year[1]) %>%
  ggplot() +
  geom_col(aes(y = x_bar, x = year, fill = year), position = 'dodge')
```

sd - profit

```{r}
df_daily %>%
  group_by(year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit")
```

## Months

```{r}
df_daily %>%
        group_by(month) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(month) %>%
  summarise(x_bar = mean(profit), month = month[1]) %>%
  ggplot(aes(y = x_bar, x = month, fill = month)) +
  geom_col(position = 'dodge')
```

sd - profit

```{r}
df_daily %>%
  group_by(month) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit")
```

## Days

```{r}
df_daily %>%
        group_by(wday) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(wday) %>%
  summarise(x_bar = mean(profit), wday = wday[1]) %>%
  filter(wday %in% c(1,2,3,4,5)) %>%
  ggplot(aes(y = x_bar, x = wday, fill = wday)) +
  geom_col(position = 'dodge')
```

sd - profit

```{r}
df_daily %>%
  group_by(wday) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit")
```

## Position

```{r}
df_daily %>%
        group_by(position) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(position) %>%
  summarise(x_bar = mean(profit), position = position[1]) %>%
  ggplot(aes(y = x_bar, x = position, fill = position)) +
  geom_col(position = 'dodge')
```


## Trade stop

```{r}
df_daily %>%
        group_by(tradestop) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(tradestop) %>%
  summarise(x_bar = mean(profit), tradestop = tradestop[1]) %>%
  ggplot(aes(y = x_bar, x = tradestop, fill = tradestop)) +
  geom_col(position = 'dodge')
```

# TRADE STOP

## Trend
```{r}
df_daily %>%
  group_by(year,month) %>%
  mutate(n = n()) %>%
  filter(tradestop == TRUE) %>%
  summarise(n_stop = n(), n = n[1], freq = n_stop/n, date = ymd(paste(year, month, "01", sep= ' '))) %>%
  
  ggplot(aes(x = date, y = freq)) +
  geom_line(color="darkred") +
  ggtitle("Trade stop probability calculated by calendar month")
```

## Ditribution
### All period

```{r}
df_year <- df_daily

shape1 <- nrow(df_year[which(df_year$tradestop == T),])
shape2 <- nrow(df_year[which(df_year$tradestop == F),])
sim <- data.frame(prob = rbeta(2626,shape1,shape2))
summary(sim)

ggplot(data = sim) +
  geom_density(aes(x=prob), color="darkred", fill="#FF6666", alpha=.3) +
  ggtitle("TS Ditribution - All period")
```

### Crisis years 

For 2008-2009 and 2014-2015

```{r}
df_year <- df_daily %>%
  filter(year %in% c(2008,2009,2014,2015))

shape1 <- nrow(df_year[which(df_year$tradestop == T),])
shape2 <- nrow(df_year[which(df_year$tradestop == F),])
sim <- data.frame(prob = rbeta(100000,shape1,shape2))
summary(sim)

ggplot(data = sim) +
  geom_density(aes(x=prob), color="darkred", fill="#FF6666", alpha=.3)  +
  ggtitle("TS Ditribution - Crisis years")
```

### Calm years

For 2010-2013, 2016-2018.

```{r}
df_year <- df_daily %>%
  filter(year %in% c(2010,2011,2012,2013,2016,2017,2018))

shape1 <- nrow(df_year[which(df_year$tradestop == T),])
shape2 <- nrow(df_year[which(df_year$tradestop == F),])
sim <- data.frame(prob = rbeta(100000,shape1,shape2))
summary(sim)

ggplot(data = sim) +
  geom_density(aes(x=prob), color="darkred", fill="#FF6666", alpha=.3)  +
  ggtitle("TS Ditribution - Calm years")

rm(sim); rm(df_year)
```

# TS
## ProbTS by MA

Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.

```{r}
sliding_depth <- 30
df_daily$tradestop <- as.integer(df_daily$tradestop)

for (n in 1:sliding_depth) {
  df_daily[,paste0("TSprevious",n)] <- c(rep(NA,n), head(df_daily$tradestop,-n))
}

for (n in 2:sliding_depth) {
  df_daily[,paste0("TSMAprevious",n)] <- apply(df_daily[,paste0("TSprevious",1:n)],1,sum,na.rm = F)
}
```

Содадим функцию способную посчитать средние веростноти трейдстопа на основе бетта распределений по скользящим средним количеству трейдстопов на текущий день
т.е. например заглядываем на 10 дней вперед смотрим количество трейдстопов и на этих данных моделируем распределение, затем по этому рапределению считаем среднее значение и его и записываем

```{r}
get_prob <- function(df,col_names) {
  mean_rbeta <- function(x, col_name) {
  # calculating sliding depth
  n <- as.integer(sub("BPMAprevious|TSMAprevious","",col_name))
  # return mean of rbeta distribution
  shape1 = as.integer(x[col_name])
  shape2 = n-as.integer(x[col_name])
  mean(rbeta(1000, shape1 = shape1, shape2 = shape2))
  }
  
  for (col_name in col_names) {
    df[,paste0("prob_",col_name)] <- apply(df_daily, 1, FUN = function(x) mean_rbeta(x,col_name))  
  }
  
  df
}
```

```{r}
mean(rbeta(1000, shape1 = as.integer(5), shape2 = 10-5))
```


Посчитаем средние вероятности трейдстопа по скользящим средним. Применим созданную функцию.
```{r, message=F,warning=F}
df_daily <- get_prob(df = df_daily, col_names = paste0("TSMAprevious",2:sliding_depth))
```

Посчитаем среднюю вероятность трейдстопа по всем скользящим.
```{r}
df_daily$probTS <- apply(df_daily[,paste0("prob_TSMAprevious",2:sliding_depth)],1,mean,na.rm = F)
```

Delete unused columns
```{r}
drops <- c(paste0("TSprevious",1:sliding_depth),
           paste0("TSMAprevious",2:sliding_depth),
           paste0("prob_TSMAprevious",2:sliding_depth))

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
names(df_daily)
```

```{r}
index_ts <- which(df_daily$tradestop == T)
ggplot() +
  geom_density(data = df_daily[-index_ts,], aes(x=probTS), color = "darkgreen", fill="green", alpha=.3) +
  geom_density(data = df_daily[index_ts,], aes(x=probTS), color = "darkred", fill="red", alpha=.3)
```

```{r}
df_daily %>%
  filter(!is.na(probTS)) %>%
  ggplot() +
  geom_boxplot(aes(y = probTS, x = as.factor(tradestop), color = as.factor(tradestop)))
```

## Table probTS - realTS

Calculating real cumulative trade stop probability for `probTS` scale. 

```{r}
df_tsprob <- data.frame(mean_probTS = numeric(),
                        mean_profit = numeric(),
                        mean_realTS = numeric())


for (prob in 1:100) {
  
prob_index <- which(df_daily$probTS >= prob/100)

  if (length(prob_index >= 10)) {
    df_daily_nona <- na.omit(df_daily[prob_index,])
    nRow <- nrow(df_daily_nona)
    
    for (n in 1:50) {
      index <- sample(1:nRow,nRow,replace = T)
      df_tsprob <- rbind(df_tsprob,
                         data.frame(mean_probTS = mean(df_daily_nona[index,"probTS"]),
                                    mean_profit = mean(df_daily_nona[index,"profit"]),
                                    mean_realTS = mean(df_daily_nona[index,"tradestop"])))
    }
  }
}


for (prob in 1:100) {
  
prob_index <- which(df_daily$probTS <= prob/100)

  if (length(prob_index >= 10)) {
    df_daily_nona <- na.omit(df_daily[prob_index,])
    nRow <- nrow(df_daily_nona)
    
    for (n in 1:50) {
      index <- sample(1:nRow,nRow,replace = T)
      df_tsprob <- rbind(df_tsprob,
                         data.frame(mean_probTS = mean(df_daily_nona[index,"probTS"]),
                                    mean_profit = mean(df_daily_nona[index,"profit"]),
                                    mean_realTS = mean(df_daily_nona[index,"tradestop"])))
    }
  }
}

# transform data to predicted and ci values
df_tsprob <- df_tsprob %>% 
  group_by(gr=cut(mean_probTS, breaks = seq(from = 0, to = max(df_tsprob$mean_probTS), length.out = 100) )) %>%
  summarise(n = n(), 
            mean_probTS = mean(mean_probTS),
            pred_realTS = mean(mean_realTS),
            low_realTS = qnorm(c(0.025), mean = mean(mean_realTS), sd = sd(mean_realTS)),
            hight_realTS = qnorm(c(0.975), mean = mean(mean_realTS), sd = sd(mean_realTS))) %>%
  filter(!is.na(pred_realTS))

df_tsprob <- df_tsprob %>%
  mutate(low_realTS = case_when(low_realTS < 0 ~ 0,
                                low_realTS > 1 ~ 1,
                                TRUE ~ low_realTS),
         hight_realTS = case_when(hight_realTS < 0 ~ 0,
                                hight_realTS > 1 ~ 1,
                                TRUE ~ hight_realTS))
```

```{r}
ggplot(data = df_tsprob) +
  geom_point(aes(x = mean_probTS, y = pred_realTS)) +
  geom_point(aes(x = mean_probTS, y = low_realTS)) +
  geom_point(aes(x = mean_probTS, y = hight_realTS)) +
  ggtitle("Relationship between MAProbTS & RealProbTS with CI") +
  ylab("RealProbTS") +
  xlab("MAProbTS")
```

## RealProbTS 

Correspond MAProbTS & RealProbTS in historical data.

```{r}
get_realCI95probTSbyMAprob <- function(prob, df_tsprob) {
  index <- which.min(abs(df_tsprob$mean_probTS-prob))
  df_tsprob[index,c("pred_realTS","low_realTS","hight_realTS")]
}

for (index in 1:nrow(df_daily)) {
  realTS95CI <- get_realCI95probTSbyMAprob(df_daily[index,"probTS"], df_tsprob = df_tsprob)
  df_daily[index,"RealProbTS"] <- realTS95CI[1,"pred_realTS"][[1]]
  df_daily[index,"RealProbTS_low"] <- realTS95CI[1,"low_realTS"][[1]]
  df_daily[index,"RealProbTS_hight"] <- realTS95CI[1,"hight_realTS"][[1]]
}
```

```{r}
ggplot(data = df_daily) +
  geom_point(aes(x = date, y = RealProbTS)) +
  ggtitle("Trade stop probability timeline")
```

# SD

Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.

```{r}
sliding_depth <- 30

for (n in 1:sliding_depth) {
  df_daily[,paste0("PRFpr",n)] <- c(rep(NA,n), head(df_daily$profit,-n))
}

for (n in 2:sliding_depth) {
  df_daily[,paste0("PRFMAprSD",n)] <- apply(df_daily[,paste0("PRFpr",1:n)],1,sd,na.rm = F)
}
```

```{r, message=F,warning=F}
df_daily$meanSD <- apply(df_daily[,paste0("PRFMAprSD",2:sliding_depth)],1,mean,na.rm = F)
df_daily$SDSD   <- apply(df_daily[,paste0("PRFMAprSD",2:sliding_depth)],1,sd,na.rm = F)
```

```{r}
df_daily$SDPRF       <- qnorm(c(0.5)  , mean = df_daily$meanSD, sd = df_daily$SDSD)
df_daily$SDPRF_low   <- qnorm(c(0.025), mean = df_daily$meanSD, sd = df_daily$SDSD)
df_daily$SDPRF_hight <- qnorm(c(0.975), mean = df_daily$meanSD, sd = df_daily$SDSD)
```


Delete unused columns
```{r}
drops <- c(paste0("PRFpr",1:sliding_depth),
           paste0("PRFMAprSD",2:sliding_depth),
           "meanSD", "SDSD")

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
```

# PROFIT
## ProfitTS distribution

```{r}
df_daily_nona <- na.omit(df_daily)

indexTS <- which(df_daily_nona$tradestop == 1)
TSprofit <- mean(df_daily_nona[indexTS,"profit"])

df_dailyTS <- df_daily_nona %>%
  mutate(profitTS = case_when(tradestop == 1 ~ TSprofit*RealProbTS,
                              TRUE ~ profit+TSprofit*RealProbTS))
  
ggplot(data = df_dailyTS) +
  geom_density(aes(x = profitTS), color="darkred", fill="#FF6666", alpha=.3) +
  ggtitle("Expected profit distribution (profitTS)")
```

## RealProbTS-ProfitTS

```{r}
df_dailyTS %>% 
  group_by(gr=cut(RealProbTS, breaks = seq(from = min(df_dailyTS$RealProbTS), to = max(df_dailyTS$RealProbTS), length.out = 20) )) %>%
  summarise(n = n(), 
            RealProbTS = mean(RealProbTS),
            profitTS = mean(profitTS)) %>%
  ggplot(aes(x = RealProbTS, y = profitTS)) +
  geom_point() +
  ggtitle("Relationship between RealParTS & profitTS") +
  geom_smooth(method = "lm")
```

```{r}
df_cumProfitTS <- data.frame(profitTS = numeric(),
                             RealProbTS = numeric(),
                             n = numeric())
groups <- seq(from = min(df_dailyTS$RealProbTS), to = max(df_dailyTS$RealProbTS), length.out = 20)

for (group in groups) {
  index <- which(df_dailyTS$RealProbTS <= group)
  profitTS <- mean(df_dailyTS[index,"profitTS"])
  n = length(index)
  df_cumProfitTS <- rbind(df_cumProfitTS, data.frame(profitTS = profitTS,
                                                     RealProbTS = group,
                                                     n = n))
}

df_cumProfitTS %>%
  ggplot(aes(x = RealProbTS, y = profitTS)) +
  geom_point() +
  ggtitle("Cumulative Relationship between RealParTS & profitTS") +
  geom_smooth(method = "lm")
```

## SDPRF-ProfitTS

```{r}
df_dailyTS %>% 
  group_by(gr=cut(SDPRF, breaks = seq(from = min(df_dailyTS$SDPRF), to = max(df_dailyTS$SDPRF), length.out = 20) )) %>%
  summarise(n = n(), 
            SDPRF = mean(SDPRF),
            profitTS = mean(profitTS)) %>%
  ggplot(aes(x = SDPRF, y = profitTS)) +
  geom_point() +
  ggtitle("Relationship between SDPRF & profitTS") +
  geom_smooth(method = "lm")
```

```{r}
df_cumProfitTS <- data.frame(profitTS = numeric(),
                             SDPRF = numeric(),
                             n = numeric())
groups <- seq(from = min(df_dailyTS$SDPRF), to = max(df_dailyTS$SDPRF), length.out = 20)

for (group in groups) {
  index <- which(df_dailyTS$SDPRF <= group)
  profitTS <- mean(df_dailyTS[index,"profitTS"])
  n = length(index)
  df_cumProfitTS <- rbind(df_cumProfitTS, data.frame(profitTS = profitTS,
                                                     SDPRF = group,
                                                     n = n))
}

df_cumProfitTS %>%
  filter(n > 10) %>%
  ggplot(aes(x = SDPRF, y = profitTS)) +
  geom_point() +
  ggtitle("Cumulative Relationship between RealParTS & profitTS") +
  geom_smooth(method = "lm")
```

# Decision-making section

## Grouping
```{r}
names(df_daily)
```
```{r}
vMeanProfit <- mean(df_daily$profit)
```

```{r}
vYears <- unique(df_dailyTS$year)
vYears <- vYears[1:7]
```

### wday
```{r}
g_wday_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,wday) %>%
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            ngr = 1)

g_wday_dailyTS <- g_wday_dailyTS %>%
  group_by(wday) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(wday,profitGrD,profitGrSD,profitTSSD,n,densityT,density))
  

g_wday_dailyTS

df_dailyTS %>%
  group_by(wday,year) %>%
  summarise(x_bar = mean(profitTS), wday = wday[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("wday")
```

### month
```{r}
g_month_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,month) %>%
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            ngr = 1)

g_month_dailyTS <- g_month_dailyTS %>%
  group_by(month) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(month,profitGrD,profitGrSD,profitTSSD,n,densityT,density))
  

g_month_dailyTS

df_dailyTS %>%
  group_by(month,year) %>%
  summarise(x_bar = mean(profitTS), month = month[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("month")
```

### SDPRF
```{r}
ngr <- 10
g_SDPRF_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,
           gSDPRF=cut(SDPRF, 
                  breaks = seq(from = min(df_dailyTS$SDPRF), 
                               to = max(df_dailyTS$SDPRF), 
                               length.out = ngr) )) %>%  
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            SDPRF = mean(SDPRF),
            ngr = 1)

g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  group_by(gSDPRF) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr),
            SDPRF = mean(SDPRF)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(gSDPRF,SDPRF,profitGrD,profitGrSD,profitTSSD,n,densityT,density))
  

g_SDPRF_dailyTS

df_dailyTS %>%
  group_by(year,
           SDPRF=cut(SDPRF, 
                  breaks = seq(from = min(df_dailyTS$SDPRF), 
                               to = max(df_dailyTS$SDPRF), 
                               length.out = ngr))) %>%
  summarise(x_bar = mean(profitTS), SDPRF = SDPRF[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("SDPRF")
```

### RealProbTS
```{r}
ngr <- 10
g_RealProbTS_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,
           gRealProbTS=cut(RealProbTS, 
                  breaks = seq(from = min(df_dailyTS$RealProbTS), 
                               to = max(df_dailyTS$RealProbTS), 
                               length.out = ngr) )) %>%  
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            RealProbTS = mean(RealProbTS),
            ngr = 1)

g_RealProbTS_dailyTS <- 
  g_RealProbTS_dailyTS %>%
  group_by(gRealProbTS) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr),
            RealProbTS = mean(RealProbTS)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(gRealProbTS,RealProbTS,profitGrD,profitGrSD,profitTSSD,n,densityT,density))

g_RealProbTS_dailyTS

df_dailyTS %>%
  group_by(year,
           RealProbTS=cut(RealProbTS, 
                  breaks = seq(from = min(df_dailyTS$RealProbTS), 
                               to = max(df_dailyTS$RealProbTS), 
                               length.out = ngr))) %>%
  summarise(x_bar = mean(profitTS), RealProbTS = RealProbTS[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("RealProbTS")
```
## Total Density
```{r}
densityTmin <- min(g_wday_dailyTS[1,"densityT"][[1]],
                  g_month_dailyTS[1,"densityT"][[1]],
                  g_RealProbTS_dailyTS[1,"densityT"][[1]],
                  g_SDPRF_dailyTS[1,"densityT"][[1]])

g_wday_dailyTS <- g_wday_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = wday)
g_month_dailyTS <- g_month_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = month)
g_RealProbTS_dailyTS <- g_RealProbTS_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = RealProbTS)
g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = SDPRF)
```


```{r}
# prob
g_wday_dailyTS <- 
  g_wday_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
# prob
g_month_dailyTS <- 
  g_month_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
# prob
g_RealProbTS_dailyTS <- 
  g_RealProbTS_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
# prob
g_SDPRF_dailyTS <- 
  g_SDPRF_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
```


## Choosing reliable groups

```{r}
#g_wday_dailyTS
g_wday_dailyTS <- g_wday_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_wday_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_wday_dailyTS <- g_wday_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

# g_month_dailyTS
g_month_dailyTS <- g_month_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_month_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_month_dailyTS <- g_month_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

# g_RealProbTS_dailyTS
g_RealProbTS_dailyTS <- g_RealProbTS_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_RealProbTS_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_RealProbTS_dailyTS <- g_RealProbTS_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

# g_SDPRF_dailyTS
g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_SDPRF_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))
```


## Full table
```{r}
get_group_profit <- function(value, group_table) {
  if (is.factor(value) == T) {
    index <- which(group_table$var == value)
  } else {
    index <- which.min(abs(group_table$var-value))
  }
  group_table[index,c("profitGrDT","profitGrSD","var","n","prob0","probMean")]
}

for (index in 1:nrow(df_dailyTS)) {
  # wday
  df_group_profit <- get_group_profit(value = df_dailyTS[index,"wday"], 
                                      group_table = g_wday_dailyTS)
  df_dailyTS[index,"pr_wday"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_wday"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_wday"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_wday"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_wday"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_wday"] <- df_group_profit[1,"probMean"][[1]]
  
  # month
  df_group_profit <- get_group_profit(df_dailyTS[index,"month"], 
                                      group_table = g_month_dailyTS)
  df_dailyTS[index,"pr_month"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_month"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_month"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_month"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_month"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_month"] <- df_group_profit[1,"probMean"][[1]]
  
  # SDPRF
  df_group_profit <- get_group_profit(df_dailyTS[index,"SDPRF"], 
                                      group_table = g_SDPRF_dailyTS)
  df_dailyTS[index,"pr_SDPRF"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_SDPRF"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_SDPRF"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_SDPRF"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_SDPRF"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_SDPRF"] <- df_group_profit[1,"probMean"][[1]]
  
  # RealProbTS
  df_group_profit <- get_group_profit(df_dailyTS[index,"RealProbTS"], 
                                      group_table = g_RealProbTS_dailyTS)
  df_dailyTS[index,"pr_RealProbTS"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_RealProbTS"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_RealProbTS"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_RealProbTS"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_RealProbTS"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_RealProbTS"] <- df_group_profit[1,"probMean"][[1]]
}

```

## Checking result
```{r, warning=F, message=F}
df_dailyTS <- df_dailyTS %>%
  mutate(profitGR = vProfitTS+(pr_wday + pr_month + pr_SDPRF+pr_RealProbTS)/4)

prob0Level <- 0.15
df_profitM <- df_dailyTS %>%
  filter(prob0 < prob0Level) %>%
  group_by(year) %>%
  summarise(profitM = mean(profit), nM = n())

df_profitT <- df_dailyTS %>%
  group_by(year) %>%
  summarise(profitT = mean(profit), nT = n())

df_profit <- merge(df_profitM,df_profitT,by = "year", all = TRUE)

df_profit <- df_profit %>%
  mutate(freq = round(nM/nT,2),
         dif = profitM/profitT) 

summary(df_profit)
```

```{r}
df_profit
```


```{r}
df_dailyTS <- df_dailyTS %>%
  mutate(prob0 = (prob0_wday + prob0_month + prob0_SDPRF + probMean_SDPRF)/4)

df_dailyTS[,] %>%
  group_by(gprob0=cut(prob0, 
                      breaks = seq(from = min(df_dailyTS$prob0,na.rm = T), 
                                        to = max(df_dailyTS$prob0,na.rm = T), 
                                        length.out = 20) )) %>%
  summarise(prob0 = mean(prob0), profit = mean(profit)) %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profit))

df_dailyTS[,] %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profitTS))
```
