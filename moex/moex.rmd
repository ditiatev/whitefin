---
title: "moex"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
# Setup
```{r setup, include=FALSE}
options(digits = 4)
options(scipen=999)

library(statsr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)
```

# Data

## Strategy
```{r}
# source("./scripts/get_strategies.r")
# df_strategy <- get_strategies()
# write.csv(x=df_strategy, file="./data/strategy/strategy.csv", row.names = F)
```

```{r}
df_strategy <- read.csv("./data/strategy/strategy.csv")
str(df_strategy)
```


## Work set
```{r}
vYears <- c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018")

df_daily <- df_strategy %>%
  filter(year %in% vYears[1:12])
```

## MOEX

### read from moex
```{r}
# source("./scripts/get_turnover_moex.r")
# df_moex <- get_data_from_moex(startDate = "2012-01-01",endDate = "2020-03-31")
# write.csv(x=df_moex, file="./data/moex.csv")

# source("./scripts/get_index_moex.r")
# l_index_moex <- get_index_moex(startDate = "2008-01-01", endDate = "2020-03-31")
# df_index_moex <- l_index_moex[[1]]
# df_index_moex_readme <- l_index_moex[[2]]
# write.csv(x=df_index_moex, file="./data/index_moex_20080101_20200331.csv")
# write.csv(x=df_index_moex_readme, file="./data/index_moex_readme_20080101_20200331.csv")
```

```{r}
df_turnover_moex     <- read.csv("./data/moex.csv")
df_index_moex        <- read.csv("./data/index_moex_20080101_20200331.csv")
df_index_moex_readme <- read.csv("./data/index_moex_readme_20080101_20200331.csv")
```

# EDA
## PROFIT

## All period

```{r}
ggplot(data = df_daily, aes(x = profit, fill= yday(date))) +
  geom_density(aes(x=profit), color="green4", fill="lightgreen", alpha=.3) +
  ggtitle("Profit distribution by all data") +
  facet_wrap("strategy")
```

## Years

```{r}
df_daily %>%
        group_by(strategy, year) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```

```{r}
df_daily %>%
  group_by(strategy, year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(strategy, year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), year = year[1]) %>%
  ggplot() +
  geom_col(aes(y = x_bar, x = year, fill = year), position = 'dodge') +
  facet_wrap("strategy")
```

sd - profit

```{r}
df_daily %>%
  group_by(strategy, year) %>%
  summarise(profit_mean = mean(profit), profit_sd = sd(profit),strategy = strategy[1]) %>%
  ggplot(aes(y = profit_mean, x = profit_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit") +
  facet_wrap("strategy")
```

## Months

```{r}
df_daily %>%
        group_by(strategy,month) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(strategy,month) %>%
  summarise(x_bar = mean(profit), month = month[1]) %>%
  ggplot(aes(y = x_bar, x = month, fill = month)) +
  geom_col(position = 'dodge') +
  facet_wrap("strategy")
```

sd - profit

```{r}
df_daily %>%
  group_by(strategy, month) %>%
  summarise(profit_mean = mean(profit), profit_sd = sd(profit),strategy = strategy[1]) %>%
  ggplot(aes(y = profit_mean, x = profit_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit") +
  facet_wrap("strategy")
```

## Days

```{r}
df_daily %>%
        group_by(strategy,wday) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(strategy,wday) %>%
  summarise(x_bar = mean(profit), wday = wday[1]) %>%
  filter(wday %in% c(1,2,3,4,5)) %>%
  ggplot(aes(y = x_bar, x = wday, fill = wday)) +
  geom_col(position = 'dodge') +
  facet_wrap("strategy")
```

sd - profit

```{r}
df_daily %>%
  group_by(strategy, wday) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit") +
  facet_wrap("strategy")
```

## Position

```{r}
df_daily %>%
        group_by(strategy, position) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(strategy, position) %>%
  summarise(x_bar = mean(profit), position = position[1]) %>%
  ggplot(aes(y = x_bar, x = position, fill = position)) +
  geom_col(position = 'dodge') +
  facet_wrap("strategy")
```


## Trade stop

```{r}
df_daily %>%
        group_by(strategy, tradestop) %>%
        summarise(mean_profit = mean(profit), sd_profit = sd(profit), median_profit = median(profit), n = n())

df_daily %>%
  group_by(strategy, tradestop) %>%
  summarise(x_bar = mean(profit), tradestop = tradestop[1]) %>%
  ggplot(aes(y = x_bar, x = tradestop, fill = tradestop)) +
  geom_col(position = 'dodge') +
  facet_wrap("strategy")
```

## TRADE STOP

### Trend
```{r}
df_daily %>%
  group_by(strategy, year,month) %>%
  mutate(n = n()) %>%
  filter(tradestop == TRUE) %>%
  summarise(n_stop = n(), n = n[1], freq = n_stop/n,date = ymd(paste(year, month, "01", sep= ' '))) %>%
  
  ggplot() +
  geom_line(aes(x = date, y = freq), color="darkred") +
  ggtitle("Trade stop probability calculated by calendar month") +
  facet_wrap("strategy")
```

# MA


Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.

```{r}
vYears <- c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018")
df_daily <- df_strategy %>%
  filter(year %in% vYears[1:12])
df_daily$index <- row.names(df_daily)
```

```{r}
sliding_depth <- 30
vColNames <- c("tradestop","profit","bartime","barprofit","MAE","MFE")

source("./scripts/makePrColForStrategy.r")
df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = "tradestop",
                                 sliding_depth = sliding_depth)
```

## ProbTS

```{r}
for (n in 2:sliding_depth) {
  df_daily[,paste0("tradestop_MA",n)] <- apply(df_daily[,paste0("tradestop_Pr",1:n)],1,sum,na.rm = F)
}
```

Содадим функцию способную посчитать средние веростноти трейдстопа на основе бетта распределений по скользящим средним количеству трейдстопов на текущий день
т.е. например заглядываем на 10 дней вперед смотрим количество трейдстопов и на этих данных моделируем распределение, затем по этому рапределению считаем среднее значение и его и записываем

```{r}
get_MeanBetaDist <- function(df,col_names) {
  mean_rbeta <- function(x, col_name) {
  # calculating sliding depth
  n <- as.integer(sub("tradestop_MA|tradestop_MA","",col_name))
  # return mean of rbeta distribution
  shape1 = as.integer(x[col_name])
  shape2 = n-as.integer(x[col_name])
  mean(rbeta(1000, shape1 = shape1, shape2 = shape2))
  }
  
  for (col_name in col_names) {
    df[,paste0("prob_",col_name)] <- apply(df_daily, 1, FUN = function(x) mean_rbeta(x,col_name))  
  }
  
  df
}
```

Посчитаем средние вероятности трейдстопа по скользящим средним. Применим созданную функцию.
```{r, message=F,warning=F}
df_daily <- get_MeanBetaDist(df = df_daily, col_names = paste0("tradestop_MA",2:sliding_depth))
df_daily$probTS <- apply(df_daily[,paste0("prob_tradestop_MA",2:sliding_depth)],1,mean,na.rm = F)

drops <- c(paste0("tradestop_Pr",1:sliding_depth),
           paste0("tradestop_MA",2:sliding_depth),
           paste0("prob_tradestop_MA",2:sliding_depth))

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
```

```{r}
index_ts <- which(df_daily$tradestop == T)
ggplot() +
  geom_density(data = df_daily[-index_ts,], aes(x=probTS), color = "darkgreen", fill="green", alpha=.3) +
  geom_density(data = df_daily[index_ts,], aes(x=probTS), color = "darkred", fill="red", alpha=.3) +
  facet_wrap("strategy")
```

### Table probTS - realTS

Calculating real cumulative trade stop probability for `probTS` scale. 

```{r}
df_tsprob <- data.frame(mean_probTS = numeric(),
                        mean_profit = numeric(),
                        mean_realTS = numeric(),
                        strategy = character())

# botstraping for each prob level

vStratedies <- unique(df_daily$strategy)

for (strategy in vStratedies) {
  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS >= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }

  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS <= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }
}

# transform data to predicted and ci values
df_tsprob <- df_tsprob %>% 
  group_by(strategy, gr=cut(mean_probTS, breaks = seq(from = 0, to = max(df_tsprob$mean_probTS), length.out = 100) )) %>%
  summarise(n = n(), 
            mean_probTS = mean(mean_probTS),
            pred_realTS = mean(mean_realTS),
            low_realTS = qnorm(c(0.025), mean = mean(mean_realTS), sd = sd(mean_realTS)),
            hight_realTS = qnorm(c(0.975), mean = mean(mean_realTS), sd = sd(mean_realTS))) %>%
  filter(!is.na(pred_realTS))

df_tsprob <- df_tsprob %>%
  mutate(low_realTS = case_when(low_realTS < 0 ~ 0,
                                low_realTS > 1 ~ 1,
                                TRUE ~ low_realTS),
         hight_realTS = case_when(hight_realTS < 0 ~ 0,
                                hight_realTS > 1 ~ 1,
                                TRUE ~ hight_realTS))
rm(df_daily_nona)
```

```{r}
ggplot(data = df_tsprob) +
  geom_point(aes(x = mean_probTS, y = pred_realTS)) +
  geom_point(aes(x = mean_probTS, y = low_realTS)) +
  geom_point(aes(x = mean_probTS, y = hight_realTS)) +
  ggtitle("Relationship between MAProbTS & RealProbTS with CI") +
  ylab("RealProbTS") +
  xlab("MAProbTS") +
  facet_wrap("strategy")
```

### RealProbTS 

Correspond MAProbTS & RealProbTS in historical data.

```{r}
get_realCI95probTSbyMAprob <- function(prob, df_tsprob) {
  if (is.nan(prob) == T) {
    data.frame("pred_realTS" = NA,
               "low_realTS" = NA,
               "hight_realTS" = NA)
    
  } else {
      index <- which.min(abs(df_tsprob$mean_probTS-prob))
      df_tsprob[index,c("pred_realTS","low_realTS","hight_realTS")]
  }
}

df_daily$RealProbTS       <- as.numeric(NA)
df_daily$RealProbTS_low   <- as.numeric(NA)
df_daily$RealProbTS_hight <- as.numeric(NA)

for (index in 1:nrow(df_daily)) {
  strategy <- df_daily[index,"strategy"][[1]]
  realTS95CI <- get_realCI95probTSbyMAprob(df_daily[index,"probTS"][[1]], 
                                           df_tsprob = df_tsprob[which(df_tsprob$strategy == strategy),])
  df_daily[index,"RealProbTS"] <- realTS95CI[1,"pred_realTS"][[1]]
  df_daily[index,"RealProbTS_low"] <- realTS95CI[1,"low_realTS"][[1]]
  df_daily[index,"RealProbTS_hight"] <- realTS95CI[1,"hight_realTS"][[1]]
}
```

```{r}
ggplot(data = df_daily) +
  geom_point(aes(x = date, y = RealProbTS)) +
  ggtitle("Trade stop probability timeline") +
  facet_wrap("strategy")
```

# Mean & SD for vafriabels

```{r}
vColNames <- c("profit", "bartime", "barprofit", "MAE", "MFE")
df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = vColNames,
                                 sliding_depth = sliding_depth)
# creating MA
for (vColName in vColNames) {
  for (n in 2:sliding_depth) {
    df_daily[,paste0(vColName,"_SDMA",n)]   <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,sd,  na.rm = F)
    df_daily[,paste0(vColName,"_meanMA",n)] <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,mean,na.rm = F)
  }
  # del _Pr columns
  drops <- c(paste0(vColName,"_Pr",1:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  
  df_daily[,paste0(vColName,"_SDSD")]   <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_SDmean")] <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,mean,na.rm = F)
  df_daily[,paste0(vColName,"_meanSD")]   <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_meanmean")] <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,mean,na.rm = F)
  
  # del _MA columns
  drops <- c(paste0(vColName,"_SDMA",  2:sliding_depth),
             paste0(vColName,"_meanMA",2:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
}
```

```{r}
for (vColName in vColNames) {
  df_daily[,paste0(vColName,"_pred")]   <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_low")]   <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_hight")]   <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  
  df_daily[,paste0(vColName,"_predSD")] <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_lowSD")] <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_hightSD")] <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  # del _MA columns
  drops <- c(paste0(vColName,"_meanmean"),
             paste0(vColName,"_meanSD"),
             paste0(vColName,"_SDmean"),
             paste0(vColName,"_SDSD"))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  }
```

# PROFIT
## ProfitTS distribution

```{r}
summary(df_daily$profit)
```


```{r}
df_dailyTS <- na.omit(df_daily)

df_TSprofit <- df_dailyTS %>%
  filter(tradestop == 1) %>%
  group_by(strategy) %>%
  summarise(TSprofit = mean(profit))

df_dailyTS <- merge(df_dailyTS, df_TSprofit, by = "strategy", all.x = T)

df_dailyTS <- df_dailyTS %>%
  mutate(profitTS = case_when(tradestop == 1 ~ TSprofit*RealProbTS,
                              TRUE ~ profit+TSprofit*RealProbTS))
  
ggplot(data = df_dailyTS) +
  geom_density(aes(x = profitTS), color="darkred", fill="#FF6666", alpha=.3) +
  ggtitle("Expected profit distribution (profitTS)") +
  facet_wrap("strategy")
df_dailyTS$TSprofit

drops <- c("TSprofit")
df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% drops)]
```

## RealProbTS-ProfitTS

```{r}
names(df_dailyTS)
```


```{r, message=FALSE}
vVariables <- names(df_dailyTS)[21:24]
df_dailyTS$sumVariable <- as.numeric(NA)

for (vStrategy in vStratedies) {
  indexSTR <- which(df_daily$strategy == vStrategy)
  
  for (vVariable in vVariables) {
    
    vMin <- min(df_dailyTS[indexSTR,vVariable], na.rm = T)
    vMax <- max(df_dailyTS[indexSTR,vVariable], na.rm = T)
    
    df_dailyTS[,"gr"] <- NA
    df_dailyTS[indexSTR,"gr"] <- cut(df_dailyTS[indexSTR,vVariable], 
                                     breaks = seq(from = vMin,
                                                  to = vMax,
                                                  length.out = 20))
    df_dailyTS[indexSTR,"sumVariable"] <- df_dailyTS[indexSTR,vVariable]
    
    print(
    df_dailyTS[indexSTR,] %>% 
      group_by(gr) %>%
      summarise(sumVariable = mean(sumVariable),
                profitTS = mean(profitTS)) %>%
      filter(!is.na(sumVariable)) %>%
      ggplot(aes(x = sumVariable, y = profitTS)) +
      geom_point() +
      ggtitle(paste0("Relationship between ",vVariable," & profitTS for ", vStrategy)) +
      xlab(vVariable) +
      ylab("profitTS") +
      geom_smooth(method = "lm")
    )
  }
}
```

```{r}
#df_cumProfitTS <- data.frame(profitTS = numeric(),
#                             RealProbTS = numeric(),
#                             n = numeric())
#groups <- seq(from = min(df_dailyTS$RealProbTS), to = max(df_dailyTS$RealProbTS), length.out = 20)
#
#for (group in groups) {
#  index <- which(df_dailyTS$RealProbTS <= group)
#  profitTS <- mean(df_dailyTS[index,"profitTS"])
#  n = length(index)
#  df_cumProfitTS <- rbind(df_cumProfitTS, data.frame(profitTS = profitTS,
#                                                     RealProbTS = group,
#                                                     n = n))
#}
#
#df_cumProfitTS %>%
#  ggplot(aes(x = RealProbTS, y = profitTS)) +
#  geom_point() +
#  ggtitle("Cumulative Relationship between RealParTS & profitTS") +
# geom_smooth(method = "lm")
```



# Decision-making section

## Grouping
```{r}
names(df_daily)
```

```{r}
vMeanProfit <- mean(df_daily$profit)
```

```{r}
vYears <- unique(df_dailyTS$year)
vYears <- vYears[1:7]
```

```{r}
names(df_dailyTS)
```

### variables

Finish work for variable numeric grouping
```{r}
vVariable <- "wday"
df_dailyTS$sumVariable <- df_dailyTS[,vVariable]

g_variables <- 
  df_dailyTS %>%
  filter(year %in% vYears) %>%
  
  group_by(strategy) %>%
  mutate(profitTS_Mean_Strategy = mean(profitTS),
         profitTS_SD_Strategy   = sd(profitTS),
         profitTS_n_Strategy    = n()) %>%
  
  group_by(strategy, year) %>%
  mutate(profitTS_Mean_StrategyYear = mean(profitTS),
         profitTS_SD_StrategyYear   = sd(profitTS),
         profitTS_n_StrategyYear    = n()) %>%
    
  group_by(strategy, sumVariable) %>%
  mutate(profitTS_Mean_StrategyVariable = mean(profitTS),
         profitTS_SD_StrategyVariable   = sd(profitTS),
         profitTS_n_StrategyVariable    = n()) %>%
  
  group_by(strategy, year, sumVariable) %>%
  mutate(profitTS_Mean_StrategyYearVariable = mean(profitTS),
         profitTS_SD_StrategyYearVariable   = sd(profitTS),
         profitTS_n_StrategyYearVariable    = n()) %>%
  
  summarise(profitTS_Mean_Strategy = profitTS_Mean_Strategy[1],
            profitTS_SD_Strategy = profitTS_SD_Strategy[1],
            profitTS_n_Strategy = profitTS_n_Strategy[1],
            
            profitTS_Mean_StrategyYear = profitTS_Mean_StrategyYear[1],
            profitTS_SD_StrategyYear = profitTS_SD_StrategyYear[1],
            profitTS_n_StrategyYear = profitTS_n_StrategyYear[1],
            
            profitTS_Mean_StrategyVariable = profitTS_Mean_StrategyVariable[1],
            profitTS_SD_StrategyVariable = profitTS_SD_StrategyVariable[1],
            profitTS_n_StrategyVariable = profitTS_n_StrategyVariable[1],
            
            profitTS_Mean_StrategyYearVariable = profitTS_Mean_StrategyYearVariable[1],
            profitTS_SD_StrategyYearVariable = profitTS_SD_StrategyYearVariable[1],
            profitTS_n_StrategyYearVariable = profitTS_n_StrategyYearVariable[1],
            
            variability_absolute_profitTS_Gr_vs_Strategy     = (profitTS_Mean_StrategyYearVariable  - profitTS_Mean_Strategy)^2,
            variability_absolute_profitTS_Gr_vs_StrategyYear = (profitTS_Mean_StrategyYearVariable  - profitTS_Mean_StrategyYear)^2,
            variability_absolute_profitTS_StrategyYear_vs_Strategy = (profitTS_Mean_StrategyYear  - profitTS_Mean_Strategy)^2,
            
            variability_relative_profitTS_Gr_vs_Strategy     = abs(profitTS_Mean_StrategyYearVariable/profitTS_Mean_Strategy),
            variability_relative_profitTS_Gr_vs_StrategyYear = abs(profitTS_Mean_StrategyYearVariable/profitTS_Mean_StrategyYear),
            variability_relative_profitTS_StrategyYear_vs_Strategy = abs(profitTS_Mean_StrategyYear/profitTS_Mean_Strategy)) %>%
    
    group_by(strategy, sumVariable) %>%
    summarise(
      variable = vVariable,
      profitTS_Mean = profitTS_Mean_StrategyVariable[1],
      profitTS_SD   = profitTS_SD_StrategyVariable[1],
      profitTS_n    = profitTS_n_StrategyVariable[1],
      
      variability_abs_total       = sum(variability_absolute_profitTS_Gr_vs_Strategy),
      variability_abs_insideYear  = sum(variability_absolute_profitTS_Gr_vs_StrategyYear),
      variability_abs_betweenYear = sum(variability_absolute_profitTS_StrategyYear_vs_Strategy),
      
      variability_rel_total       = mean(variability_relative_profitTS_Gr_vs_Strategy),
      variability_rel_insideYear  = mean(variability_relative_profitTS_Gr_vs_StrategyYear),
      variability_rel_betweenYear = mean(variability_relative_profitTS_StrategyYear_vs_Strategy)
      )
```

### wday
```{r}
g_wday_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,wday) %>%
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            ngr = 1)

g_wday_dailyTS <- g_wday_dailyTS %>%
  group_by(wday) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(wday,profitGrD,profitGrSD,profitTSSD,n,densityT,density))
  

g_wday_dailyTS

df_dailyTS %>%
  group_by(wday,year) %>%
  summarise(x_bar = mean(profitTS), wday = wday[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("wday")
```

### month
```{r}
g_month_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,month) %>%
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            ngr = 1)

g_month_dailyTS <- g_month_dailyTS %>%
  group_by(month) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(month,profitGrD,profitGrSD,profitTSSD,n,densityT,density))
  

g_month_dailyTS

df_dailyTS %>%
  group_by(month,year) %>%
  summarise(x_bar = mean(profitTS), month = month[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("month")
```

### SDPRF
```{r}
ngr <- 10
g_SDPRF_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,
           gSDPRF=cut(SDPRF, 
                  breaks = seq(from = min(df_dailyTS$SDPRF), 
                               to = max(df_dailyTS$SDPRF), 
                               length.out = ngr) )) %>%  
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            SDPRF = mean(SDPRF),
            ngr = 1)

g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  group_by(gSDPRF) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr),
            SDPRF = mean(SDPRF)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(gSDPRF,SDPRF,profitGrD,profitGrSD,profitTSSD,n,densityT,density))
  

g_SDPRF_dailyTS

df_dailyTS %>%
  group_by(year,
           SDPRF=cut(SDPRF, 
                  breaks = seq(from = min(df_dailyTS$SDPRF), 
                               to = max(df_dailyTS$SDPRF), 
                               length.out = ngr))) %>%
  summarise(x_bar = mean(profitTS), SDPRF = SDPRF[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("SDPRF")
```

### RealProbTS
```{r}
ngr <- 10
g_RealProbTS_dailyTS <- df_dailyTS %>%
  filter(year %in% vYears) %>%
  mutate(profitM = mean(profitTS)) %>%
  group_by(year) %>%
  mutate(profitMeanYear = mean(profitTS)) %>%
  group_by(year,
           gRealProbTS=cut(RealProbTS, 
                  breaks = seq(from = min(df_dailyTS$RealProbTS), 
                               to = max(df_dailyTS$RealProbTS), 
                               length.out = ngr) )) %>%  
  summarise(profitMGwy = mean(profitTS),
            profitTSSD = sd(profitTS),
            profitMGy = profitMeanYear[1],
            n = n(),
            SSG = (profitMGwy-profitMGy)^2,
            profitM = profitM[1],
            SSGR = abs(profitMGwy/profitMGy),
            profitRG = profitMGwy/profitM,
            RealProbTS = mean(RealProbTS),
            ngr = 1)

g_RealProbTS_dailyTS <- 
  g_RealProbTS_dailyTS %>%
  group_by(gRealProbTS) %>%
  summarise(SSG = sum(SSG), 
            SSGR = mean(SSGR),
            profitG = mean(profitMGwy)-profitM[1],
            profitGrSD = sd(profitMGwy),
            profitTSSD = sum(profitTSSD*n, na.rm = T)/sum(n,na.rm = T),
            profitGMean = mean(profitMGwy),
            profitRG = mean(profitRG),
            n = sum(n),
            ngr = sum(ngr),
            RealProbTS = mean(RealProbTS)) %>%
  mutate(densityGT = sum(SSG),
         densityGTR = sum(SSGR),
         densityG = (sum(SSG)/SSG)*(ngr/sum(ngr)),
         densityRG = (sum(SSGR)/SSGR)*(ngr/sum(ngr))) %>%
  mutate(densityG = densityG/sum(densityG),
         densityRG = densityRG/sum(densityRG),
         density = (densityG + densityRG)/2,
         densityT = (sum(SSG) + sum(SSGR))) %>%
  mutate(density = density/max(density),
         profitGrD = profitG * density) %>%
  select(c(gRealProbTS,RealProbTS,profitGrD,profitGrSD,profitTSSD,n,densityT,density))

g_RealProbTS_dailyTS

df_dailyTS %>%
  group_by(year,
           RealProbTS=cut(RealProbTS, 
                  breaks = seq(from = min(df_dailyTS$RealProbTS), 
                               to = max(df_dailyTS$RealProbTS), 
                               length.out = ngr))) %>%
  summarise(x_bar = mean(profitTS), RealProbTS = RealProbTS[1], year = year[1]) %>%
  ggplot(aes(y = x_bar, x = year, fill = year)) +
  geom_col(position = 'dodge') +
  facet_wrap("RealProbTS")
```
## Total Density
```{r}
densityTmin <- min(g_wday_dailyTS[1,"densityT"][[1]],
                  g_month_dailyTS[1,"densityT"][[1]],
                  g_RealProbTS_dailyTS[1,"densityT"][[1]],
                  g_SDPRF_dailyTS[1,"densityT"][[1]])

g_wday_dailyTS <- g_wday_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = wday)
g_month_dailyTS <- g_month_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = month)
g_RealProbTS_dailyTS <- g_RealProbTS_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = RealProbTS)
g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  mutate(profitGrDT = profitGrD*densityTmin/densityT,
         densityF = density*densityTmin/densityT,
         var = SDPRF)
```


```{r}
# prob
g_wday_dailyTS <- 
  g_wday_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
# prob
g_month_dailyTS <- 
  g_month_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
# prob
g_RealProbTS_dailyTS <- 
  g_RealProbTS_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
# prob
g_SDPRF_dailyTS <- 
  g_SDPRF_dailyTS %>%
  mutate(profitMean = vMeanProfit + profitGrDT,
         profitSE = profitTSSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4),
         tMean = vMeanProfit - profitMean/profitSE,
         probMean = round(pt(tMean, (n-1)),4))
```


## Choosing reliable groups

```{r}
#g_wday_dailyTS
g_wday_dailyTS <- g_wday_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_wday_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_wday_dailyTS <- g_wday_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

# g_month_dailyTS
g_month_dailyTS <- g_month_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_month_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_month_dailyTS <- g_month_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

# g_RealProbTS_dailyTS
g_RealProbTS_dailyTS <- g_RealProbTS_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_RealProbTS_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_RealProbTS_dailyTS <- g_RealProbTS_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

# g_SDPRF_dailyTS
g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  mutate(profitGrDTR = case_when(densityF > 0.5 ~ profitGrDT, T ~ 0))

vProfitGrDTR <- g_SDPRF_dailyTS %>%
  filter(profitGrDTR == 0) %>%
  summarise(profitGrDTR = sum(profitGrDT*n)/sum(n))
vProfitGrDTR <- vProfitGrDTR[1,"profitGrDTR"][[1]]

g_SDPRF_dailyTS <- g_SDPRF_dailyTS %>%
  mutate(profitGrDTR = case_when(profitGrDTR == 0 ~ vProfitGrDTR, T ~ profitGrDTR))

```


## Full table
```{r}
get_group_profit <- function(value, group_table) {
  if (is.factor(value) == T) {
    index <- which(group_table$var == value)
  } else {
    index <- which.min(abs(group_table$var-value))
  }
  group_table[index,c("profitGrDT","profitGrSD","var","n","prob0","probMean")]
}

for (index in 1:nrow(df_dailyTS)) {
  # wday
  df_group_profit <- get_group_profit(value = df_dailyTS[index,"wday"], 
                                      group_table = g_wday_dailyTS)
  df_dailyTS[index,"pr_wday"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_wday"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_wday"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_wday"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_wday"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_wday"] <- df_group_profit[1,"probMean"][[1]]
  
  # month
  df_group_profit <- get_group_profit(df_dailyTS[index,"month"], 
                                      group_table = g_month_dailyTS)
  df_dailyTS[index,"pr_month"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_month"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_month"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_month"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_month"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_month"] <- df_group_profit[1,"probMean"][[1]]
  
  # SDPRF
  df_group_profit <- get_group_profit(df_dailyTS[index,"SDPRF"], 
                                      group_table = g_SDPRF_dailyTS)
  df_dailyTS[index,"pr_SDPRF"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_SDPRF"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_SDPRF"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_SDPRF"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_SDPRF"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_SDPRF"] <- df_group_profit[1,"probMean"][[1]]
  
  # RealProbTS
  df_group_profit <- get_group_profit(df_dailyTS[index,"RealProbTS"], 
                                      group_table = g_RealProbTS_dailyTS)
  df_dailyTS[index,"pr_RealProbTS"]  <- df_group_profit[1,"profitGrDT"][[1]]
  df_dailyTS[index,"sd_RealProbTS"]  <- df_group_profit[1,"profitGrSD"][[1]]
  df_dailyTS[index,"var_RealProbTS"] <- df_group_profit[1,"var"][[1]]
  df_dailyTS[index,"n_RealProbTS"] <- df_group_profit[1,"n"][[1]]
  df_dailyTS[index,"prob0_RealProbTS"] <- df_group_profit[1,"prob0"][[1]]
  df_dailyTS[index,"probMean_RealProbTS"] <- df_group_profit[1,"probMean"][[1]]
}

```

## Checking result
```{r, warning=F, message=F}
df_dailyTS <- df_dailyTS %>%
  mutate(prob0 = (prob0_wday + prob0_month + prob0_SDPRF+prob0_RealProbTS)/4)

prob0Level <- 0.20
df_profitM <- df_dailyTS %>%
  filter(prob0 < prob0Level) %>%
  group_by(year) %>%
  summarise(profitM = mean(profit), nM = n())

df_profitT <- df_dailyTS %>%
  group_by(year) %>%
  summarise(profitT = mean(profit), nT = n())

df_profit <- merge(df_profitM,df_profitT,by = "year", all = TRUE)

df_profit <- df_profit %>%
  mutate(freq = round(nM/nT,2),
         dif = profitM/profitT) 

summary(df_profit)
```

```{r}
df_profit
```


```{r}
df_dailyTS <- df_dailyTS %>%
  mutate(prob0 = (prob0_wday + prob0_month + prob0_SDPRF + probMean_SDPRF)/4)

df_dailyTS[,] %>%
  group_by(gprob0=cut(prob0, 
                      breaks = seq(from = min(df_dailyTS$prob0,na.rm = T), 
                                        to = max(df_dailyTS$prob0,na.rm = T), 
                                        length.out = 20) )) %>%
  summarise(prob0 = mean(prob0), profit = mean(profit)) %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profit))

df_dailyTS[,] %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profitTS))
```
