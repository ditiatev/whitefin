---
title: "moex"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
options(digits = 4)
```

```{r, message=FALSE}
library(statsr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)
```

# Data set
```{r}
#df_daily <- read.csv("./data/dailystrategydata.csv", encoding = "UTF-8")
df_daily <- read.csv("./data/betweendailystrategydata.csv", encoding = "UTF-8")

df_daily <- df_daily[,c(2,8,15,32)]
names(df_daily) <- c("position","date","timeclose","profit")
str(df_daily)
```

```{r}
df_daily <- df_daily %>%
  mutate(date = as.Date(date, format = '%d.%m.%Y')) %>%
  mutate(date = as.POSIXct(date, format = '%d.%m.%Y')) %>%
  mutate(profit = gsub("%", "", profit)) %>%
  mutate(profit = gsub(",", ".", profit)) %>%
  mutate(profit = as.numeric(profit)) %>%
  mutate(year = as.factor(year(date))) %>%
  mutate(month = as.factor(month(date))) %>%
  mutate(wday = as.factor(wday(date, week_start = 1))) %>%
  mutate(timeclose = hms(df_daily$timeclose)) %>%
  #mutate(tradestop = case_when(profit == 22 ~ F, T ~ T)) # for indays trade
  mutate(tradestop = case_when(profit < -1 ~ T, T ~ F)) # for betweendays trade

df_daily <- na.omit(df_daily)
```


```{r}
summary(df_daily)
```


# PROFIT

## All period

```{r}
ggplot(data = df_daily, aes(x = profit, fill= yday(date))) +
  geom_density(aes(x=profit), color="green4", fill="lightgreen", alpha=.3) +
  ggtitle("Profit distribution by all data")
```

## Years

```{r}
df_daily %>%
        group_by(year) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```

```{r}
df_daily %>%
  group_by(year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), year = year[1]) %>%
  ggplot() +
  geom_col(aes(y = x_bar, x = year, fill = year), position = 'dodge')
```

sd - profit

```{r}
df_daily %>%
  group_by(year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit")
```

## Months

```{r}
df_daily %>%
        group_by(month) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(month) %>%
  summarise(x_bar = mean(profit), month = month[1]) %>%
  ggplot(aes(y = x_bar, x = month, fill = month)) +
  geom_col(position = 'dodge')
```

sd - profit

```{r}
df_daily %>%
  group_by(month) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit")
```

## Days

```{r}
df_daily %>%
        group_by(wday) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(wday) %>%
  summarise(x_bar = mean(profit), wday = wday[1]) %>%
  filter(wday %in% c(1,2,3,4,5)) %>%
  ggplot(aes(y = x_bar, x = wday, fill = wday)) +
  geom_col(position = 'dodge')
```

sd - profit

```{r}
df_daily %>%
  group_by(wday) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
  ggplot(aes(y = x_bar, x = x_sd)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Relationship sd & mean profit")
```

## Position

```{r}
df_daily %>%
        group_by(position) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(position) %>%
  summarise(x_bar = mean(profit), position = position[1]) %>%
  ggplot(aes(y = x_bar, x = position, fill = position)) +
  geom_col(position = 'dodge')
```


## Trade stop

```{r}
df_daily %>%
        group_by(tradestop) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())

df_daily %>%
  group_by(tradestop) %>%
  summarise(x_bar = mean(profit), tradestop = tradestop[1]) %>%
  ggplot(aes(y = x_bar, x = tradestop, fill = tradestop)) +
  geom_col(position = 'dodge')
```

# TRADE STOP

## Trend
```{r}
df_daily %>%
  group_by(year,month) %>%
  mutate(n = n()) %>%
  filter(tradestop == TRUE) %>%
  summarise(n_stop = n(), n = n[1], freq = n_stop/n, date = ymd(paste(year, month, "01", sep= ' '))) %>%
  
  ggplot(aes(x = date, y = freq)) +
  geom_line(color="darkred") +
  ggtitle("Trade stop probability calculated by calendar month")
```

## Ditribution
### All period

```{r}
df_year <- df_daily

shape1 <- nrow(df_year[which(df_year$tradestop == T),])
shape2 <- nrow(df_year[which(df_year$tradestop == F),])
sim <- data.frame(prob = rbeta(2626,shape1,shape2))
summary(sim)

ggplot(data = sim) +
  geom_density(aes(x=prob), color="darkred", fill="#FF6666", alpha=.3) +
  ggtitle("TS Ditribution - All period")
```

### Crisis years 

For 2008-2009 and 2014-2015

```{r}
df_year <- df_daily %>%
  filter(year %in% c(2008,2009,2014,2015))

shape1 <- nrow(df_year[which(df_year$tradestop == T),])
shape2 <- nrow(df_year[which(df_year$tradestop == F),])
sim <- data.frame(prob = rbeta(100000,shape1,shape2))
summary(sim)

ggplot(data = sim) +
  geom_density(aes(x=prob), color="darkred", fill="#FF6666", alpha=.3)  +
  ggtitle("TS Ditribution - Crisis years")
```

### Calm years

For 2010-2013, 2016-2018.

```{r}
df_year <- df_daily %>%
  filter(year %in% c(2010,2011,2012,2013,2016,2017,2018))

shape1 <- nrow(df_year[which(df_year$tradestop == T),])
shape2 <- nrow(df_year[which(df_year$tradestop == F),])
sim <- data.frame(prob = rbeta(100000,shape1,shape2))
summary(sim)

ggplot(data = sim) +
  geom_density(aes(x=prob), color="darkred", fill="#FF6666", alpha=.3)  +
  ggtitle("TS Ditribution - Calm years")

rm(sim); rm(df_year)
```

# TS
## ProbTS by MA

Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.

```{r}
sliding_depth <- 90
df_daily$tradestop <- as.integer(df_daily$tradestop)

for (n in 1:sliding_depth) {
  df_daily[,paste0("TSprevious",n)] <- c(rep(NA,n), head(df_daily$tradestop,-n))
}

for (n in 2:sliding_depth) {
  df_daily[,paste0("TSMAprevious",n)] <- apply(df_daily[,paste0("TSprevious",1:n)],1,sum,na.rm = F)
}
```

Содадим функцию способную посчитать средние веростноти трейдстопа на основе бетта распределений по скользящим средним количеству трейдстопов на текущий день
т.е. например заглядываем на 10 дней вперед смотрим количество трейдстопов и на этих данных моделируем распределение, затем по этому рапределению считаем среднее значение и его и записываем

```{r}
get_prob <- function(df,col_names) {
  mean_rbeta <- function(x, col_name) {
  # calculating sliding depth
  n <- as.integer(sub("BPMAprevious|TSMAprevious","",col_name))
  # return mean of rbeta distribution
  mean(rbeta(1000, shape1 = as.integer(x[col_name]), shape2 = n-as.integer(x[col_name])))
  }
  
  for (col_name in col_names) {
    df[,paste0("prob_",col_name)] <- apply(df_daily, 1, FUN = function(x) mean_rbeta(x,col_name))  
  }
  
  df
}
```

Посчитаем средние вероятности трейдстопа по скользящим средним. Применим созданную функцию.
```{r, message=F,warning=F}
df_daily <- get_prob(df = df_daily, col_names = paste0("TSMAprevious",2:sliding_depth))
```

Посчитаем среднюю вероятность трейдстопа по всем скользящим.
```{r}
df_daily$probTS <- apply(df_daily[,paste0("prob_TSMAprevious",2:sliding_depth)],1,mean,na.rm = F)
```

Delete unused columns
```{r}
drops <- c(paste0("TSprevious",1:sliding_depth),
           paste0("TSMAprevious",2:sliding_depth),
           paste0("prob_TSMAprevious",2:sliding_depth))

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
names(df_daily)
```

```{r}
index_ts <- which(df_daily$tradestop == T)
ggplot() +
  geom_density(data = df_daily[-index_ts,], aes(x=probTS), color = "darkgreen", fill="green", alpha=.3) +
  geom_density(data = df_daily[index_ts,], aes(x=probTS), color = "darkred", fill="red", alpha=.3)
```

```{r}
df_daily %>%
  filter(!is.na(probTS)) %>%
  ggplot() +
  geom_boxplot(aes(y = probTS, x = as.factor(tradestop), color = as.factor(tradestop)))
```

## Table probTS - realTS

Calculating real cumulative trade stop probability for `probTS` scale. 

```{r}
df_tsprob <- data.frame(mean_probTS = numeric(),
                        mean_profit = numeric(),
                        mean_realTS = numeric())


for (prob in 1:100) {
  
prob_index <- which(df_daily$probTS >= prob/100)

  if (length(prob_index >= 10)) {
    df_daily_nona <- na.omit(df_daily[prob_index,])
    nRow <- nrow(df_daily_nona)
    
    for (n in 1:50) {
      index <- sample(1:nRow,nRow,replace = T)
      df_tsprob <- rbind(df_tsprob,
                         data.frame(mean_probTS = mean(df_daily_nona[index,"probTS"]),
                                    mean_profit = mean(df_daily_nona[index,"profit"]),
                                    mean_realTS = mean(df_daily_nona[index,"tradestop"])))
    }
  }
}


for (prob in 1:100) {
  
prob_index <- which(df_daily$probTS <= prob/100)

  if (length(prob_index >= 10)) {
    df_daily_nona <- na.omit(df_daily[prob_index,])
    nRow <- nrow(df_daily_nona)
    
    for (n in 1:50) {
      index <- sample(1:nRow,nRow,replace = T)
      df_tsprob <- rbind(df_tsprob,
                         data.frame(mean_probTS = mean(df_daily_nona[index,"probTS"]),
                                    mean_profit = mean(df_daily_nona[index,"profit"]),
                                    mean_realTS = mean(df_daily_nona[index,"tradestop"])))
    }
  }
}

# transform data to predicted and ci values
df_tsprob <- df_tsprob %>% 
  group_by(gr=cut(mean_probTS, breaks = seq(from = 0, to = max(df_tsprob$mean_probTS), length.out = 100) )) %>%
  summarise(n = n(), 
            mean_probTS = mean(mean_probTS),
            pred_realTS = mean(mean_realTS),
            low_realTS = qnorm(c(0.025), mean = mean(mean_realTS), sd = sd(mean_realTS)),
            hight_realTS = qnorm(c(0.975), mean = mean(mean_realTS), sd = sd(mean_realTS))) %>%
  filter(!is.na(pred_realTS))

df_tsprob <- df_tsprob %>%
  mutate(low_realTS = case_when(low_realTS < 0 ~ 0,
                                low_realTS > 1 ~ 1,
                                TRUE ~ low_realTS),
         hight_realTS = case_when(hight_realTS < 0 ~ 0,
                                hight_realTS > 1 ~ 1,
                                TRUE ~ hight_realTS))
```

```{r}
ggplot(data = df_tsprob) +
  geom_point(aes(x = mean_probTS, y = pred_realTS)) +
  geom_point(aes(x = mean_probTS, y = low_realTS)) +
  geom_point(aes(x = mean_probTS, y = hight_realTS)) +
  ggtitle("Relationship between MAProbTS & RealProbTS with CI") +
  ylab("RealProbTS") +
  xlab("MAProbTS")
```

## RealProbTS 

Correspond MAProbTS & RealProbTS in historical data.

```{r}
get_realCI95probTSbyMAprob <- function(prob, df_tsprob) {
  index <- which.min(abs(df_tsprob$mean_probTS-prob))
  df_tsprob[index,c("pred_realTS","low_realTS","hight_realTS")]
}

for (index in 1:nrow(df_daily)) {
  realTS95CI <- get_realCI95probTSbyMAprob(df_daily[index,"probTS"], df_tsprob = df_tsprob)
  df_daily[index,"RealProbTS"] <- realTS95CI[1,"pred_realTS"][[1]]
  df_daily[index,"RealProbTS_low"] <- realTS95CI[1,"low_realTS"][[1]]
  df_daily[index,"RealProbTS_hight"] <- realTS95CI[1,"hight_realTS"][[1]]
}
```

```{r}
ggplot(data = df_daily) +
  geom_point(aes(x = date, y = RealProbTS)) +
  ggtitle("Trade stop probability timeline")
```

# SD

Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.

```{r}
sliding_depth <- 90

for (n in 1:sliding_depth) {
  df_daily[,paste0("PRFpr",n)] <- c(rep(NA,n), head(df_daily$profit,-n))
}

for (n in 2:sliding_depth) {
  df_daily[,paste0("PRFMAprSD",n)] <- apply(df_daily[,paste0("PRFpr",1:n)],1,sd,na.rm = F)
}
```

```{r, message=F,warning=F}
df_daily$meanSD <- apply(df_daily[,paste0("PRFMAprSD",2:sliding_depth)],1,mean,na.rm = F)
df_daily$SDSD   <- apply(df_daily[,paste0("PRFMAprSD",2:sliding_depth)],1,sd,na.rm = F)
```

```{r}
df_daily$SDPRF       <- qnorm(c(0.5)  , mean = df_daily$meanSD, sd = df_daily$SDSD)
df_daily$SDPRF_low   <- qnorm(c(0.025), mean = df_daily$meanSD, sd = df_daily$SDSD)
df_daily$SDPRF_hight <- qnorm(c(0.975), mean = df_daily$meanSD, sd = df_daily$SDSD)
```


Delete unused columns
```{r}
drops <- c(paste0("PRFpr",1:sliding_depth),
           paste0("PRFMAprSD",2:sliding_depth),
           "meanSD", "SDSD")

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
```

# PROFIT
## ProfitTS distribution

```{r}
df_daily_nona <- na.omit(df_daily)

indexTS <- which(df_daily_nona$tradestop == 1)
TSprofit <- mean(df_daily_nona[indexTS,"profit"])

df_dailyTS <- df_daily_nona %>%
  mutate(profitTS = case_when(tradestop == 1 ~ TSprofit*RealProbTS,
                              TRUE ~ profit+TSprofit*RealProbTS))
  
ggplot(data = df_dailyTS) +
  geom_density(aes(x = profitTS), color="darkred", fill="#FF6666", alpha=.3) +
  ggtitle("Expected profit distribution (profitTS)")
```

## RealProbTS-ProfitTS

```{r}
df_dailyTS %>% 
  group_by(gr=cut(probTS, breaks = seq(from = min(df_dailyTS$RealProbTS), to = max(df_dailyTS$RealProbTS), length.out = 50) )) %>%
  summarise(n = n(), 
            RealProbTS = mean(RealProbTS),
            profitTS = mean(profitTS)) %>%
  ggplot(aes(x = RealProbTS, y = profitTS)) +
  geom_point() +
  ggtitle("Relationship between RealParTS & profitTS") +
  geom_smooth(method = "lm")
```

```{r}
df_cumProfitTS <- data.frame(profitTS = numeric(),
                             RealProbTS = numeric(),
                             n = numeric())
groups <- seq(from = min(df_dailyTS$RealProbTS), to = max(df_dailyTS$RealProbTS), length.out = 50)

for (group in groups) {
  index <- which(df_dailyTS$RealProbTS <= group)
  profitTS <- mean(df_dailyTS[index,"profitTS"])
  n = length(index)
  df_cumProfitTS <- rbind(df_cumProfitTS, data.frame(profitTS = profitTS,
                                                     RealProbTS = group,
                                                     n = n))
}

df_cumProfitTS %>%
  ggplot(aes(x = RealProbTS, y = profitTS)) +
  geom_point() +
  ggtitle("Cumulative Relationship between RealParTS & profitTS") +
  geom_smooth(method = "lm")
```

## SDPRF-ProfitTS

```{r}
df_dailyTS %>% 
  group_by(gr=cut(SDPRF, breaks = seq(from = min(df_dailyTS$SDPRF), to = max(df_dailyTS$SDPRF), length.out = 50) )) %>%
  summarise(n = n(), 
            SDPRF = mean(SDPRF),
            profitTS = mean(profitTS)) %>%
  ggplot(aes(x = SDPRF, y = profitTS)) +
  geom_point() +
  ggtitle("Relationship between SDPRF & profitTS") +
  geom_smooth(method = "lm")
```

```{r}
df_cumProfitTS <- data.frame(profitTS = numeric(),
                             SDPRF = numeric(),
                             n = numeric())
groups <- seq(from = min(df_dailyTS$SDPRF), to = max(df_dailyTS$SDPRF), length.out = 25)

for (group in groups) {
  index <- which(df_dailyTS$SDPRF <= group)
  profitTS <- mean(df_dailyTS[index,"profitTS"])
  n = length(index)
  df_cumProfitTS <- rbind(df_cumProfitTS, data.frame(profitTS = profitTS,
                                                     SDPRF = group,
                                                     n = n))
}

df_cumProfitTS %>%
  filter(n > 10) %>%
  ggplot(aes(x = SDPRF, y = profitTS)) +
  geom_point() +
  ggtitle("Cumulative Relationship between RealParTS & profitTS") +
  geom_smooth(method = "lm")
```

# Decision-making section

```{r}
index_SD    <- which(df_dailyTS$SDPRF > 1 & df_dailyTS$SDPRF < 1.6)
index_TS    <- which(df_dailyTS$RealProbTS > 0.3)
index_day   <- which(df_dailyTS$wday  == 1)
index_month <- which(df_dailyTS$month == 12)
index_total <- unique(c(index_SD,index_TS,index_day,index_month))

mean(df_dailyTS[index_SD,"profitTS"])
mean(df_dailyTS[index_TS,"profitTS"])
mean(df_dailyTS[index_day,"profitTS"])
mean(df_dailyTS[index_month,"profitTS"])
mean(df_dailyTS[index_total,"profitTS"])

mean(df_dailyTS[,"profitTS"])
mean(df_dailyTS[-total_index,"profitTS"])
```


```{r,message=F,warning=F}
df_year <- df_dailyTS %>%
  filter(year == 2009)

index_SD    <- which(df_year$SDPRF > 1 & df_year$SDPRF < 1.6)
index_TS    <- which(df_year$RealProbTS > 0.3)
index_day   <- which(df_year$wday  == 1)
index_month <- which(df_year$month == 12)
index_total <- unique(c(index_SD,index_TS,index_day,index_month))

print(paste0("index_SD    : ",round(mean(df_year[index_SD,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[index_SD,])/nrow(df_year[,]),1)))
print(paste0("index_TS    : ",round(mean(df_year[index_TS,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[index_TS,])/nrow(df_year[,]),1)))
print(paste0("index_day   : ",round(mean(df_year[index_day,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[index_day,])/nrow(df_year[,]),1)))
print(paste0("index_month : ",round(mean(df_year[index_month,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[index_month,])/nrow(df_year[,]),1)))
print(paste0("index_total : ",round(mean(df_year[index_total,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[index_total,])/nrow(df_year[,]),1)))

print(paste0("All         : ",round(mean(df_year[,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[,])/nrow(df_year[,]),1)))
print(paste0("Witout index: ",round(mean(df_year[-index_total,"profit"],na.rm = T),3), ", %: ",round(nrow(df_year[-index_total,])/nrow(df_year[,]),1)))
```

```{r}
df_dailyTS$index_SD    <- F
df_dailyTS$index_TS    <- F
df_dailyTS$index_day   <- F
df_dailyTS$index_month <- F

df_dailyTS[index_SD,   "index_SD"]    <- T
df_dailyTS[index_TS,   "index_TS"]    <- T
df_dailyTS[index_day,  "index_day"]   <- T
df_dailyTS[index_month,"index_month"] <- T

colomns <- c("profitTS","index_SD","index_TS","index_day","index_month")
```



#BadProfit

```{r}
df_daily <- df_daily %>%
  mutate(badProfit = case_when(profit < 0.1 ~ 0, T ~ 1))
```

```{r}
sliding_depth <- 90

for (n in 1:sliding_depth) {
  df_daily[,paste0("BPprevious",n)] <- c(rep(NA,n), head(df_daily$badProfit,-n))
}

for (n in 2:sliding_depth) {
  df_daily[,paste0("BPMAprevious",n)] <- apply(df_daily[,paste0("BPprevious",1:n)],1,sum,na.rm = F)
}
```

```{r, message=F,warning=F}
df_daily <- get_prob(df = df_daily, col_names = paste0("BPMAprevious",2:sliding_depth))
```

Посчитаем среднюю вероятность bad profit по всем скользящим.
```{r}
df_daily$probBP <- apply(df_daily[,paste0("prob_BPMAprevious",2:sliding_depth)],1,mean,na.rm = F)

drops <- c(paste0("BPprevious",1:sliding_depth),
           paste0("BPMAprevious",2:sliding_depth),
           paste0("prob_BPMAprevious",2:sliding_depth))

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
names(df_daily)
```

```{r}
ggplot(data = df_daily) +
  geom_point(aes(x = date, y = probBP))
```



```{r}
df_cumBP <- data.frame(profit = numeric(),
                       BPprob = numeric())
groups <- seq(from = min(df_daily$probBP, na.rm = T), to = max(df_daily$probBP, na.rm = T), length.out = 20)

for (group in groups) {
  index <- which(df_daily$probBP <= group)
  profit <- mean(df_daily[index,"profit"])
  df_cumBP <- rbind(df_cumBP, data.frame(profit = profit,
                                         BPprob = group))
}

df_cumBP %>%
  ggplot() +
  geom_point(aes(x = BPprob, y = profit)) +
  ylim(-0.5,1)
```

```{r}
ggplot(data = df_daily) +
  geom_point(aes(x = probBP, y = profit))


df_daily %>% 
  filter(!is.nan(probBP)) %>%
  group_by(gr=cut(probBP, breaks = seq(from = min(df_daily$probBP, na.rm = T), to = max(df_daily$probBP, na.rm = T), length.out = 10) )) %>%
  summarise(n = n(), 
            pred_realTS = mean(probBP),
            profitTS = mean(profit)) %>%
  ggplot() +
  geom_point(aes(x = pred_realTS, y = profitTS)) +
  ggtitle("Relationship between mean profit and real TS probability")

```


# TS MODEL

colomns <- c("profitTS","index_SD","index_TS","index_day","index_month")
```{r}
names(df_dailyTS)
```

```{r}
probTS_baslm <- bas.lm(profitTS ~ ., 
                       data = df_dailyTS[,colomns],
                       prior = "BIC", 
                       modelprior = uniform(),
                       method = "MCMC", MCMC.iterations = 10 ^ 6)
summary(probTS_baslm)
```

```{r}
# makе prediction
BMA_pred_probTS <- predict(probTS_baslm, estimator = "BMA", se.fit = TRUE, nsim = 1000)

# get credible intervals
ci_coef_probTS <- confint(BMA_pred_probTS, parm = "coef")
ci_pred_probTS <- confint(BMA_pred_probTS, parm = "pred")

# unite result in the data frame
df_pred_probTS <- data.frame((ci_coef_probTS[,1:3]), (ci_pred_probTS[,1:2]))


colnames(df_pred_probTS) = c("low_mu","hight_mu","pred",
                              "low","hight")

df_pred_probTS <- cbind(df_dailyTS,df_pred_probTS)
```

```{r}
# Obtain the coefficients from the model
coef_bma_probTS <- coefficients(probTS_baslm)
coef_bma_probTS_ci <- confint(coef_bma_probTS)

# converted measurement of predicting variable back
coef <- cbind(round(coef_bma_probTS_ci, 6), 
              `P(B != 0 | Y)` = round(coef_bma_probTS$probne0, 3))
coef
```

```{r}
plot(probTS_baslm, which = 1, add.smooth = F, 
     ask = F, pch = 16, sub.caption="", caption="")
abline(a = 0, b = 0, col = "darkgrey", lwd = 2)
```

```{r}
ggplot(data = df_pred_probTS) +
  #geom_point(aes(x = profitTS, y = profitTS), color = "blue", size = 0.6) +
  
  geom_line(aes(x = profitTS, y = low_mu, lty = "second")) +
  geom_line(aes(x = profitTS, y = hight_mu, lty = "second")) +
  
  geom_line(aes(x = profitTS, y = low, lty = "third")) +
  geom_line(aes(x = profitTS, y = hight, lty = "third")) +
  geom_line(aes(x = profitTS, y = pred, color = "orange")) +
  
  #scale_colour_manual(values = c("orange"), labels = "Posterior mean", name = "") +
  #scale_linetype_manual(values = c(2, 3), labels = c("95% CI for mean", "95% CI for predictions")
  #                      , name = "") +
 # theme_bw() +
  #theme(legend.position = c(1, 0), legend.justification = c(1.5, 0)) +
  
  #geom_point(data = df_outliers, aes(x = pred, y = audience_score), color = "orange", pch = 1, cex = 6) +
  ggtitle("Uncertainty in the cumulative prediction of the probability of a trade stop")
```




























So, now we have a very powerful tool for real trade stop prediction. Let's transform cumulative data to point estimates.

```{r}
n_row <- nrow(df_pred_probTS)
df_pred_probTS[2:n_row,"pred_prob_between"] <- (df_pred_probTS[2:n_row,"pred"]*df_pred_probTS[2:n_row,"n_cases"]-
                                             df_pred_probTS[1:(n_row-1),"pred"]*df_pred_probTS[1:(n_row-1),"n_cases"])/(
                                               df_pred_probTS[2:n_row,"n_cases"] - df_pred_probTS[1:(n_row-1),"n_cases"])
df_pred_probTS[1,"pred_prob_between"] <- df_pred_probTS[1,"pred"]

ggplot(data = df_pred_probTS) +
  geom_point(aes(x = corprobTS/100, y = pred_prob_between)) +
  geom_abline(slope=1, intercept=0) +
  ggtitle("Relationship between Tr.Model & Cor.TS probability") +
  xlab("Correlational probability for trade stop") +
  ylab("Transform model probability")

ggplot(data = df_pred_probTS) +
  geom_point(aes(x = pred, y = pred_prob_between)) +
  geom_abline(slope=1, intercept=0) +
  ggtitle("Relationship between cumulative & transform model TS probability") +
  ylab("Transform model probability")
```

Small data sets that correspond to high TS probability, increase the uncertainty of prediction in that area. Let's plot it.

```{r}
df_pred_probTS$prob_between <- qgamma(c(0.5),shape = df_pred_probTS$n_TScases_between, rate = df_pred_probTS$n_cases_between)
df_pred_probTS$prob_between_low <- qgamma(c(0.025),shape = df_pred_probTS$n_TScases_between, rate = df_pred_probTS$n_cases_between)
df_pred_probTS$prob_between_hight <- qgamma(c(0.975),shape = df_pred_probTS$n_TScases_between, rate = df_pred_probTS$n_cases_between)

ggplot(data = df_pred_probTS) +
  geom_point(aes(x = pred_prob_between, y = prob_between)) +
  geom_line(aes(x = pred_prob_between, y = prob_between_low), color = "darkred") +
  geom_line(aes(x = pred_prob_between, y = prob_between_hight), color = "darkgreen") +
  geom_abline(slope=1, intercept=0) +
  xlab("Transform model probability") +
  ylab("Real probability with credible intervals") +
  ggtitle("Correspond of the model and real TS probability with an area of uncertainties.")
```

We got tools to predict TS probability which can be used to transform profit rate. 
Also, we find the relationship between mean profit rate and TS probability, it very difficult to find a relationship between profit rate and TS, because of a huge deviation in the profit rate.

Let's print relationship between mean profit rate and TS probability.

```{r}
names(df_pred_probTS)
```


```{r}
df_pred_probTS$meanprof_low <- qnorm(c(0.025), mean = df_pred_probTS$meanprof, sd = df_pred_probTS$sdprof)
df_pred_probTS$meanprof_hight <- qnorm(c(0.975), mean = df_pred_probTS$meanprof, sd = df_pred_probTS$sdprof)

ggplot(data = df_pred_probTS) +
  geom_point(aes(x = pred_prob_between, y = mean_prof_between)) +
  #geom_line(aes(x = pred, y = meanprof_low), color = "darkred") +
  #geom_line(aes(x = pred, y = meanprof_hight), color = "darkgreen") +
  ggtitle("Cumulative profit rate by tradestop probability")
```






## Decision example by using tradestop probability

### Annual rate of return
```{r}
index <- 19:38
prof_model <- sum(df_profit_ts[index,"profit_between"])/sum(df_profit_ts[index,"n_cases_between"])
prof <- sum(df_profit_ts[,"profit_between"],na.rm = T)/sum(df_profit_ts[,"n_cases_between"],na.rm = T)
days <- nrow(df_daily)/11
imparate <- round(((1+prof_model/100)^days-1),4)
bmparate <- round(((1+prof/100)^days-1),4)
print(paste0("Improved Model profit annual rate: ", imparate))
print(paste0("Base Model profit annual rate:     ", bmparate))
```

### TIMELINE TRADE DECISION
```{r}
probMin <- 19
probMax <- 38
index_notrade <- which(df_daily$corprobTS < probMin/100 | df_daily$corprobTS > probMax/100)
index_yestrade <- which(df_daily$corprobTS >= probMin/100 & df_daily$corprobTS <= probMax/100)

ggplot() +
  geom_jitter(data = df_daily[index_notrade,], aes(x = date, y = profit), size = 1, shape=4, color = "darkred") +
  geom_jitter(data = df_daily[index_yestrade,], aes(x = date, y = profit), size = 1, shape=3, color = "darkgreen") +
  ggtitle("TIMELINE TRADE DECISION (example)")
```

### PROFIT DENSITY
```{r}
ggplot() +
  geom_density(data = df_daily[index_notrade,], aes(x = profit), color = "darkred", fill="#FF6666", alpha=.3) +
  geom_density(data = df_daily[index_yestrade,], aes(x = profit), color = "darkgreen", fill="lightgreen", alpha=.3) +
  geom_density(data = df_daily, aes(x = profit)) +
  ggtitle("PROFIT DENSITY: Green - Trade, Red - Not Trade, Black - Base  (example)")
```

