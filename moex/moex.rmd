---
title: "moex"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
# Setup
```{r setup, include=FALSE}
options(digits = 4)
options(scipen = 999)

library(statsr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)
library(FNN)
library(BayesFactor)

source("./scripts/saveGGplot.r")
source("./scripts/opendir.r")
source("./scripts/makePrColForStrategy.r")

source("./scripts/get_workset.R")
source("./scripts/bayes/bayes_inference.R")
source("./scripts/bayes/bayes_util.R")
source("./scripts/bayes/bayes_single_mean_JZS.R")
source("./scripts/bayes/bayes_two_mean.R")

# KNN
source("./scripts/normalizeXtrainXtest.R")
source("./scripts/create_X_y.R")
source("./scripts/paste_summary.R")
source("./scripts/create_vector_dates.R")
source("./scripts/get_sample_date_index.R")
```

# Data

```{r}
#vStrategies <- c("RTS_10_14")
vStrategies <- c("SI_10_14")
df_daily_ <- get_WorkSet(vStrategies)

df_strategy <- read.csv("./data/strategy/strategy.csv",
                        colClasses = c("factor","POSIXct","numeric","integer", "factor",
                                       rep("numeric",6),rep("factor",3)))

vStrategiesAll <- unique(df_strategy$strategy)
```

# Normalize df
now we do it in `create_X_y`
```{r}
# source("./scripts/normalize_df.r")
# vColNames <- colnames(df_daily)[c(6:11, 16:60)]
# df_daily <- normalize_df(df = df_daily, vColNames = vColNames)
# head(df_daily)
```

# Profit
## Forvard
```{r}
source("./scripts/get_NormalDistForvard.r")
df_profitForvard <- get_NormalDistForvard(df_daily = df_daily, vColName = 'profit', sliding_depth = 25)
```

```{r, warning=FALSE, message=FALSE}
source("./scripts/get_NormalDist.r")
df_profitPr <- get_NormalDist(df_daily = df_daily,
                              vColName = vColNames,
                              sliding_depth = 50,
                              slidind_return = c(10,25,50))

df_profitPr$profit <- df_profitForvard$profit_mean_Next_25
df_profitPr$date <- ymd(df_daily$date)
```



# KNNSearch

Note:
- normalization happend in create_X_y

# KNNSearch new df_vars 

```{r, warning=FALSE, message=FALSE}
vVariables <- unique(vVariables)
len <- length(vVariables)

df_vars <- data.frame('var1' = 'var1',
                      'var2' = 'var2',
                      'k' = 0,
                      'date' = 0,
                      'p_up_0_train' = 0,
                      'p_up_0_test' = 0,
                      'p_mean_profit_train' = 0,
                      'p_mean_profit_test' = 0,
                      'n_up_0_train' = 0,
                      'n_up_0_test' = 0,
                      'n_mean_profit_train' = 0,
                      'n_mean_profit_test' = 0)

df_vars$var1 <- as.character(df_vars$var1)
df_vars$var2 <- as.character(df_vars$var2)

vDates <- create_vector_dates()
vSample_size <- 5
Ntimes <- ceiling(length(vDates)/vSample_size)
```

# KNNSearch fill df_vars

```{r, warning=FALSE, message=FALSE}
vVar1s <- unique(df_vars$var1)
vVar2s <- unique(df_vars$var2)

for (x in 1:(len-1)){
  vVar1 <- vVariables[x]
  for (y in (x+1):len){
    vVar2 <- vVariables[y]
    print(paste0('x:',x,' y:',y))
    
    if ((vVar1 %in% vVar1s) & (vVar2 %in% vVar2s)){next}
    
    df <- na.omit(df_profitPr[c(vVar1,vVar2,'profit','date')])
    
    lDates       <- get_sample_date_index(vDates)
    vDatesLeft   <- lDates$vDatesLeft
    vDatesSample <- lDates$vDatesSample
    
    var_indexs <- c()
    
    for (Ntime in 1:Ntimes) {
      if (length(vDatesSample) == 0) {next}
      
      for (ndate in 1:length(vDatesSample)) {
        date <- vDatesSample[ndate]
      # create X,y
      train_index <- df$date < date
      test_index  <- (df$date > (date %m+% months(1))) & (df$date < (date %m+% months(3)))

      l <- create_X_y(df = df, train_index = train_index, test_index = test_index, 
                      vVar1 = vVar1, vVar2 = vVar2)

      if (nrow(X_test) == 0) {next}
      
      for (nk in c(100)) {
        # summary
        var_index  <- paste0('x_',as.character(x),"_y_",as.character(y),"_nk_",nk,"_date_",date)
        var_indexs <- c(var_indexs,var_index)
        df_vars[var_index,] <- paste_summary(l$X_train, l$X_test, l$y_train, l$y_test)
      }
      }
      
      p_up_0_test <- mean(df_vars[var_indexs,'p_up_0_test'], na.rm = TRUE)
      if (is.na(p_up_0_test)) {p_up_0_test <- 0}
      n_up_0_test <- mean(df_vars[var_indexs,'n_up_0_test'], na.rm = TRUE)
      if (is.na(n_up_0_test)) {n_up_0_test <- 0}
      
      if ((p_up_0_test < 0.55) & (n_up_0_test < 0.55)) {
        vDatesSample <- c()
        } else {
          lDates       <- get_sample_date_index(vDatesLeft)
          vDatesLeft   <- lDates$vDatesLeft
          vDatesSample <- lDates$vDatesSample
        }
    }
  }
}

```






```{r}
df_summary <- df_vars %>%
  group_by(var1, var2, k) %>%
  summarise('p_up_0_train' = mean(p_up_0_train, na.rm = T),
            'p_up_0_test' = mean(p_up_0_test, na.rm = T),
            'p_mean_profit_train' = mean(p_mean_profit_train, na.rm = T),
            'p_mean_profit_test' = mean(p_mean_profit_test, na.rm = T),
            'n_up_0_train' = mean(n_up_0_train, na.rm = T),
            'n_up_0_test' = mean(n_up_0_test, na.rm = T),
            'n_mean_profit_train' = mean(n_mean_profit_train, na.rm = T),
            'n_mean_profit_test' = mean(n_mean_profit_test, na.rm = T),
            n = n())

df_summary_filter <- df_summary %>%
  filter(n >= 36)
```

# Vouting

```{r}
index <- df_profitPr$date == vDates[2]
mean(df_profitPr[index,'profit'] , na.rm = T)
```

```{r}
for (x in 1800:2440) {
  date <- df_profitPr[x,"date"]
  print(date)
  
  df_vote <- data.frame(
  "var1" = "var1",
  "var2" = "var2",
  "pred_profit" = 0,
  "max25" = 0,
  "min25" = 0,
  "p25" = 0,
  "n25" = 0,
  "date" = vDates[2]
  )
  df_vote$var1 <- as.character(df_vote$var1)
  df_vote$var2 <- as.character(df_vote$var2)
  
  for (index in 2:nrow(df_summary_filter)) {
    
  vVar1 <- df_summary_filter[index,"var1"][[1]]
  vVar2 <- df_summary_filter[index,"var2"][[1]]
  
  df <- na.omit(df_profitPr[c(vVar1,vVar2,'profit','date')])
  index_tain <- df$date < date
  index_predict <- df$date == date
  
  l <- create_X_y(df = df,
                  train_index = index_tain,
                  test_index = index_predict,
                  vVar1 = vVar1, vVar2 = vVar2)
  
  knn_test  <- knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=100)
  
  df_vote[index,"var1"] <- as.character(vVar1)
  df_vote[index,"var2"] <- as.character(vVar2)
  df_vote[index,"pred_profit"] <- knn_test[["pred"]]
  
  df_vote[index,"max25"] <- df_summary_filter[index,"p_mean_profit_test"]
  df_vote[index,"min25"] <- df_summary_filter[index,"n_mean_profit_test"]
  df_vote[index,"p25"] <- df_summary_filter[index,"p_up_0_test"]
  df_vote[index,"n25"] <- df_summary_filter[index,"n_up_0_test"]
  
  df_vote[index,"date"] <- date
  }
  
  df_vote_m <- df_vote %>%
  mutate('p_vote' = if_else(max25 > 0.02, max25, 0),
         'n_vote' = if_else(min25 < -0.05, -min25, 0)) %>%
  mutate('profit_vote_p' = pred_profit*p_vote,
         'profit_vote_n' = pred_profit*n_vote)
  
  df_vote_m_n <- df_vote_m %>%
    filter(n_vote != 0) %>%
    summarise(n_n = n(), profit_vote_n = sum(profit_vote_n)/sum(n_vote))
  df_vote_m_p <- df_vote_m %>%
    filter(p_vote != 0) %>%
    summarise(p_n = n(), profit_vote_p = sum(profit_vote_p)/sum(p_vote))
  
  df_profitPr[x,'n_n'] <- df_vote_m_n[1,'n_n']
  df_profitPr[x,'profit_vote_n'] <- df_vote_m_n[1,'profit_vote_n']
  
  df_profitPr[x,'p_n'] <- df_vote_m_p[1,'p_n']
  df_profitPr[x,'profit_vote_p'] <- df_vote_m_p[1,'profit_vote_p']
}
```



```{r}
ggplot() +
  geom_point(aes(x = profit_vote_n, y = profit_vote_p, 
                 color = profit, alpha = 0.1), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, limit = c(-.3,.3), space = "Lab",
                        low="red", mid="white", high="green") +
  #geom_density2d(aes(x = 'profit_vote_n', y = 'profit_vote_p', alpha = 0.099), data = df_profitPr) +
  xlab('profit_vote_n')+ylab('profit_vote_p')
```

```{r}
df_profitPr_count <- df_profitPr[1900:2440,]

index <- (df_profitPr_count$profit_pred > 0)
mean(df_profitPr_count[index,"profit_by_day"])
mean(df_profitPr_count[,"profit_by_day"])
```


```{r}
vVar1 = 'profit_vote_n'
vVar2 = 'profit_vote_p'

for (x in 1900:2440) {
  
  date <- df_profitPr[x,"date"]
  df <- na.omit(df_profitPr[c(vVar1,vVar2,'profit','date')])
  index_tain <- df$date < date
  index_predict <- df$date == date
  
  l <- create_X_y(df = df,
                  train_index = index_tain,
                  test_index = index_predict,
                  vVar1 = vVar1, 
                  vVar2 = vVar2)
  knn_test  <- knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=50)
  df_profitPr[x,'profit_pred'] <- knn_test[['pred']]
}
```


```{r}
ggplot() +
  geom_point(aes(x = profit_vote_n, y = profit_vote_p, 
                 color = profit_pred), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('profit_vote_n')+ylab('profit_vote_p')
```

```{r}
df_profitPr$profit_by_day <- df_daily$profit

ggplot() +
  geom_point(aes(x = date, y = profit, color = profit_pred), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('profit_vote_n')+ylab('profit_vote_p')
```

```{r}
df_profitPr$profit_by_day <- df_daily$profit

ggplot() +
  geom_point(aes(x = date, y = profit_by_day, color = profit_pred), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('profit_vote_n')+ylab('profit_vote_p')
```


```{r}
ggplot() +
  geom_point(aes(x = profit_pred, y = profit, color = profit_pred), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('profit_pred')+ylab('profit')
```

```{r}
ggplot() +
  geom_point(aes(x = profit_pred, y = profit_by_day, color = profit_pred), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('profit_pred')+ylab('profit')
```


```{r}
df_profitPr[2300:2310,c("date","profit",'n_n',"profit_vote_n",'p_n','profit_vote_p')]
```


```{r}
df_vote_m <- df_vote %>%
  mutate('p_vote' = if_else(max25 > 0.01, max25, 0),
         'n_vote' = if_else(min25 < -0.01, -min25, 0)) %>%
  mutate('p_vote' = if_else(pred_profit > 0.01, p_vote, 0),
         'n_vote' = if_else(pred_profit < -0.01, n_vote, 0)) %>%
  mutate('profit_vote' = pred_profit*p_vote)
```


```{r}
mean(df_vote_m$profit_vote) / ((mean(df_vote_m$p_vote) + mean(df_vote_m$n_vote))/2)
```



```{r}
df_vote %>%
  filter(max25 > 0.01) %>%
  summarise(pred = mean(pred_profit))
```

```{r}
df_vote %>%
  filter(max25 < -0.01) %>%
  summarise(pred = mean(pred_profit))
```


```{r}
df_vote_m %>%
  filter(p_vote != 0) %>%
  ggplot() +
  geom_histogram(aes(x = pred_profit))

df_vote_m %>%
  filter(n_vote != 0) %>%
  ggplot() +
  geom_histogram(aes(x = pred_profit))
```


# Plot

```{r}
vVar1 <- 'MAE_mean_Pr_50'
vVar2 <- 'IMOEX_sd_Pr_25'

df <- data.frame('var1' = df_profitPr[,vVar1], 
                 'var2' = df_profitPr[,vVar2],
                 'profit' = df_profitForvard[,"profit_mean_Next_25"])
df <- na.omit(df)

var1 <- seq(min(df$var1, na.rm = T), max(df$var1, na.rm = T), length.out=100)
var2 <- seq(min(df$var2, na.rm = T), max(df$var2, na.rm = T), length.out=100)
df_test <- expand.grid(var1,var2)
colnames(df_test) <- c("var1","var2")

knn <- knn.reg(train=df[c("var1","var2")],
                    y=df$profit,
                    test=df[c("var1","var2")],
                    k=150)
#df_test$pred <- knn[["pred"]]
df$pred <- knn[["pred"]]

ggplot() +
  geom_point(aes(x = var1, y = var2, 
                 color = pred, alpha = 0.1), 
             shape=15, size = 2, data = df) +
  scale_color_gradient2(midpoint=0, limit = c(-.3,.3), space = "Lab",
                        low="red", mid="white", high="green") +
  geom_density2d(aes(x = var1, y = var2, alpha = 0.099), data = df) +
  xlab(vVar1)+ylab(vVar2)

ggplot(df) +
  geom_histogram(aes(x = pred))

sd(df$pred)
```

```{r}
vVar1 <- 'IMOEX_mean_Pr_10'
vVar2 <- 'RTSch_sd_Pr_25'
View(df_profitPr[,c("date",vVar1,vVar2)])
```





```{r}
# write.csv(x=df_PrFutures, file="./data/strategy/df_PrFutures.csv", row.names = F)
```


# ProbTS

```{r}
# source("./scripts/get_ProbBetaDist.r")
# df_ProbBeta_tradestop <- get_ProbBetaDist(df_daily = df_daily, vColName = 'tradestop', sliding_depth = 100)
```


# EDA
## profit - variable
```{r}
# ProbTS density
# branch <- "./plots/eda/variables/"
# vVariables <- colnames(df_profitPr)
# for (vVariable in vVariables){
#   
#   df <- data.frame('variable' = df_profitPr[,vVariable],
#                    'profit' = df_profitForvard[,"profit_mean_Next_25"])
#   
#   sGGplot <- ggplot(df) +
#     geom_point(aes(x = variable, y = profit)) +
#     xlab(vVariable) +
#     ylab('ProfitNext25')
#   saveGGplot(sGGplot,branch,vVariable)
# }
# opendir(branch)
```

## var1 - var2 -- profit
```{r}
# ProbTS density

# branch <- "./plots/eda/var1var2/"
# vVariables <- colnames(df_profitPr)
# for (x in 21:length(vVariables)){
#   vVar1 <- vVariables[x]
#   for (y in (x+1):length(vVariables)){
#     vVar2 <- vVariables[y]
#     
#   df <- data.frame('var1' = df_profitPr[,vVar1], 'var2' = df_profitPr[,vVar2],
#                    'profit' = df_profitForvard[,"profit_mean_Next_25"])
#   df <- na.omit(df)
#   
#   sGGplot <- ggplot(df) +
#     geom_point(aes(x = var1, y = var2, color = profit, size = 10, alpha = 0.01), shape=15) +
#     xlab(vVar1) +
#     ylab(vVar2) +
#     scale_color_gradient(low="red", high="green")
#   saveGGplot(sGGplot,branch,paste0(vVar1,'_',vVar2))
#   }
#   }
# opendir(branch)
```



# R2
```{r}
create_df_r <- function(vProfitLenght) {
  df_r <- data.frame('future' = colnames(df_PrFutures))
  df_r$future <- as.character(df_r$future)
  df_r$profit <- vProfitLenght
  df_r$r2 <- NA
  
  for (n in 1:nrow(df_r)) {
    df <- data.frame(cbind(df_profit[, vProfitLenght],
                           df_PrFutures[, df_r[n, 'future']]))
    colnames(df) <- c('y', 'x')
    df <- df %>%
      mutate(x.sqrt = sqrt(x),
             x2 = x ^ 2,
             x3 = x ^ 3)
    
    lm_model <- lm(y ~ ., data = df)
    
    df_r[n, 'r2']     <- summary(lm_model)[["r.squared"]]
    
  }
  
  return(list(df_r))
}

l_r2 <- list()
for (vProfitLenght in paste0("profit_mean_Next_",c(2:100))) {
  l_r2[vProfitLenght] <- create_df_r(vProfitLenght)
}
df_r2 <- do.call("rbind", l_r2)
```


```{r}
df_PrCols <- makePrColForStrategy(df_strategy = df_daily,
                                  vColNames = "profit",
                                  sliding_depth = 50,
                                  vColReturn = c(10,25,50))
df_daily <- cbind(df_daily,df_PrCols)
```

```{r}
colnames(df_profitPr)
```

```{r}
df_profitPr[,'diff_Pr20'] <- c((df_profitPr[2:nrow(df_profitPr), 'profit.profit_mean_Pr_20']
                                - df_profitPr[1:(nrow(df_profitPr)-1), 'profit.profit_mean_Pr_20']), 
                               NA)

df_daily$diff_Pr20 <- df_profitPr$diff_Pr20
#undebug(makePrColForStrategy)
df_profitPr[,paste0('diff_Pr20','_Pr_',1:5)] <- makePrColForStrategy(df_strategy = df_daily,
                     vColNames = "diff_Pr20",
                     sliding_depth = 30,vColReturn = 1:5)
```

```{r}
View(df_profitPr[,c('profit.profit_mean_Pr_20','diff_Pr20')])
```


```{r}
df_profitPr[1:(nrow(df_profitPr)-1), 'profit.profit_mean_Pr_20']
```


```{r}
df <- data.frame('date' = df_daily[,"date"],
                 'profitPr' = df_profitPr[,"profit.profit_mean_Pr_20"]/df_profitPr[,"profit.profit_mean_Pr_25"],
                 'profitNext' = df_profitForvard[,"profit_mean_Next_5"])

ggplot() +
  geom_point(aes(x = profitNext, y = profitPr, color = 'red'), data = df) +
  ylim(-3,4)
  #geom_point(aes(x = date, y = profitPr), data = df)
```

```{r}
df <- data.frame(cbind(df_profitPr[, c("profit.profit_sd_Pr_50","profit.profit_mean_Pr_50")],
                       df_daily[, "date"]))

colnames(df) <- c('sd', 'mean', 'date')
# df <- df %>%
#   mutate(x.sqrt = sqrt(x),
#          x2 = x ^ 2,
#          x3 = x ^ 3)

# lm_model <- lm(y ~ ., data = df)

# v_df <- data.frame('x' = seq(0, 1, length.out = 100))
# v_df <- v_df %>%
#   mutate(x.sqrt = sqrt(x),
#          x2 = x ^ 2,
#          x3 = x ^ 3)
# pred_df <- data.frame(predict(lm_model, v_df, interval = "prediction"))
# pred_df$v_x <- v_df$x

ggplot() +
  #geom_point(aes(x = date, y = sd), data = df) +
  geom_point(aes(x = date, y = mean), data = df[index[60:length(index)],])
```



```{r}
# dat <- data.frame(x=1:5, y=1:5, z=2:6)
# do.call(poly, c(lapply(1:3, function(x) dat[,x]), degree=3, raw=T))
```


```{r}
source("./scripts/makeNextColForStrategy.r")
makeNextColForStrategy(df_daily,'profit')
```



```{r}
df_ProbBetaDist[,'profit'] <- df_daily[,'profit']
df_ProbBetaDist[,'tradestop'] <- df_daily[,"tradestop"]
df_ProbBetaDist[,"date"] <- df_daily[,"date"]
df_ProbBetaDist[,"year"] <- df_daily[,"year"]
df_ProbBetaDist[,"strategy"] <- df_daily[,"strategy"]
df_ProbBetaDist[,"index"] <- df_daily[,"index"]
df_ProbBetaDist[,"PosProf"] <- df_daily[,"PosProf"]


df_ProbBetaDist <- makePrColForStrategy(df_strategy = df_ProbBetaDist, 
                                          vColNames = "mean_20", 
                                          sliding_depth = 3)

df_ProbBetaDist <- df_ProbBetaDist %>%
  mutate(PrDecr1 = if_else(mean_20 < mean_20_Pr1, T, F),
         PrDecr2 = if_else(mean_20_Pr1 < mean_20_Pr2, T, F),
         PosPr = if_else(profit > 0, T, F))

vPosPr <- as.numeric(df_ProbBetaDist$PosPr)
for (n in 2:length(vPosPr)) {
  if (vPosPr[n] != 0) {
    if (vPosPr[n-1] != 0) {
      vPosPr[n] = vPosPr[n]+vPosPr[n-1]
    }
  }
}

df_ProbBetaDist$nPosPr <- vPosPr
df_ProbBetaDist$probPosPr <- dbinom(x = vPosPr,size = vPosPr+1,prob = 0.5)
```






```{r}
# ProbTS density
branch <- "./plots/eda/ProbTS_Density/"
for (vStrategy in vStrategies){
  
  index_ts <- which(df_daily$tradestop == T & df_daily$strategy == vStrategy)
  sGGplot <- ggplot() +
    geom_density(data = df_daily[-index_ts,], aes(x=probTS_mean50), color = "darkgreen", fill="green", alpha=.3) +
    geom_density(data = df_daily[index_ts,], aes(x=probTS_mean50), color = "darkred", fill="red", alpha=.3) +
    ggtitle(paste0("Trade stop probability calculated by calendar month ",vStrategy)) +
    scale_color_manual(values = colors)
  print(sGGplot)
  #saveGGplot(sGGplot,branch,vStrategy)
}
#opendir(branch)
```



### Table probTS - realTS

Calculating real cumulative trade stop probability for `probTS` scale. 

```{r}
df_tsprob <- data.frame(mean_probTS = numeric(),
                        mean_profit = numeric(),
                        mean_realTS = numeric(),
                        strategy = character())

# botstraping for each prob level

for (strategy in vStrategies) {
  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS >= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }

  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS <= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }
}

# transform data to predicted and ci values
df_tsprob <- df_tsprob %>% 
  group_by(strategy, gr=cut(mean_probTS, 
                            breaks = seq(from = 0, to = 1, length.out = 100) )) %>%
  summarise(n = n(), 
            mean_probTS = mean(mean_probTS),
            pred_realTS = mean(mean_realTS),
            low_realTS = qnorm(c(0.025), mean = mean(mean_realTS), sd = sd(mean_realTS)),
            hight_realTS = qnorm(c(0.975), mean = mean(mean_realTS), sd = sd(mean_realTS))) %>%
  filter(!is.na(pred_realTS))

df_tsprob <- df_tsprob %>%
  mutate(low_realTS = case_when(low_realTS < 0 ~ 0,
                                low_realTS > 1 ~ 1,
                                TRUE ~ low_realTS),
         hight_realTS = case_when(hight_realTS < 0 ~ 0,
                                hight_realTS > 1 ~ 1,
                                TRUE ~ hight_realTS))
rm(df_daily_nona)
```

```{r}
branch <- "./plots/eda/MAProbTS_RealProbTS_with_CI/"
for (vStrategy in vStrategies){
  sGGplot <- df_tsprob %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = mean_probTS, y = pred_realTS)) +
    geom_point(aes(x = mean_probTS, y = low_realTS)) +
    geom_point(aes(x = mean_probTS, y = hight_realTS)) +
    ggtitle(paste0("Relationship between MAProbTS & RealProbTS with CI for ",vStrategy)) +
    ylab("RealProbTS") +
    xlab("MAProbTS")

  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

### RealProbTS 

Correspond MAProbTS & RealProbTS in historical data.

```{r}
get_realCI95probTSbyMAprob <- function(prob, df_tsprob) {
  if (is.nan(prob) == T) {
    data.frame("pred_realTS" = NA,
               "low_realTS" = NA,
               "hight_realTS" = NA)
    
  } else {
      index <- which.min(abs(df_tsprob$mean_probTS-prob))
      df_tsprob[index,c("pred_realTS","low_realTS","hight_realTS")]
  }
}

df_daily$RealProbTS       <- as.numeric(NA)
df_daily$RealProbTS_low   <- as.numeric(NA)
df_daily$RealProbTS_hight <- as.numeric(NA)

for (index in 1:nrow(df_daily)) {
  strategy <- df_daily[index,"strategy"][[1]]
  realTS95CI <- get_realCI95probTSbyMAprob(df_daily[index,"probTS"][[1]], 
                                           df_tsprob = df_tsprob[which(df_tsprob$strategy == strategy),])
  df_daily[index,"RealProbTS"] <- realTS95CI[1,"pred_realTS"][[1]]
  df_daily[index,"RealProbTS_low"] <- realTS95CI[1,"low_realTS"][[1]]
  df_daily[index,"RealProbTS_hight"] <- realTS95CI[1,"hight_realTS"][[1]]
}
```

```{r}
branch <- "./plots/eda/RealProbTS TimeLine/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = date, y = RealProbTS)) +
    ggtitle(paste0("Trade stop probability timeline for ",vStrategy))
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

# ProbTS

```{r}
# source("./scripts/get_ProbBetaDist.r")
# df_ProbBeta_tradestop <- get_ProbBetaDist(df_daily = df_daily, vColName = 'tradestop', sliding_depth = 100)
```

# Other MA variabels

```{r}
vColNames <- c("profit", "bartime", "barprofit", 
               "MAE", "MFE", "entryprice", "exitprice", 
               vColNamesMoexRTS[2:length(vColNamesMoexRTS)])

df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = vColNames,
                                 sliding_depth = sliding_depth)
# creating MA
for (vColName in vColNames) {
  for (n in 2:sliding_depth) {
    df_daily[,paste0(vColName,"_SDMA",n)]   <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,sd,  na.rm = F)
    df_daily[,paste0(vColName,"_meanMA",n)] <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,mean,na.rm = F)
  }
  # del _Pr columns
  drops <- c(paste0(vColName,"_Pr",1:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  
  df_daily[,paste0(vColName,"_SDSD")]   <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_SDmean")] <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,mean,na.rm = F)
  df_daily[,paste0(vColName,"_meanSD")]   <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_meanmean")] <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,mean,na.rm = F)
  
  # del _MA columns
  drops <- c(paste0(vColName,"_SDMA",  2:sliding_depth),
             paste0(vColName,"_meanMA",2:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
}

for (vColName in vColNames) {
  df_daily[,paste0(vColName,"_pred")]   <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_low")]   <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_hight")]   <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  
  df_daily[,paste0(vColName,"_predSD")] <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_lowSD")] <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_hightSD")] <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  # del _MA columns
  drops <- c(paste0(vColName,"_meanmean"),
             paste0(vColName,"_meanSD"),
             paste0(vColName,"_SDmean"),
             paste0(vColName,"_SDSD"))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  }
```

# ProfitTS
```{r}
df_dailyTS <- df_daily %>%
  filter(!is.na(probTS))

df_TSprofit <- df_dailyTS %>%
  filter(tradestop == 1) %>%
  group_by(strategy) %>%
  summarise(TSprofit = mean(profit))

df_dailyTS <- merge(df_dailyTS, df_TSprofit, by = "strategy", all.x = T)

df_dailyTS <- df_dailyTS %>%
  mutate(profitTS = case_when(tradestop == 1 ~ TSprofit*RealProbTS,
                              TRUE ~ profit+TSprofit*RealProbTS))
drops <- c("TSprofit")
df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% drops)]
```

```{r}
branch <- "./plots/eda/expected profit distribution/"
for (vStrategy in vStrategies){
  sGGplot <- df_dailyTS %>%
    filter(strategy == vStrategy) %>%
    ggplot() + 
    geom_density(aes(x = profit), color="cadetblue4", fill="cadetblue4", alpha=.3) +
    geom_density(aes(x = profitTS), color="darkred", fill="#FF6666", alpha=.3) +
    ggtitle(paste0("Expected profit distribution (profitTS) for ", vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```



# sGGplot for numeric variable
## profitTS
```{r, message=FALSE}
branch <- paste0("./plots/eda/profitTS/")
if (!file.exists(branch)) {
                dir.create(branch)
}

vVariables <- names(df_dailyTS)[c(16:376)]
df_dailyTS$sumVariable <- as.numeric(NA)

for (vStrategy in vStrategies) {
  indexSTR <- which(df_dailyTS$strategy == vStrategy)
  
  for (vVariable in vVariables[1]) {
    
    vMin <- min(df_dailyTS[indexSTR,vVariable], na.rm = T)
    vMax <- max(df_dailyTS[indexSTR,vVariable], na.rm = T)
    
    df_dailyTS[,"gr"] <- NA
    df_dailyTS[indexSTR,"gr"] <- cut(df_dailyTS[indexSTR,vVariable], 
                                     breaks = seq(from = vMin,
                                                  to = vMax,
                                                  length.out = 50))
    df_dailyTS[indexSTR,"sumVariable"] <- df_dailyTS[indexSTR,vVariable]
    
    branch <- paste0("./plots/eda/profitTS/",vVariable,"/")
    sGGplot <- df_dailyTS[indexSTR,] %>% 
      group_by(gr) %>%
      summarise(sumVariable = mean(sumVariable),
                profitTS = mean(profitTS)) %>%
      filter(!is.na(sumVariable)) %>%
      ggplot(aes(x = sumVariable, y = profitTS)) +
      geom_point(size=5) +
      ggtitle(paste0("Relationship between ",vVariable," & profitTS for ", vStrategy)) +
      xlab(vVariable) +
      ylab("profitTS")
    
    saveGGplot(sGGplot,branch,vStrategy)
  }
}
```

# Decision-making section

## Grouping

```{r, message=F, warning=F}
make_groups <- function(df_dailyTS, vVariables, nBoot = 8, vYears) {
  
  df_dailyTS <- df_dailyTS %>%
    filter(year %in% vYears)
  
  get_index <- function(df = df_dailyTS) {
      df_index <- df %>%
        group_by(strategy) %>%
        summarise(start = min(index),stop = max(index),strategy = strategy[1]) %>%
        group_by(strategy) %>%
        summarise(index = sample(start:stop, stop-start, replace = T))
      vIndex <- df_index$index
      vIndex
  }
  
  get_group <- function(df_dailyTS) {
    
    if (is.numeric(df_dailyTS$variable) == T) {
      
      df_group <- df_dailyTS %>%
        group_by(sumVariable) %>%
        summarise(variableName = vVariable,
                  variableValue  = mean(variable, na.rm = T),
                  variableFactor = "numeric",
                  profitMean = mean(profitTS),
                  ProfitSD = sd(profitTS),
                  n = n())
      
      df_group$group <- as.character(df_group$sumVariable)
      
    } else {
      df_group <- df_dailyTS %>%
        group_by(sumVariable) %>%
        summarise(variableName = vVariable,
                  variableValue  = 0,
                  variableFactor = as.character(variable[1]),
                  profitMean = mean(profitTS),
                  ProfitSD = sd(profitTS),
                  n = n())
      
      df_group$group <- as.character(df_group$variableFactor)
      }

        #df_group$group <- as.character(df_group$sumVariable)
        ###df_group$year <- as.character(df_group$year)
        df_group <- df_group[ , !(names(df_group) == "sumVariable")]

                df_group
                }
  
  create_grouping_variable <- function(df_dailyTS) {
    if (is.numeric(df_dailyTS[,"variable"][[1]])) {
      
      # for numeric
      df_dailyTS <- df_dailyTS %>%
        group_by(strategy) %>%
        arrange(variable) %>%
        mutate(gr_index = 1:max(n())) %>%
        group_by(gr_index,
                 sumVariable = cut(gr_index,
                                   breaks = seq(from = 1,
                                                to = max(n()),
                                                length.out = ceiling((max(n())/100)+1))))
      
    } else {
      df_dailyTS$sumVariable <- df_dailyTS[,"variable"]
    }
    df_dailyTS
    }

  df_groups <- data.frame(# year = character(),
                          variableName = character(),
                          variableFactor = character(),
                          variableValue = double(),
                          profitMean = double(),
                          ProfitSD = double(),
                          n = integer(),
                          group = character())
  
  # get bootstrap indexes 
  df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% c("index"))]
  df_dailyTS <- df_dailyTS %>%
    arrange(strategy,date)
  df_dailyTS$index <- 1:nrow(df_dailyTS)
  l_indexes <- list()
  for (boot in 1:nBoot) {
    l_indexes[[boot]] <- get_index(df = df_dailyTS)
  }
  
for (vVariable in vVariables) {
  # create grouping variable
  df_dailyTS[,"variable"] <- df_dailyTS[,vVariable]
  df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% c("sumVariable","cutVariable"))]
  df_dailyTS <- create_grouping_variable(df_dailyTS = df_dailyTS)
  
  # create bootstrap df
  l_dailyTS <- list()
  for (boot in 1:nBoot) {
    l_dailyTS[[boot]] <- df_dailyTS[l_indexes[[boot]],]
  }
  
  # create groops
  df_group <- dplyr::bind_rows(lapply(l_dailyTS,get_group))
  df_groups <- dplyr::bind_rows(list(df_groups, df_group))
}
  
df_groups
}
```

### Stability for variable

```{r}
vVariables_row <- names(df_dailyTS)[c(13,14,16:376)] #376
vVariables <- grep(("_low|_hight|_pred"), vVariables_row, value = T)
vVariables <- c(vVariables,c("probTS","RealProbTS","month","wday"))
```

```{r}
get_prob0m <- function(vRow,
                       vVariables,
                       m_groupsW,
                       m_variableValue,
                       m_prob0,
                       vNRow) {
  
# prepare matrix from row from df_daily
m_RowDaily <- as.matrix(as.numeric(as.character(vRow[vVariables])))
m_RowDaily <- matrix(rep(m_RowDaily,each=vNRow),nrow=vNRow)

# create abs diff
m_minVariableValue <- abs(m_variableValue - m_RowDaily)

# find index of abs diff
minindex <- apply(m_minVariableValue, 2, which.min)
if (is.list(minindex) == T) {
  
  for (i in 1:length(minindex)) {
    if (is.na(minindex[[i]][1])) {
      minindex[[i]][1] <- 'empty'
    }
  }
  
  minindex <- unlist(minindex, use.names = T)
  minindex[which(minindex == 'empty')] <- NA
  
  vColNamesM <- names(minindex)
  vColNamesM <- gsub("[0-9]+$","",vColNamesM)
  vColNamesM <- gsub("[.]$","",vColNamesM)
  m_prob0 <-  m_groupsW[,gsub("variableValue","prob0",vColNamesM)]
}

vNRow <- nrow(m_prob0)
vNCol <- ncol(m_prob0)
dim(m_prob0) <- c(vNRow*vNCol,1)

minindex <- as.integer(minindex)
indexNA <- which(is.na(minindex))

minindex[indexNA] <- 0 #temp
minindex_in_row <- minindex + vNRow*(0:(vNCol-1))

minindex_in_row[indexNA] <- NA

vProb0  <- m_prob0[minindex_in_row,1]
vProb0
}

completeDfGroups <- function(df_groups) {
    
  df_groups$group <- as.numeric(as.factor(df_groups$group))
  
  df_groups <- df_groups %>%
    mutate(group = if_else(variableFactor == "numeric", as.character(group), variableFactor))
  
  df_groups <- df_groups %>%
    filter(!is.na(ProfitSD)) %>%
    filter(!is.na(group))
  
  df_groups <- df_groups %>%
    mutate(profitSE = ProfitSD/sqrt(n)) %>%
    group_by(variableName, group) %>%
    summarise(variableFactor = variableFactor[1],
            variableValue = mean(variableValue),
            profitMean = mean(profitMean),
            profitSE = mean(profitSE),
            n = round(mean(n),digits = 0)) %>%
    mutate(variableValue = if_else(variableFactor == "numeric", variableValue, as.numeric(as.character(variableFactor)))) %>%
    mutate(group = as.factor(group))
  
  index <- which(df_dailyTS$year %in% vYears)
  vMeanProfSt <- mean(df_dailyTS[index,"profitTS"])
  vSEProfSt   <- sd(df_dailyTS[index,"profitTS"])/sqrt(nrow(df_dailyTS[index,]))
  
  df_groups <- df_groups %>%
    mutate(deltaProfitGr = profitMean - vMeanProfSt,
           tProfGr = deltaProfitGr/profitSE,
           kGr = 1 - pt(tProfGr,n-1),
           tProb0 = 0 - ((vMeanProfSt+deltaProfitGr*kGr)/vSEProfSt),
           prob0 = pt(tProb0,n-1))
  
  df_groups <- df_groups %>%
    select(group, variableName, variableValue, prob0) %>%
    mutate(group = as.numeric(as.character(group)))
  
  df_groups
  }
  
createMGroups <- function(df_groups) {
    
    df_groupsW <- reshape(data.frame(df_groups),
                          idvar = "group",
                          v.names = c("prob0", "variableValue"),
                          timevar = "variableName",
                          direction = "wide")
    
    as.matrix(df_groupsW)
  }
  
getProfitGR <- function(df_daily, ...) {
      m_profitGR <- apply(df_daily, 1 , FUN = function(x) get_prob0m(x,vVariables,m_groupsW,m_variableValue,m_prob0,vNRow))
      
      toDF <- function(m_profitGR, ...) {
        if (is.list(m_profitGR) == T) {
          df_profitGR <- data.frame(t(sapply(m_profitGR, function(x) x[1:max(lengths(m_profitGR))])))
          } else {
            df_profitGR <- data.frame(t(m_profitGR))
            }
        df_profitGR
      }
      
      df_profitGR <- toDF(m_profitGR)

      colnames(df_profitGR) <- paste0("prob0.",vVariables)
      vCols <- c("profit","year","month","wday")
      df_profitGR[,vCols] <- df_daily[,vCols]
      
      df_profitGR <- df_profitGR %>%
        mutate(forecast = if_else(year %in% vYears, F, T),
               profitFT = if_else(year %in% vYears, 0, profit),
               profitFF = if_else(year %in% vYears, profit, 0))
      
      df_profitGR
}

getStabilityForCoefficient <- function(vYearsFull, vVariables, df_dailyTS, nBoots = 10) {
  
  # functions section

  df_profitGRdiffsAll <- data.frame(prob0 = numeric(),
                                  vVariable = character(),
                                  profitFT = numeric(),
                                  profitFF = numeric(),
                                  profit = numeric(),
                                  dif = numeric(),
                                  simProf = numeric(),
                                  vH1 = numeric(),
                                  n = numeric(),
                                  weight = numeric())
  
  completeDfGroups <- function(df_groups) {
    
  df_groups$group <- as.numeric(as.factor(df_groups$group))
  
  df_groups <- df_groups %>%
    mutate(group = if_else(variableFactor == "numeric", as.character(group), variableFactor))
  
  df_groups <- df_groups %>%
    filter(!is.na(ProfitSD)) %>%
    filter(!is.na(group))
  
  df_groups <- df_groups %>%
    mutate(profitSE = ProfitSD/sqrt(n)) %>%
    group_by(variableName, group) %>%
    summarise(variableFactor = variableFactor[1],
            variableValue = mean(variableValue),
            profitMean = mean(profitMean),
            profitSE = mean(profitSE),
            n = round(mean(n),digits = 0)) %>%
    mutate(variableValue = if_else(variableFactor == "numeric", variableValue, as.numeric(as.character(variableFactor)))) %>%
    mutate(group = as.factor(group))
  
  index <- which(df_dailyTS$year %in% vYears)
  vMeanProfSt <- mean(df_dailyTS[index,"profitTS"])
  vSEProfSt   <- sd(df_dailyTS[index,"profitTS"])/sqrt(nrow(df_dailyTS[index,]))
  
  df_groups <- df_groups %>%
    mutate(deltaProfitGr = profitMean - vMeanProfSt,
           tProfGr = deltaProfitGr/profitSE,
           kGr = 1 - pt(tProfGr,n-1),
           tProb0 = 0 - ((vMeanProfSt+deltaProfitGr*kGr)/vSEProfSt),
           prob0 = pt(tProb0,n-1))
  
  df_groups <- df_groups %>%
    select(group, variableName, variableValue, prob0) %>%
    mutate(group = as.numeric(as.character(group)))
  
  df_groups
  }
  
createMGroups <- function(df_groups) {
    
    df_groupsW <- reshape(data.frame(df_groups),
                          idvar = "group",
                          v.names = c("prob0", "variableValue"),
                          timevar = "variableName",
                          direction = "wide")
    
    as.matrix(df_groupsW)
  }
  
getProfitGR <- function(df_daily, ...) {
      m_profitGR <- apply(df_daily, 1 , FUN = function(x) get_prob0m(x,vVariables,m_groupsW,m_variableValue,m_prob0,vNRow))
      
      toDF <- function(m_profitGR, ...) {
        if (is.list(m_profitGR) == T) {
          df_profitGR <- data.frame(t(sapply(m_profitGR, function(x) x[1:max(lengths(m_profitGR))])))
          } else {
            df_profitGR <- data.frame(t(m_profitGR))
            }
        df_profitGR
      }
      
      df_profitGR <- toDF(m_profitGR)

      colnames(df_profitGR) <- paste0("prob0.",vVariables)
      vCols <- c("profit","year","month","wday")
      df_profitGR[,vCols] <- df_daily[,vCols]
      
      df_profitGR <- df_profitGR %>%
        mutate(forecast = if_else(year %in% vYears, F, T),
               profitFT = if_else(year %in% vYears, 0, profit),
               profitFF = if_else(year %in% vYears, profit, 0))
      
      df_profitGR
}
  
  for (vNBoot in 1:nBoots) {
    
    vYears <- sample(vYearsFull,ceiling(length(vYearsFull)*0.65),replace = F)
    df_groups <- make_groups(df_dailyTS = df_dailyTS, vVariables = vVariables, nBoot = 10, vYears = vYears)
    df_groups <- completeDfGroups(df_groups)
    
    # get matrix for groups
    m_groupsW       <- createMGroups(df_groups)
    m_variableValue  <- m_groupsW[,paste0("variableValue.",vVariables)]
    m_prob0          <- m_groupsW[,paste0("prob0.",vVariables)]
    vNRow            <- nrow(m_groupsW)

    # get profitGR
    df_profitGR <- getProfitGR(df_daily)
    
    # get stable for strategies sample
    bi <- bayes_inference(y = profit, x = forecast, data = df_profitGR,
                      statistic = "mean", 
                      type = "ht", alternative = "twosided", null = 0,
                      prior = "JZS", rscale = 1,
                      method = "theoretical", show_plot = F, show_res = F, show_summ = F)
    df_profitGR$simProf <- bi[["BF"]][[1]]

    # get stable for variable
    df_profitGRdiffs <- data.frame(prob0 = numeric(),
                              vVariable = character(),
                              profitFT = numeric(),
                              profitFF = numeric(),
                              profit = numeric(),
                              dif = numeric(),
                              simProf = numeric(),
                              vH1 = numeric(),
                              n = numeric())

for(vVariable in vVariables) {
  
  # grouping by prob0
  df_profitGR[,"prob0"] <- df_profitGR[,paste0("prob0.",vVariable)]
  df_profitGR <- df_profitGR %>%
    group_by(prob0) 
  grIndexProfitGR <- attr(df_profitGR,"groups")$'.rows'
  vH1 <- c()
  
  # for each group culculate BF
  for(Indexes in grIndexProfitGR) {
    # cheak to having True and False for forecast
    vNumTF <- length(unique(df_profitGR[Indexes,"forecast"])[[1]])
    # cheak to number of observations for T&F forecast
    Vn <- df_profitGR[Indexes,] %>%
      group_by(forecast) %>%
      summarise(Vn = n())
      
    if (vNumTF == 1 | min(Vn$Vn) == 1) {
      vH1[length(vH1)+1] <- as.numeric(NA)
      
      } else {
        bi <- bayes_inference(y = profit, x = forecast, data = df_profitGR[Indexes,],
                              statistic = "mean",
                              type = "ht", alternative = "twosided", null = 0,
                              prior = "JZS", rscale = 1,
                              method = "theoretical", show_plot = F, show_res = F, show_summ = F)
        vH1[length(vH1)+1] <- bi[["BF"]][[1]]
  }
}
  df_profitGRdiff <- df_profitGR %>%
    group_by(prob0) %>%
    summarise(vVariable,
              profitFT = mean(profitFT),
              profitFF = mean(profitFF),
              profit = mean(profit),
              dif = (profitFT - profitFF)/profit,
              simProf = mean(simProf),
              n = n())
  df_profitGRdiff$vH1 <- vH1
  
  df_profitGRdiffs <- dplyr::bind_rows(list(df_profitGRdiffs, df_profitGRdiff))
}

df_profitGRdiffs <- df_profitGRdiffs %>%
  filter(!is.na(prob0)) %>%
  mutate(weight = (vH1/simProf)^3)

df_profitGRdiffsAll <- dplyr::bind_rows(list(df_profitGRdiffsAll, df_profitGRdiffs))
}

df_profitGRdiffsAll

}
```



```{r message=FALSE, warning=FALSE}
#undebug(make_groups_new)
df_daily[sapply(df_daily, is.infinite)] <- NA
df_daily <- df_daily %>% mutate_if(is.factor, as.character)
```


```{r message=FALSE, warning=FALSE}
vVariables <- c("probTS","RealProbTS","month","wday",
                "MAE_pred","MAE_low","MAE_hight",
                "MAE_predSD","MAE_lowSD","MAE_hightSD",
                "MFE_pred","MFE_low","MFE_hight",
                "MFE_predSD","MFE_lowSD","MFE_hightSD")

#Rprof()
undebug(getStabilityForCoefficient)
df_CoefStability <- getStabilityForCoefficient(vYearsFull = vYearsFull[1:8],
                                               vVariables = vVariables,
                                               df_dailyTS = df_dailyTS,
                                               nBoots = 50)
#Rprof(NULL)
#s <- summaryRprof()
#s
```

```{r}
df_CoefStabilityC <- df_CoefStability %>%
  group_by(vVariable,
           Gr = cut(prob0, breaks = c(-0.001,seq(from = 0.025,to = 0.975,by = 0.05),1.001))) %>%
  summarise(prob0 = mean(prob0, na.rm = T),
            weight = mean(weight, na.rm = T),
            profit = mean(profit, na.rm = T),
            n = n()) %>%
  ungroup() %>%
  select(Gr,vVariable,prob0,weight,n, profit)

df_CoefStabilityC$vVariable <- as.factor(df_CoefStabilityC$vVariable)
df_CoefStabilityC$Gr <- as.factor(as.numeric(df_CoefStabilityC$Gr))

vProfStr <- mean(df_daily[which(df_daily$year %in% vYearsFull),"profit"][[1]], na.rm = T)

df_CoefStabilityC <- df_CoefStabilityC %>%
  mutate(profitDiff = (profit - vProfStr)*weight)
```

make df with prob0 for each day
```{r message=FALSE, warning=FALSE}
df_groups <- make_groups(df_dailyTS = df_dailyTS, vVariables = vVariables, nBoot = 10, vYears = vYearsFull[1:8])
df_groups <- completeDfGroups(df_groups)
    
# get matrix for groups
m_groupsW       <- createMGroups(df_groups)
m_variableValue  <- m_groupsW[,paste0("variableValue.",vVariables)]
m_prob0          <- m_groupsW[,paste0("prob0.",vVariables)]
vNRow            <- nrow(m_groupsW)

# get profitGR
df_profitGR <- getProfitGR(df_daily)
```

```{r}
names(df_CoefStabilityC)
```

make prof diff for each day
```{r}
createMGroupsProb0 <- function(df_groups) {
    
    df_groupsW <- reshape(data.frame(df_groups),
                          idvar = "Gr",
                          v.names = c("prob0", "profitDiff"),
                          timevar = "vVariable",
                          direction = "wide")
    
    as.matrix(df_groupsW)
  }
m_CoefStabProfDiff <-  createMGroupsProb0(df_CoefStabilityC[,c("Gr","vVariable","prob0","profitDiff")])
m_CoefStabProfDiff <- apply(m_CoefStabProfDiff, 2, as.numeric)
class(m_CoefStabProfDiff) <- "numeric"
storage.mode(m_CoefStabProfDiff) <- "numeric"

m_profitDiff    <- m_CoefStabProfDiff[,paste0("profitDiff.",vVariables)]
m_prob0PRofDiff <- m_CoefStabProfDiff[,paste0("prob0.",vVariables)]
vNRow            <- nrow(m_CoefStabProfDiff)
```




```{r}
get_prob0mProbDiff <- function(vRow,
                               vVariables,
                               m_groupsW,
                               m_prob0PRofDiff,
                               m_profitDiff,
                               vNRow) {
  
# prepare matrix from row from df_daily
m_RowDaily <- as.matrix(as.numeric(as.character(vRow[paste0("prob0.",vVariables)])))
m_RowDaily <- matrix(rep(m_RowDaily,each=vNRow),nrow=vNRow)

# create abs diff
m_minVariableValue <- abs(m_prob0PRofDiff - m_RowDaily)

# find index of abs diff
minindex <- apply(m_minVariableValue, 2, which.min)
if (is.list(minindex) == T) {
  
  for (i in 1:length(minindex)) {
    if (is.na(minindex[[i]][1])) {
      minindex[[i]][1] <- 'empty'
    }
  }
  
  minindex <- unlist(minindex, use.names = T)
  minindex[which(minindex == 'empty')] <- NA
  
  vColNamesM <- names(minindex)
  vColNamesM <- gsub("[0-9]+$","",vColNamesM)
  vColNamesM <- gsub("[.]$","",vColNamesM)
  m_profitDiff <-  m_groupsW[,gsub("profitDiff","prob0",vColNamesM)]
}

vNRow <- nrow(m_profitDiff)
vNCol <- ncol(m_profitDiff)
dim(m_profitDiff) <- c(vNRow*vNCol,1)

minindex <- as.integer(minindex)
indexNA <- which(is.na(minindex))

minindex[indexNA] <- 0 #temp
minindex_in_row <- minindex + vNRow*(0:(vNCol-1))

minindex_in_row[indexNA] <- NA

vProb0  <- sum(m_profitDiff[minindex_in_row,1], na.rm = T)
vProb0
}

undebug(get_prob0mProbDiff)
df_profitGR[,"profitProb0"] <- apply(df_profitGR[,], 1 , FUN = function(x) get_prob0mProbDiff(x,
                                                                                           vVariables,
                                                                                           m_CoefStabProfDiff,
                                                                                           m_prob0PRofDiff,
                                                                                           m_profitDiff,
                                                                                           vNRow))
```

```{r}
df_profitGR %>%
  filter(year %in% vYearsFull[1:8]) %>%
  ggplot() +
  geom_point(aes(x = profitProb0, y = profit)) +
  xlim(-0.025,0.025)
```

```{r}
df_profitGR %>%
  #group_by(year) %>%
  mutate(profitM = if_else(profitProb0 > 0.01, profit, 0)) %>%
  summarise(profit = mean(profit),
            profitM = mean(profitM),
            diff = profitM- profit)
```





```{r}
df_profitGR %>%
  filter(year %in% vYearsFull[9:11]) %>%
  group_by(year) %>%
  mutate(profitM = if_else(fit > 0, profit, 0)) %>%
  summarise(profit = mean(profit),
            profitM = mean(profitM),
            diff = profitM- profit)
```



```{r}
vVariables
df_CoefStabilityC %>%
  #filter(vVariable == "probTS") %>%
  ggplot() +
  geom_point(aes(x = prob0, y = weight, color = vVariable))

df_CoefStabilityC %>%
  #filter(vVariable == "probTS") %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profitDiff, color = vVariable)) +
  ylim(-.02,0.02)
```

```{r}
df_daily %>%
  ggplot() +
  geom_point(aes(x = prob0, y = profit), color = "chocolate") 
```


## Checking result

### PLot
```{r}
branch <- paste0("./plots/eda/prob0/")
if (!file.exists(branch)) {
                dir.create(branch)
}

for (vStrategy in vStrategies) {
  branch <- paste0("./plots/eda/prob0/",vStrategy,"/")
  if (!file.exists(branch)) {
                dir.create(branch)
}
}

vYears <- unique(df_daily$year)

for (vStrategy in vStrategies) {
  branch <- paste0("./plots/eda/prob0/",vStrategy,"/")
  for (vYear in vYears) {
  
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    filter(year == vYear) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = profit)) +
    ggtitle(paste0(vStrategy," in ",vYear))
  
  saveGGplot(sGGplot,branch,vYear)
  }
}
opendir(branch)
```

### Table
```{r, warning=F, message=F}
vProb0s <- seq(from = 0.01, to = 1, by = 0.01)
df_Prob0Profits <- data.frame(strategy = character(),
                              prob0 = double(),
                              profitMean = double(), 
                              profitTSMean = double(),
                              n = integer(),
                              bootstrap = integer())

df_daily$index <- 1:nrow(df_daily)
for (vProb0 in vProb0s) {
  # bootstraping
  for (boot in 1:10) {
    df_index <- df_daily %>%
      #filter(year %in% vYears) %>%
      group_by(strategy) %>%
      summarise(start = min(index),stop = max(index),strategy = strategy[1]) %>%
      group_by(strategy) %>%
      summarise(index = sample(start:stop, stop-start, replace = T))
    vIndex <- intersect(which(df_daily$prob0 <= vProb0),df_index$index)
    
    if (length(vIndex) == 0) next
    df_Prob0Profit <- df_daily[vIndex,] %>%
      group_by(strategy) %>%
      summarise(strategy = as.character(strategy[1]), 
                prob0 = vProb0,
                profitMean = mean(profit),
                n = n(),
                bootstrap = boot)
    
    #df_Prob0Profit$year <- as.character(df_Prob0Profit$year)
    df_Prob0Profits <- dplyr::bind_rows(list(df_Prob0Profits,df_Prob0Profit))
  }
}

df_Prob0Profits$strategy <- as.factor(df_Prob0Profits$strategy)
#df_Prob0Profits$year <- as.factor(df_Prob0Profits$year)

df_Prob0Profits <- df_Prob0Profits %>%
  group_by(strategy,bootstrap) %>%
  mutate(freq = n/max(n),
         totalProfit = n*profitMean)

df_Prob0 <- df_Prob0Profits %>%
  group_by(prob0) %>%
  summarise(prob0 = prob0[1],
            profitMean = mean(profitMean),
            totalProfit = mean(totalProfit),
            freq = mean(freq))

vProb0 <- df_Prob0[which.max(df_Prob0$totalProfit),"prob0"][[1]]


df_profit <- df_daily %>%
  mutate(profitProb0 = if_else(prob0 <= vProb0, profit, 0)) %>%
  group_by(strategy, year, month) %>%
  summarise(profit = sum(profit),
            profitProb0 = sum(profitProb0),
            Prob0 = vProb0)

df_profit %>%
  group_by(strategy) %>%
  summarise(profit = sum(profit),
            profitProb0 = sum(profitProb0),
            vProb0)

df_profit$year <- as.numeric(as.character(df_profit$year))
df_profit <- df_profit %>%
  mutate(diff = (profitProb0-profit),
         forecast = if_else(year %in% vYears, F, T))

df_profit
vYears

bayes_inference(y = diff, x = forecast, data = df_profit, 
                statistic = "mean", 
                type = "ht", alternative = "twosided", null = 0, 
                prior = "JZS", rscale = 1, 
                method = "theoretical", show_plot = T)

bayes_inference(y = diff, data = df_profit, 
                statistic = "mean", 
                type = "ci", alternative = "twosided", null = 0, 
                prior = "JZS", rscale = 1, 
                method = "theoretical", show_plot = T)
```

















```{r}
branch <- paste0("./plots/eda/prob0cum/")
if (!file.exists(branch)) {
                dir.create(branch)
}

for (vStrategy in vStrategies) {
  
  sGGplot <- df_Prob0Profits %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = profitMean, color = as.factor(bootstrap) )) +
    ggtitle(paste0("Mean profit for ",vStrategy))
  saveGGplot(sGGplot,branch,paste0("MeanProfit_",vStrategy))
  
  sGGplot <- df_Prob0Profits %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = totalProfit, color = as.factor(bootstrap))) +
    ggtitle(paste0("Total profit for ",vStrategy))
  
  saveGGplot(sGGplot,branch,paste0("TotalProfit_",vStrategy))

}
opendir(branch)
```

# Combine strategy

## Read prob0Gr

```{r}
# Read csv
vStrategiesFGr <- c()
l_StrategiesFGr <- list()
vPath <- "./data/output/"
vFiles <- list.files(vPath, pattern = ".csv"); vFiles <- grep("Int", vFiles, value = T)
vFiles <- vFiles[-grep("daily", vFiles)]

for(vFile in vFiles) {
        vDfName <- gsub("profit_","",vFile)
        vStrategiesFGr[length(vStrategiesFGr)+1] <- vDfName
        l_StrategiesFGr[[vDfName]] <- read.csv(paste0(vPath,vFile))
}
df_StrategiesFGr <- dplyr::bind_rows(l_StrategiesFGr)
```

```{r}
df_StrategiesFGr %>%
  group_by(year) %>%
  summarise(profit = mean(profit),
            profitProb0 = mean(profitProb0, na.rm = T),
            diff = (profitProb0-profit))
```

## Stat diff

```{r}
library(BayesFactor)
source("./scripts/bayes/bayes_inference.R")
source("./scripts/bayes/bayes_util.R")
source("./scripts/bayes/bayes_single_mean_JZS.R")
source("./scripts/bayes/bayes_two_mean.R")
```

```{r}
str(df_StrategiesFGr)
```

```{r}
df_StrategiesFGr <- df_StrategiesFGr %>%
  mutate(diff = (profitProb0-profit),
         forecast = if_else(year > 2015, T, F))
```


```{r}
bayes_inference(y = diff, x = forecast, data = df_StrategiesFGr, 
                statistic = "mean", 
                type = "ci", alternative = "twosided", null = 0, 
                prior = "JZS", rscale = 1, 
                method = "theoretical", show_plot = T)
```

```{r}
vIndex <- which(df_StrategiesFGr$year <= 2015)
bayes_inference(y = diff, data = df_StrategiesFGr[vIndex,], 
                statistic = "mean", 
                type = "ci", alternative = "twosided", null = 0, 
                prior = "JZS", rscale = 1, 
                method = "theoretical", show_plot = T)
```



## Read df_daily

```{r}
# Read csv
vStrategiesF <- c()
l_StrategiesF <- list()
vPath <- "./data/output/"
vFiles <- list.files(vPath, pattern = ".csv")
vFiles <- grep("Int", vFiles, value = T)
vFiles <- grep("daily", vFiles, value = T)

for(vFile in vFiles) {
        vDfName <- gsub("profit_daily_","",vFile)
        vStrategiesF[length(vStrategiesF)+1] <- vDfName
        l_StrategiesF[[vDfName]] <- read.csv(paste0(vPath,vFile))
}

vNColToSelect <- c("date","strategy","profit","tradestop","prob0","year","month","wday")
for (vStrategyF in vStrategiesF) {
        l_StrategiesF[[vStrategyF]] <- l_StrategiesF[[vStrategyF]][,vNColToSelect]
}

df_StrategiesF <- dplyr::bind_rows(l_StrategiesF)
df_StrategiesF$date <- as.POSIXct(df_StrategiesF$date)

df_StrategiesF$start <- unlist(strsplit(as.character(df_StrategiesF$strategy),"_"))[(as.numeric(row.names(df_StrategiesF))-1)*4+as.numeric(row.names(df_StrategiesF))+1]
df_StrategiesF$start <- as.factor(df_StrategiesF$start)
```

# Grouping

```{r, warning=F, message=F}
vStrategies <- unique(df_StrategiesF$strategy)
df_profits <- data.frame(strategy = character(),
                         year = integer(),
                         month = integer(),
                         prob0 = double(),
                         profit = double(),
                         profitProb0 = double())

vProb0s <- seq(from = 0.01, to = 1, by = 0.01)

for (vStrategy in vStrategies) {
  df_dailyTS <- df_StrategiesF %>%
    filter(strategy == vStrategy)
  df_dailyTS$index <- as.numeric(row.names(df_dailyTS))
  vLength <- nrow(df_dailyTS)
  
  df_Prob0Profits <- data.frame(strategy = character(),
                                prob0 = double(),
                                profitMean = double(), 
                                n = integer(),
                                bootstrap = integer())

for (vProb0 in vProb0s) {
  
  for (boot in 1:10) {
  df_index <- df_dailyTS %>%
    summarise(index = sample(index, vLength, replace = T))
  vIndex <- intersect(which(df_dailyTS$prob0 <= vProb0),df_index$index)
  
  if (length(vIndex) == 0) next
  
  df_Prob0Profit <- df_dailyTS[vIndex,] %>%
    summarise(strategy = as.character(strategy[1]), 
              prob0 = vProb0,
              profitMean = mean(profit),
              n = n(),
              bootstrap = boot)
  
  df_Prob0Profits <- dplyr::bind_rows(list(df_Prob0Profits,df_Prob0Profit))
  }
  }

df_Prob0Profits$strategy <- as.factor(df_Prob0Profits$strategy)
df_Prob0Profits <- df_Prob0Profits %>%
  group_by(strategy,bootstrap) %>%
  mutate(freq = n/max(n),
         totalProfit = n*profitMean)

df_Prob0 <- df_Prob0Profits %>%
  group_by(prob0) %>%
  summarise(prob0 = prob0[1],
            profitMean = mean(profitMean),
            totalProfit = mean(totalProfit),
            freq = mean(freq))

vProb0 <- df_Prob0[which.max(df_Prob0$totalProfit),"prob0"][[1]]

df_profit <- df_dailyTS %>%
  mutate(profitProb0 = if_else(prob0 <= vProb0, profit, 0)) %>%
  group_by(strategy, year, month) %>%
  summarise(profit = sum(profit),
            profitProb0 = sum(profitProb0),
            prob0 = vProb0)

df_profits <- dplyr::bind_rows(list(df_profits,df_profit))

print(vStrategy)
}
```


```{r}
df_profitsGr <- df_profits %>%
  group_by(strategy) %>%
  summarise(bestProb0 = prob0[1],
            profitSD = sd(profit, na.rm = T),
            profit = mean(profit, na.rm = T),
            profitProb0SD = sd(profitProb0, na.rm = T),
            meanProfitByProb0 = mean(profitProb0, na.rm = T),
            diff = meanProfitByProb0 / profit)
```


```{r}
df_StrategiesFM <- merge(df_StrategiesF,df_profitsGr[,c("strategy", "bestProb0", "meanProfitByProb0")],by = "strategy", all.x = TRUE)
head(df_StrategiesFM)
```

```{r}
df_StrategiesFM <- df_StrategiesFM %>%
  mutate(tradeAllowed = if_else(prob0 <= bestProb0, T, F)) %>%
  mutate(profitTA = if_else(tradeAllowed == T, profit, 0)) %>%
  mutate(meanProfitByProb0TA = if_else(tradeAllowed == T, meanProfitByProb0, 0))
head(df_StrategiesFM)
```



```{r}
df_StrategiesFMR <- df_StrategiesFM %>%
  group_by(start, date) %>%
  mutate(sumMeanProfitByProb0TA = sum(meanProfitByProb0TA, na.rm = T)) %>%
  mutate(freq = (meanProfitByProb0TA)/(sumMeanProfitByProb0TA)) %>%
  mutate(freq = if_else(sumMeanProfitByProb0TA == 0, 0, freq)) %>%
  mutate(profitM = profit*freq) %>%
  group_by(start, year, month) %>%
  summarise(profitM = sum(profitM, na.rm = T),
            profit = mean(profit, na.rm = T))

df_StrategiesFMR %>%
  group_by(start, year) %>%
  summarise(profitM = sum(profitM),
            profit = sum(profit)*20)
```

```{r}
df_StrategiesFM %>%
  group_by(strategy) %>%
  mutate(profitTA = if_else(tradeAllowed == T, profit, 0),
         nTA = if_else(tradeAllowed == T, 1, 0)) %>%
  summarise(profit = sum(profit, na.rm = T),
            profitTA = sum(profitTA, na.rm = T),
            n = n(),
            nTA = sum(tradeAllowed))
```

```{r}
df_StrategiesFM %>%
  group_by(start, date, tradeAllowed) %>%
  summarise(profitM = sum(profit.x*profitProb0/sum(profitProb0, na.rm = T), na.rm = T),
            profit = sum(profit.x, na.rm = T),
            n = n(),
            month = month[1],
            year = year[1]) %>%
  mutate(profitM = if_else(tradeAllowed == T, profitM, 0)) %>%
  group_by(start, date) %>%
  arrange(start, date) %>%
  summarise(profitM = sum(profitM, na.rm = T),
            profit = sum(profit, na.rm = T)/sum(n, na.rm = T),
            month = month[1],
            year = year[1]) %>%
  group_by(start) %>%
  summarise(profitM = sum(profitM),
            profit = sum(profit))
```































