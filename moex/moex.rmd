---
title: "moex"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
# Setup
```{r setup, include=FALSE}
options(digits = 4)
options(scipen = 999)

library(statsr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)

source("./scripts/saveGGplot.r")
source("./scripts/opendir.r")
```

# Data

## Strategy
```{r}
# source("./scripts/get_strategies.r")
# df_strategy <- get_strategies()
# write.csv(x=df_strategy, file="./data/strategy/strategy.csv", row.names = F)
```

```{r}
df_strategy <- read.csv("./data/strategy/strategy.csv",
                        colClasses = c("factor","POSIXct","numeric","integer", "factor",
                                       rep("numeric",6),rep("factor",3)))
# str(df_strategy)
```


## Work set
```{r}
vYears <- c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018")

df_daily <- df_strategy %>%
  filter(year %in% vYears[1:12])
df_daily$index <- row.names(df_daily)

vStrategies <- unique(df_daily$strategy)
```

## MOEX

### read from moex
```{r}
# source("./scripts/get_turnover_moex.r")
# df_moex <- get_data_from_moex(startDate = "2012-01-01",endDate = "2020-03-31")
# write.csv(x=df_moex, file="./data/moex.csv")

# source("./scripts/get_index_moex.r")
# l_index_moex <- get_index_moex(startDate = "2008-01-01", endDate = "2020-03-31")
# df_index_moex <- l_index_moex[[1]]
# df_index_moex_readme <- l_index_moex[[2]]
# write.csv(x=df_index_moex, file="./data/index_moex_20080101_20200331.csv")
# write.csv(x=df_index_moex_readme, file="./data/index_moex_readme_20080101_20200331.csv")
```

```{r}
df_turnover_moex     <- read.csv("./data/moex.csv")
df_index_moex        <- read.csv("./data/index_moex_20080101_20200331.csv")
df_index_moex_readme <- read.csv("./data/index_moex_readme_20080101_20200331.csv")
```

# EDA
## PROFIT

## All period

```{r}
ggplot(data = df_daily, aes(x = profit, fill= yday(date))) +
  geom_density(aes(x=profit), color="green4", fill="lightgreen", alpha=.3) +
  ggtitle("Profit distribution by all data") +
  facet_wrap("strategy")
```

## MeanProfit by years

```{r}
df_daily %>%
        group_by(strategy, year) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```

```{r}
df_daily %>%
  group_by(strategy, year) %>%
  summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```


```{r, message=FALSE, warning=FALSE}
branch <- "./plots/eda/meanProfit_by_year/"

for (vStrategy in vStrategies) {
  
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(year) %>%
    summarise(x_bar = mean(profit), x_sd = sd(profit), year = year[1]) %>%
    ggplot() +
    geom_col(aes(y = x_bar, x = year, fill = year), position = 'dodge')
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

sd - profit

```{r,message=FALSE, warning=FALSE}
branch <- "./plots/eda/relationshipSDProfit_and_meanProfit_by_year/"

for (vStrategy in vStrategies) {
  
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(strategy, year) %>%
    summarise(profit_mean = mean(profit), profit_sd = sd(profit),strategy = strategy[1]) %>%
    ggplot(aes(y = profit_mean, x = profit_sd)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle(paste0("Relationship sd & mean profit for ",vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

## Months

```{r}
branch <- "./plots/eda/meanProfit_by_monts/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(month) %>%
    summarise(x_bar = mean(profit), month = month[1]) %>%
    ggplot(aes(y = x_bar, x = month, fill = month)) +
    geom_col(position = 'dodge')

    saveGGplot(sGGplot,branch,vStrategy)
}
#opendir(branch)
```

sd - profit

```{r}
branch <- "./plots/eda/Sd_Profit_by_monts/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(month) %>%
    summarise(profit_mean = mean(profit), profit_sd = sd(profit),strategy = strategy[1]) %>%
    ggplot(aes(y = profit_mean, x = profit_sd)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle(paste0("Relationship sd & mean profit for ",vStrategy))

    saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

## Days

```{r}
df_daily %>%
        group_by(strategy,wday) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```


```{r}
branch <- "./plots/eda/SDProfit_by_days/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(wday) %>%
    summarise(x_bar = mean(profit), wday = wday[1]) %>%
    filter(wday %in% c(1,2,3,4,5)) %>%
    ggplot(aes(y = x_bar, x = wday, fill = wday)) +
    geom_col(position = 'dodge')  +
    ggtitle(paste0("Mean profit by days for ",vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

sd - profit

```{r}
branch <- "./plots/eda/SD_Profit_by_days/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(wday) %>%
    summarise(x_bar = mean(profit), x_sd = sd(profit)) %>%
    ggplot(aes(y = x_bar, x = x_sd)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle(paste0("Sd & mean profit by days for ",vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)

```

## Position

```{r}
df_daily %>%
        group_by(strategy, position) %>%
        summarise(x_bar = mean(profit), x_sd = sd(profit), x_median = median(profit), n = n())
```


```{r}
branch <- "./plots/eda/Profit_by_position/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(position) %>%
    summarise(x_bar = mean(profit), position = position[1]) %>%
    ggplot(aes(y = x_bar, x = position, fill = position)) +
    geom_col(position = 'dodge') +
    ggtitle(paste0("Profit by position for ",vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```


## Trade stop

```{r}
df_daily %>%
        group_by(strategy, tradestop) %>%
        summarise(mean_profit = mean(profit), sd_profit = sd(profit), median_profit = median(profit), n = n())
```


```{r}
branch <- "./plots/eda/Profit_by_TradeStop/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(tradestop) %>%
    summarise(mean_profit = mean(profit), tradestop = tradestop[1]) %>%
    ggplot(aes(y = mean_profit, x = as.factor(tradestop), fill = as.factor(tradestop))) +
    geom_col(position = 'dodge') +
    ggtitle(paste0("Profit by trade stop for ",vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

## TRADE STOP

### Trend
```{r}
branch <- "./plots/eda/TrendForTradeStopProbByMonth/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    group_by(year,month) %>%
    mutate(n = n()) %>%
    filter(tradestop == TRUE) %>%
    summarise(n_stop = n(), n = n[1], freq = n_stop/n,date = ymd(paste(year, month, "01", sep= ' '))) %>%
    ggplot() +
    geom_line(aes(x = date, y = freq), color="darkred") +
    ggtitle(paste0("Trade stop probability calculated by calendar month ",vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

# MA

Создадим таблицу с данными по количеству стоптрейдов за предыдущие N дней.

```{r}
sliding_depth <- 30
vColNames <- c("tradestop","profit","bartime","barprofit","MAE","MFE")

source("./scripts/makePrColForStrategy.r")
df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = "tradestop",
                                 sliding_depth = sliding_depth)
```

## ProbTS

```{r}
for (n in 2:sliding_depth) {
  df_daily[,paste0("tradestop_MA",n)] <- apply(df_daily[,paste0("tradestop_Pr",1:n)],1,sum,na.rm = F)
}
```

Содадим функцию способную посчитать средние веростноти трейдстопа на основе бетта распределений по скользящим средним количеству трейдстопов на текущий день
т.е. например заглядываем на 10 дней вперед смотрим количество трейдстопов и на этих данных моделируем распределение, затем по этому рапределению считаем среднее значение и его и записываем

```{r}
get_MeanBetaDist <- function(df,col_names) {
  mean_rbeta <- function(x, col_name) {
  # calculating sliding depth
  n <- as.integer(sub("tradestop_MA|tradestop_MA","",col_name))
  # return mean of rbeta distribution
  shape1 = as.integer(x[col_name])
  shape2 = n-as.integer(x[col_name])
  mean(rbeta(1000, shape1 = shape1, shape2 = shape2))
  }
  
  for (col_name in col_names) {
    df[,paste0("prob_",col_name)] <- apply(df_daily, 1, FUN = function(x) mean_rbeta(x,col_name))  
  }
  
  df
}
```

Посчитаем средние вероятности трейдстопа по скользящим средним. Применим созданную функцию.
```{r, message=F,warning=F}
df_daily <- get_MeanBetaDist(df = df_daily, col_names = paste0("tradestop_MA",2:sliding_depth))
df_daily$probTS <- apply(df_daily[,paste0("prob_tradestop_MA",2:sliding_depth)],1,mean,na.rm = F)

drops <- c(paste0("tradestop_Pr",1:sliding_depth),
           paste0("tradestop_MA",2:sliding_depth),
           paste0("prob_tradestop_MA",2:sliding_depth))

df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
```

```{r}
# ProbTS density
branch <- "./plots/eda/ProbTS_Density/"
for (vStrategy in vStrategies){
  
  index_ts <- which(df_daily$tradestop == T & df_daily$strategy == vStrategy)
  sGGplot <- ggplot() +
    geom_density(data = df_daily[-index_ts,], aes(x=probTS), color = "darkgreen", fill="green", alpha=.3) +
    geom_density(data = df_daily[index_ts,], aes(x=probTS), color = "darkred", fill="red", alpha=.3) +
    ggtitle(paste0("Trade stop probability calculated by calendar month ",vStrategy)) +
    scale_color_manual(values = colors)
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

### Table probTS - realTS

Calculating real cumulative trade stop probability for `probTS` scale. 

```{r}
df_tsprob <- data.frame(mean_probTS = numeric(),
                        mean_profit = numeric(),
                        mean_realTS = numeric(),
                        strategy = character())

# botstraping for each prob level

vStratedies <- unique(df_daily$strategy)

for (strategy in vStratedies) {
  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS >= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }

  for (prob in 1:100) {
    prob_index <- which(df_daily$probTS <= prob / 100 & df_daily$strategy == strategy)
    
    if (length(prob_index >= 10)) {
      df_daily_nona <- na.omit(df_daily[prob_index, ])
      nRow <- nrow(df_daily_nona)
      
      for (n in 1:50) {
        index <- sample(1:nRow, nRow, replace = T)
        df_tsprob <- rbind(df_tsprob, data.frame(
          mean_probTS = mean(df_daily_nona[index, "probTS"][[1]]),
          mean_profit = mean(df_daily_nona[index, "profit"][[1]]),
          mean_realTS = mean(df_daily_nona[index, "tradestop"][[1]]),
          strategy = strategy))
        }
      }
  }
}

# transform data to predicted and ci values
df_tsprob <- df_tsprob %>% 
  group_by(strategy, gr=cut(mean_probTS, breaks = seq(from = 0, to = max(df_tsprob$mean_probTS), length.out = 100) )) %>%
  summarise(n = n(), 
            mean_probTS = mean(mean_probTS),
            pred_realTS = mean(mean_realTS),
            low_realTS = qnorm(c(0.025), mean = mean(mean_realTS), sd = sd(mean_realTS)),
            hight_realTS = qnorm(c(0.975), mean = mean(mean_realTS), sd = sd(mean_realTS))) %>%
  filter(!is.na(pred_realTS))

df_tsprob <- df_tsprob %>%
  mutate(low_realTS = case_when(low_realTS < 0 ~ 0,
                                low_realTS > 1 ~ 1,
                                TRUE ~ low_realTS),
         hight_realTS = case_when(hight_realTS < 0 ~ 0,
                                hight_realTS > 1 ~ 1,
                                TRUE ~ hight_realTS))
rm(df_daily_nona)
```

```{r}
branch <- "./plots/eda/MAProbTS_RealProbTS_with_CI/"
for (vStrategy in vStrategies){
  sGGplot <- df_tsprob %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = mean_probTS, y = pred_realTS)) +
    geom_point(aes(x = mean_probTS, y = low_realTS)) +
    geom_point(aes(x = mean_probTS, y = hight_realTS)) +
    ggtitle(paste0("Relationship between MAProbTS & RealProbTS with CI for ",vStrategy)) +
    ylab("RealProbTS") +
    xlab("MAProbTS")

  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

### RealProbTS 

Correspond MAProbTS & RealProbTS in historical data.

```{r}
get_realCI95probTSbyMAprob <- function(prob, df_tsprob) {
  if (is.nan(prob) == T) {
    data.frame("pred_realTS" = NA,
               "low_realTS" = NA,
               "hight_realTS" = NA)
    
  } else {
      index <- which.min(abs(df_tsprob$mean_probTS-prob))
      df_tsprob[index,c("pred_realTS","low_realTS","hight_realTS")]
  }
}

df_daily$RealProbTS       <- as.numeric(NA)
df_daily$RealProbTS_low   <- as.numeric(NA)
df_daily$RealProbTS_hight <- as.numeric(NA)

for (index in 1:nrow(df_daily)) {
  strategy <- df_daily[index,"strategy"][[1]]
  realTS95CI <- get_realCI95probTSbyMAprob(df_daily[index,"probTS"][[1]], 
                                           df_tsprob = df_tsprob[which(df_tsprob$strategy == strategy),])
  df_daily[index,"RealProbTS"] <- realTS95CI[1,"pred_realTS"][[1]]
  df_daily[index,"RealProbTS_low"] <- realTS95CI[1,"low_realTS"][[1]]
  df_daily[index,"RealProbTS_hight"] <- realTS95CI[1,"hight_realTS"][[1]]
}
```

```{r}
branch <- "./plots/eda/RealProbTS TimeLine/"
for (vStrategy in vStrategies){
  sGGplot <- df_daily %>%
    filter(strategy == vStrategy) %>%
    ggplot() +
    geom_point(aes(x = date, y = RealProbTS)) +
    ggtitle(paste0("Trade stop probability timeline for ",vStrategy))
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

## Pred, low & hight value for variabels base on MA

```{r}
vColNames <- c("profit", "bartime", "barprofit", "MAE", "MFE", "entryprice", "exitprice")
df_daily <- makePrColForStrategy(df_strategy = df_daily,
                                 vColNames = vColNames,
                                 sliding_depth = sliding_depth)
# creating MA
for (vColName in vColNames) {
  for (n in 2:sliding_depth) {
    df_daily[,paste0(vColName,"_SDMA",n)]   <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,sd,  na.rm = F)
    df_daily[,paste0(vColName,"_meanMA",n)] <- apply(df_daily[,paste0(vColName,"_Pr",1:n)],1,mean,na.rm = F)
  }
  # del _Pr columns
  drops <- c(paste0(vColName,"_Pr",1:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  
  df_daily[,paste0(vColName,"_SDSD")]   <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_SDmean")] <- apply(df_daily[,paste0(vColName,"_SDMA",    2:sliding_depth)],1,mean,na.rm = F)
  df_daily[,paste0(vColName,"_meanSD")]   <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,sd,  na.rm = F)
  df_daily[,paste0(vColName,"_meanmean")] <- apply(df_daily[,paste0(vColName,"_meanMA",2:sliding_depth)],1,mean,na.rm = F)
  
  # del _MA columns
  drops <- c(paste0(vColName,"_SDMA",  2:sliding_depth),
             paste0(vColName,"_meanMA",2:sliding_depth))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
}

for (vColName in vColNames) {
  df_daily[,paste0(vColName,"_pred")]   <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_low")]   <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  df_daily[,paste0(vColName,"_hight")]   <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_meanmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_meanSD")][[1]])
  
  df_daily[,paste0(vColName,"_predSD")] <- qnorm(c(0.5),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_lowSD")] <- qnorm(c(0.025),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  df_daily[,paste0(vColName,"_hightSD")] <- qnorm(c(0.975),
                                                 mean = df_daily[,paste0(vColName,"_SDmean")][[1]],
                                                 sd =   df_daily[,paste0(vColName,"_SDSD")][[1]])
  # del _MA columns
  drops <- c(paste0(vColName,"_meanmean"),
             paste0(vColName,"_meanSD"),
             paste0(vColName,"_SDmean"),
             paste0(vColName,"_SDSD"))
  df_daily <- df_daily[ , !(names(df_daily) %in% drops)]
  }
```

# ProfitTS
## ProfitTS distribution

```{r}
summary(df_daily$profit)
```

```{r}
df_dailyTS <- na.omit(df_daily)

df_TSprofit <- df_dailyTS %>%
  filter(tradestop == 1) %>%
  group_by(strategy) %>%
  summarise(TSprofit = mean(profit))

df_dailyTS <- merge(df_dailyTS, df_TSprofit, by = "strategy", all.x = T)

df_dailyTS <- df_dailyTS %>%
  mutate(profitTS = case_when(tradestop == 1 ~ TSprofit*RealProbTS,
                              TRUE ~ profit+TSprofit*RealProbTS))
drops <- c("TSprofit")
df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) %in% drops)]
```


```{r}
branch <- "./plots/eda/expected profit distribution/"
for (vStrategy in vStrategies){
  sGGplot <- df_dailyTS %>%
    filter(strategy == vStrategy) %>%
    ggplot() + 
    geom_density(aes(x = profitTS), color="darkred", fill="#FF6666", alpha=.3) +
    ggtitle(paste0("Expected profit distribution (profitTS) for ", vStrategy))
  
  saveGGplot(sGGplot,branch,vStrategy)
}
opendir(branch)
```

## RealProbTS-ProfitTS

```{r}
names(df_dailyTS)
```

# sGGplot for numeric variable
## profitTS
```{r, message=FALSE}
branch <- paste0("./plots/eda/profitTS/")
if (!file.exists(branch)) {
                dir.create(branch)
}

vVariables <- names(df_dailyTS)[c(6:7,16:61)]
df_dailyTS$sumVariable <- as.numeric(NA)

for (vStrategy in vStrategies) {
  indexSTR <- which(df_dailyTS$strategy == vStrategy)
  
  for (vVariable in vVariables) {
    
    vMin <- min(df_dailyTS[indexSTR,vVariable], na.rm = T)
    vMax <- max(df_dailyTS[indexSTR,vVariable], na.rm = T)
    
    df_dailyTS[,"gr"] <- NA
    df_dailyTS[indexSTR,"gr"] <- cut(df_dailyTS[indexSTR,vVariable], 
                                     breaks = seq(from = vMin,
                                                  to = vMax,
                                                  length.out = 50))
    df_dailyTS[indexSTR,"sumVariable"] <- df_dailyTS[indexSTR,vVariable]
    
    branch <- paste0("./plots/eda/profitTS/",vVariable,"/")
    sGGplot <- df_dailyTS[indexSTR,] %>% 
      group_by(gr) %>%
      summarise(sumVariable = mean(sumVariable),
                profitTS = mean(profitTS)) %>%
      filter(!is.na(sumVariable)) %>%
      ggplot(aes(x = sumVariable, y = profitTS)) +
      geom_point(size=5) +
      ggtitle(paste0("Relationship between ",vVariable," & profitTS for ", vStrategy)) +
      xlab(vVariable) +
      ylab("profitTS")
    
    saveGGplot(sGGplot,branch,vStrategy)
  }
}
```

## profit
```{r, message=FALSE}
branch <- paste0("./plots/eda/profit/")
if (!file.exists(branch)) {
                dir.create(branch)
}

vVariables <- names(df_dailyTS)[c(6:7,16:61)]
df_dailyTS$sumVariable <- as.numeric(NA)

for (vStrategy in vStrategies) {
  indexSTR <- which(df_dailyTS$strategy == vStrategy)
  
  for (vVariable in vVariables) {
    
    vMin <- min(df_dailyTS[indexSTR,vVariable], na.rm = T)
    vMax <- max(df_dailyTS[indexSTR,vVariable], na.rm = T)
    
    df_dailyTS[,"gr"] <- NA
    df_dailyTS[indexSTR,"gr"] <- cut(df_dailyTS[indexSTR,vVariable], 
                                     breaks = seq(from = vMin,
                                                  to = vMax,
                                                  length.out = 50))
    df_dailyTS[indexSTR,"sumVariable"] <- df_dailyTS[indexSTR,vVariable]
    
    branch <- paste0("./plots/eda/profit/",vVariable,"/")
    sGGplot <- df_dailyTS[indexSTR,] %>% 
      group_by(gr) %>%
      summarise(sumVariable = mean(sumVariable),
                profitTS = mean(profitTS)) %>%
      filter(!is.na(sumVariable)) %>%
      ggplot(aes(x = sumVariable, y = profitTS)) +
      geom_point(size=5) +
      ggtitle(paste0("Relationship between ",vVariable," & profit for ", vStrategy)) +
      xlab(vVariable) +
      ylab("profitTS")
    
    saveGGplot(sGGplot,branch,vStrategy)
  }
}
```





# Decision-making section

## Grouping

```{r}
df_groups <- data.frame(strategy = character(),
                        variableName = character(),
                        variableFactor = character(),
                        variableValue = double(),
                        profitMean = double(),
                        ProfitSD = double(),
                        n = integer())


vVariables <- names(df_dailyTS)[c(13:14,16:61)]

for (vVariable in vVariables) {
  df_dailyTS[,"variable"] <- df_dailyTS[,vVariable]
  df_dailyTS <- df_dailyTS[ , !(names(df_dailyTS) == "sumVariable")]

  # create grouping variable
  if (is.numeric(df_dailyTS[,"variable"][[1]])) {
  
  # for numeric
  df_dailyTS <- df_dailyTS %>%
    group_by(strategy) %>%
    mutate(minCutVariable = min(variable, na.rm = T),
           maxCutVariable = max(variable, na.rm = T)) %>%
    group_by(strategy,
             sumVariable = cut(variable,
                               breaks = seq(from = minCutVariable[1],
                                            to = maxCutVariable[1],
                                            length.out = 11))) 
  } else {
    df_dailyTS$sumVariable <- df_dailyTS[,"variable"]
  }

  # summary
  df_group <- df_dailyTS %>%
    group_by(strategy, sumVariable) %>%
    summarise(variableName = vVariable,
              variableValue  = if_else(is.numeric(variable) == T, mean(variable), 0),
              variableFactor = if_else(is.numeric(variable) == T, "numeric", as.character(variable[1])),
              profitMean = mean(profitTS),
              ProfitSD = sd(profitTS),
              n = n())
  df_group <- df_group[ , !(names(df_group) == "sumVariable")]
  df_group$strategy <- as.character(df_group$strategy)

  # united
  df_groups <- dplyr::bind_rows(list(df_groups, df_group))
}

# calculate prob0
df_groups <- df_groups %>%
  mutate(profitSE = ProfitSD/sqrt(n),
         t0 = 0 - profitMean/profitSE,
         prob0 = round(pt(t0, (n-1)),4))

head(df_groups)
```

## Full table


```{r}
vVariables <- names(df_dailyTS)[c(6,13:14,16:61)]

get_prob0 <- function(vRow,vVariables,df_groups) {
  
  vStrategy <- vRow[["strategy"]]
  df_GrStr <- df_groups[which(df_groups$strategy == vStrategy),]
  df_prob0 <- data.frame(variableName = character(),
                         prob0 = double())
  
  for (vVariable in vVariables) {
    vValue <- as.numeric(vRow[[vVariable]])
    
    df_GrStrVar <- df_GrStr[which(df_GrStr$variableName == vVariable),
                            c("variableValue","prob0")]
    
    if (is.factor(vVariable)) {
      index <- which(df_GrStrVar$variableFactor == vValue)
    } else {
      index <- which.min(abs(df_GrStrVar$variableValue-vValue))
    }
    
    if (length(index) != 0) {
      
    prob0 <- df_GrStrVar[index,"prob0"]
    df_prob0 <- dplyr::bind_rows(list(df_prob0, data.frame(variableName = vVariable,
                                                           prob0 = prob0)))
    }
    
    
  }
  mean(df_prob0$prob0)
}

df_dailyTS[,"prob0"] <- apply(df_dailyTS, 1, FUN = function(x) get_prob0(x,vVariables,df_groups))  
```


## Checking result

```{r}
branch <- paste0("./plots/eda/prob0/")
if (!file.exists(branch)) {
                dir.create(branch)
}

for (vStrategy in vStrategies) {
  branch <- paste0("./plots/eda/prob0/",vStrategy,"/")
  if (!file.exists(branch)) {
                dir.create(branch)
}
}

branch <- "./plots/eda/meanProfit_by_year/"
vYears <- unique(df_dailyTS$year)

for (vStrategy in vStrategies) {
  branch <- paste0("./plots/eda/prob0/",vStrategy,"/")
  for (vYear in vYears) {
  
  sGGplot <- df_dailyTS %>%
    filter(strategy == vStrategy) %>%
    filter(year == vYear) %>%
    ggplot() +
    geom_point(aes(x = prob0, y = profitTS)) +
    ggtitle(paste0(vStrategy," in ",vYear))
  
  saveGGplot(sGGplot,branch,vYear)
  }
}
opendir(branch)

```



```{r, warning=F, message=F}
df_dailyTS <- df_dailyTS %>%
  mutate(prob0 = (prob0_wday + prob0_month + prob0_SDPRF+prob0_RealProbTS)/4)

prob0Level <- 0.20
df_profitM <- df_dailyTS %>%
  filter(prob0 < prob0Level) %>%
  group_by(year) %>%
  summarise(profitM = mean(profit), nM = n())

df_profitT <- df_dailyTS %>%
  group_by(year) %>%
  summarise(profitT = mean(profit), nT = n())

df_profit <- merge(df_profitM,df_profitT,by = "year", all = TRUE)

df_profit <- df_profit %>%
  mutate(freq = round(nM/nT,2),
         dif = profitM/profitT) 

summary(df_profit)
```

