---
title: "moex_new"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

# Setup
```{r setup, include=FALSE}
options(digits = 4)
options(scipen = 999)

library(statsr)
library(plyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)
library(FNN)
library(BayesFactor)
library(gridExtra)
library(foreach)
library(doParallel)

source("./scripts/bayes/bayes_inference.R")
source("./scripts/bayes/bayes_util.R")
source("./scripts/bayes/bayes_single_mean_JZS.R")
source("./scripts/bayes/bayes_two_mean.R")

source("./scripts/saveGGplot.r")
source("./scripts/opendir.r")
source("./scripts/makePrColForStrategy.r")
source("./scripts/get_workset.R")
source("./scripts/get_NormalDistForvard.r")
source("./scripts/get_NormalDist.r")
source("./scripts/get_df_unique_variabels.r")
source("./scripts/get_separate_index.r")
source("./scripts/get_df_unique_variabels.r")
source("./scripts/convert_l_var_to_df_var.r")
#source("./scripts/normalizeXtrainXtest.R")
source("./scripts/create_X_y.R")
source("./scripts/paste_summary.R")
source("./scripts/create_vector_dates.R")
source("./scripts/get_sample_date_index.R")
source("./scripts/get_separate_index.r")
source("./scripts/get_primary_summary.r")
source("./scripts/get_vote_summary_parallel.r")
source("./scripts/get_vote_train_summary_parallel.r")
source("./scripts/create_lxy_train1_train2.r")
source("./scripts/culculate_NPV.r")
source("./scripts/get_topVars.r")
source("./scripts/get_df_best_n_by_npv.r")
source("./scripts/get_df_lev4.r")
source("./scripts/get_cumulative_profit.r")





source("./scripts/paste_primary_summary_parallel.r")
source("./scripts/get_vote_summary_parallel.r")
```

# Data
```{r}
# df_moex_previous   <- get_NormalDist(df_daily = df_profit, vColName = vColNames_moex,
#                                       sliding_depth = 50, slidind_return = c(10,25,50))
# df_moex_previous$date <- df_profit$date
```

```{r}
df_strategy <- read.csv("./data/strategy/strategy.csv",
                        colClasses = c("factor","POSIXct","numeric","integer", "factor",
                                       rep("numeric",6),rep("factor",3)))

vStrategiesAll <- unique(df_strategy$strategy)
```



```{r}
df_strategy %>%
  group_by(strategy) %>%
  summarise(profit = mean(profit, rm.na = T)) %>%
  arrange(desc(profit))
```

```{r}
l_strategies <- list()
```


Previos MA by vColNames
```{r, warning=FALSE, message=FALSE}
vStrategies <- c("SL_14_18_RTS_Int02",'SL_14_18_RTS_Int015',"SL_14_18_RTS_Int01","SL_14_18_RTS_Int005",'SL_14_18_RTS_Int001')

l_str_save <- list()

for (vStrategy in vStrategies) {
  df_profit <- get_WorkSet(vStrategy)

df_profit_forvard <- get_NormalDistForvard(df_daily = df_profit, vColName = 'profit', sliding_depth = 50)
vColNames_strategy <- colnames(df_profit)[c(3:4,6:11)]
vColNames_moex     <- colnames(df_profit)[c(16:60)]
df_profit_previous <- get_NormalDist(df_daily = df_profit, vColName = vColNames_strategy,
                                     sliding_depth = 50, slidind_return = c(10,25,50))
df_profit_previous$date <- df_profit$date

df_profitPrAll <- merge(df_profit_previous,df_moex_previous, all.x = TRUE, by = "date")

# vVariables
vVariables <- unique(colnames(df_profitPrAll))
vVariables <- vVariables[which(!(vVariables %in% c("date","profit","profit_by_day",
                                                   "best_lev_profit_pred_next_10","profit_pred_next_10")))]
df_unique_variabels <- get_df_unique_variabels(vVariables)
df_unique_variabels <- df_unique_variabels[df_unique_variabels$calculated == 0,]


df_strategy_vote <- df_profit[,c('strategy','date','profit')]

vProfitsNext <- c(20,25,30,35)
for (vProfitNext in vProfitsNext) {
  
df_profitPr <- df_profitPrAll
df_profitPr[,'profit'] <- df_profit_forvard[,paste0('profit_mean_Next_',vProfitNext)]
df_profitPr$date <- ymd(df_profitPr$date)
df_profitPr$profit_by_day <- df_profit$profit

##########
##########
## Vars
##########
l_vars <- list()
vSizeGroup <- 1000
nGroups <- ceiling(nrow(df_unique_variabels)/vSizeGroup)
vDates <- create_vector_dates()
index <- df_profitPr$date < vDates[1]
for (n_group in 1:nGroups) {
  
  startindex <- ((n_group-1)*vSizeGroup)
  endindex <- ((n_group*vSizeGroup)-1)
  if (endindex > nrow(df_unique_variabels)) {
    endindex <- nrow(df_unique_variabels)
  }
  df_unique_variabels_selected <- df_unique_variabels[startindex:endindex,]
  
  l_var_parallel <- paste_primary_summary_parallel(date = vDates[1],
                                                   df_variabels = df_unique_variabels_selected,
                                                   df_profit = df_profitPr[index,])
  l_vars[length(l_vars)+1] <- list(convert_l_var_to_df_var(l_var = l_var_parallel))
  df_unique_variabels[startindex:endindex,'calculated'] <- 1
  #print(n_group/nGroups)
}

# Shoose varibels
df_topVars <- get_topVars(l_vars = l_vars)

####################################################
# Vouting ##########################################
####################################################

##########
##########
## Lev1
##########
vVoteIndex <- which(df_profitPr$date >= vDates[1])
l_vote_summary_parallel <- get_vote_summary_parallel(df_profitPr = df_profitPr,
                                                     df_topVars = df_topVars,
                                                     vVoteIndex = vVoteIndex,
                                                     core = 3,
                                                     days_lag = (vProfitNext+1))
df_vote_test_summary_parallel  <- as.data.frame(do.call(rbind,l_vote_summary_parallel))

df_vote_train_summary_parallel <- get_vote_train_summary_parallel(df_profitPr = df_profitPr,
                                                                  df_topVars = df_topVars,
                                                                  date = vDates[1],
                                                                  days_lag = (vProfitNext+1))

df_vote_summary_parallel <- rbind(df_vote_train_summary_parallel,df_vote_test_summary_parallel)

df_profitPr <- merge(df_profitPr, df_vote_summary_parallel,
                        all.x = TRUE, by.x = c("date"), by.y = c("date"))

df_profitPr$profit_pred <- 0
df_profitPr <- df_profitPr %>%
  arrange(date)
rownames(df_profitPr) <- NULL
##########


##########
##########
## Lev2
##########


## TrainPred
vVars = c('prob0_up','prob0_up_sd','scater_prob0_up')
lxy_train <- create_lxy_train1_train2(df_profitPr = df_profitPr,
                                      date = date, vVars = vVars)

profit_pred_1  <- knn.reg(train=lxy_train$l_train_1$X_train,
                        y=lxy_train$l_train_1$y_train,
                        test=lxy_train$l_train_1$X_test,
                        k=10)[['pred']]
profit_pred_2  <- knn.reg(train=lxy_train$l_train_2$X_train,
                        y=lxy_train$l_train_2$y_train,
                        test=lxy_train$l_train_2$X_test,
                        k=10)[['pred']]

df_train <- data.frame('date' = c(lxy_train$l_train_1$date_test,
                                  lxy_train$l_train_2$date_test),
                       'profit_pred' = c(profit_pred_1,
                                         profit_pred_2))

drops <- c('profit_pred')
df_profitPr <- df_profitPr[ , !(names(df_profitPr) %in% drops)]
df_profitPr <- merge(df_profitPr, df_train, all.x = TRUE, by.x = c("date"), by.y = c("date"))

## TestPred
date <- vDates[1]
test_start_index <- which.min(abs(df_profitPr$date - date))+1
for (x in test_start_index:nrow(df_profitPr)) {
  date <- df_profitPr[x,"date"]
  df <- df_profitPr[c(vVars,'profit','date')]
  df[sapply(df, is.nan)] <- NA
  df <- na.omit(df)
  index_tain <- df$date < (date)
  index_predict <- which(df$date == date)
  if (length(index_predict) == 0) {next}
    
  l <- create_X_y(df = df,
                  train_index = index_tain,
                  test_index = index_predict,
                  vVars = vVars)
  
  knn_test  <- knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=10)
  df_profitPr[x,'profit_pred'] <- knn_test[['pred']]
}
##########


##########
##########
## Lev3
##########


df_profitPr$strategy <- "RTS_14_18"
df_profit_lev3 <- makePrColForStrategy(df_strategy = df_profitPr, 
                                       vColNames = 'profit_pred', 
                                       sliding_depth = (vProfitNext-1))
df_profit_lev3 <- cbind(df_profitPr[,c("date","profit","profit_by_day","profit_pred")],
                        df_profit_lev3)
df_profit_lev3$profit_pred_Pr0 <- df_profit_lev3$profit_pred
df_profit_lev3$year <- year(df_profit_lev3$date)
df_profit_lev3$month <- month(df_profit_lev3$date)

df_train <- df_profit_lev3[which(df_profitPr$date < vDates[1]),]
df_npv <- get_df_best_n_by_npv(df_train = df_train, vProfitNext = vProfitNext)
for (x in 1:nrow(df_npv)) {
  n        <- df_npv[x,"n"]
  lev_prof <- df_npv[x,"lev_prof"]
  npv      <- df_npv[x,"npv"]
  
  v_npv_Name   <- paste0('npv_profit_pred_next_',vProfitNext,'_n_',n)
  v_Pr_n_Names <- paste0('profit_pred', "_Pr", 0:n)
  df_profit_lev3[,'profit_pred'] <- apply(df_profit_lev3[,v_Pr_n_Names], 1, sum, na.rm = T)
  
  traid_index <- (df_profit_lev3$profit_pred > lev_prof)
  df_strategy_vote[,v_npv_Name] <- 0
  df_strategy_vote[traid_index,v_npv_Name] <- npv
}
##########
}
l_strategies[vStrategy] <- list(df_strategy_vote)
}
```

```{r}
# source("./scripts/paste_primary_summary.R")
# undebug(paste_primary_summary)
#   l_var_parallel <- paste_primary_summary(date = vDates[1],
#                                           df_variabels = df_unique_variabels_selected,
#                                           df_profit = df_profitPr[index,])
```


```{r}
df_lev4 <- get_df_lev4(l_strategies = l_strategies, 
                       df_date_lev4 = df_profit[,c('date','profit')], 
                       vTraid_index = 6)
df_lev4 %>%
  group_by(year) %>%
  summarise(traid_index = mean(traid_index),
            profit_model = sum(profit_model),
            profit_avarage = sum(profit_avarage),
            profit_best = sum(profit_SL_14_18_RTS_Int02))

df_lev4 %>%
  group_by(year >= 2017) %>%
  summarise(traid_index = mean(traid_index),
            profit_model = sum(profit_model),
            profit_avarage = sum(profit_avarage),
            profit_best = sum(profit_SL_14_18_RTS_Int02))

get_cumulative_profit(df_lev4 = df_lev4, k = 1)
get_cumulative_profit(df_lev4 = df_lev4, k = 2)
get_cumulative_profit(df_lev4 = df_lev4, k = 3)
get_cumulative_profit(df_lev4 = df_lev4, k = 10)
```

# MoneyCulculation

```{r}
ymax <- max(c(df_lev4[,'money_model'],df_lev4[,'money']), na.rm = T)
gg_train <- df_lev4 %>%
  filter(date < vDates[1]) %>%
  ggplot() +
  geom_point(aes(x = date, y = money), color = 'red', alpha = 0.2) +
  geom_point(aes(x = date, y = money_model), color = 'green', alpha = 0.2) +
  ggtitle('Train')

gg_test <- df_lev4 %>%
  filter(date >= vDates[1]) %>%
  ggplot() +
  geom_point(aes(x = date, y = money), color = 'red', alpha = 0.2) +
  geom_point(aes(x = date, y = money_model), color = 'green', alpha = 0.2) +
  ggtitle('Test')

grid.arrange(gg_train, gg_test, ncol = 2)
```


```{r}

```



```{r}
df_money_by_year <- get_cumulative_profit(df_lev4 = df_lev4)
df_money_by_year
train_index <- df_month_summary$year >= 2017

S = 100000
profit <- df_money_by_year$money
m_0 = mean(profit)
s2_0 = var(profit)
n_0 = length(profit)
v_0 = n_0 - 1

phi = rgamma(S, v_0/2, s2_0*v_0/2)
sigma = 1/sqrt(phi)
mu = rnorm(S, mean=m_0, sd=sigma/(sqrt(n_0)))
Y = rnorm(S, mu, sigma)
Years <- 1/(length(which(Y < 0))/length(Y))
sd_profit <- sd(profit)*Years

df <- data.frame("NPV" = rnorm(S, mu, sigma)*Years
           #"income_mu" = rnorm(S, mean=m_0, sd=sigma/(sqrt(n_0)))*Years
           ) %>%
        mutate(positive = if_else(NPV > 0, T, F))

pers_positive <- length(which(df$positive == T))/nrow(df)
text_positive <- paste0((pers_positive)*100," %")
text_negative <- paste0((1-pers_positive)*100," %")

gg_total_profit <- ggplot(data = df) +
        geom_histogram(aes(x=NPV, fill=positive,color = positive), alpha=.3,bins = 100) +
        xlim(0-sd_profit*6,0+sd_profit*6) +
        ylim(-350,5000)+
        #geom_vline(xintercept = mean(df$NPV), linetype="dotted", size=1.5) +
        geom_text(x=0-sd_profit*3, y=-350, label = text_negative, color = "darkred") +
        geom_text(x=0+sd_profit*3, y=-350, label = text_positive , color = "darkgreen") +
        ggtitle(paste0("NPV distribution with mean = ",round(mean(df$NPV),0)))

S = 100000
profit <- df_money_by_year$money_model
m_0 = mean(profit)
s2_0 = var(profit)
n_0 = length(profit)
v_0 = n_0 - 1

phi = rgamma(S, v_0/2, s2_0*v_0/2)
sigma = 1/sqrt(phi)
mu = rnorm(S, mean=m_0, sd=sigma/(sqrt(n_0)))
Y = rnorm(S, mu, sigma)
Years <- 1/(length(which(Y < 0))/length(Y))
sd_profit <- sd(profit)*Years

df <- data.frame("NPV" = rnorm(S, mu, sigma)*Years
           #"income_mu" = rnorm(S, mean=m_0, sd=sigma/(sqrt(n_0)))*Years
           ) %>%
        mutate(positive = if_else(NPV > 0, T, F))

pers_positive <- length(which(df$positive == T))/nrow(df)
text_positive <- paste0((pers_positive)*100," %")
text_negative <- paste0((1-pers_positive)*100," %")

gg_total_profit_model <- ggplot(data = df) +
        geom_histogram(aes(x=NPV, fill=positive,color = positive), alpha=.3,bins = 100) +
        xlim(0-sd_profit*6,0+sd_profit*6) +
        ylim(-350,5000)+
        #geom_vline(xintercept = mean(df$NPV), linetype="dotted", size=1.5) +
        geom_text(x=0-sd_profit*3, y=-350, label = text_negative, color = "darkred") +
        geom_text(x=0+sd_profit*3, y=-350, label = text_positive , color = "darkgreen") +
        ggtitle(paste0("NPV distribution with mean = ",round(mean(df$NPV),0)))

grid.arrange(gg_total_profit, gg_total_profit_model, ncol = 1)
```















































































