---
title: "moex_new"
author: "ditiatev"
date: "21 07 2020"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

# Setup
```{r setup, include=FALSE}
options(digits = 4)
options(scipen = 999)

library(statsr)
library(plyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(reshape2)
library(BAS)
library(GGally)
library(FNN)
library(BayesFactor)
library(gridExtra)

library(foreach)
library(doParallel)

source("./scripts/saveGGplot.r")
source("./scripts/opendir.r")
source("./scripts/makePrColForStrategy.r")

source("./scripts/bayes/bayes_inference.R")
source("./scripts/bayes/bayes_util.R")
source("./scripts/bayes/bayes_single_mean_JZS.R")
source("./scripts/bayes/bayes_two_mean.R")

source("./scripts/get_workset.R")
source("./scripts/get_NormalDistForvard.r")
source("./scripts/get_NormalDist.r")
source("./scripts/get_df_unique_variabels.r")
source("./scripts/get_separate_index.r")


# KNN
source("./scripts/normalizeXtrainXtest.R")
source("./scripts/create_X_y.R")
source("./scripts/paste_summary.R")
source("./scripts/create_vector_dates.R")
source("./scripts/get_sample_date_index.R")
```

# Data
```{r}
vStrategies <- c("RTS_10_14")
#vStrategies <- c("SI_10_14")
df_daily <- get_WorkSet(vStrategies)
colnames(df_daily) <- gsub("\\.", "_",colnames(df_daily))
```

## MA
Forvard profit
```{r}
df_profitForvard <- get_NormalDistForvard(df_daily = df_daily, vColName = 'profit', sliding_depth = 25)
```

Previos MA by vColNames
```{r, warning=FALSE, message=FALSE}
vColNames <- colnames(df_daily)[c(6:11)]
df_profitPr <- get_NormalDist(df_daily = df_daily,
                              vColName = vColNames,
                              sliding_depth = 50,
                              slidind_return = c(10,25,50))

vVariables <- colnames(df_profitPr)

df_profitPr$profit <- df_profitForvard$profit_mean_Next_25
df_profitPr$date <- ymd(df_daily$date)
```

```{r}
df_common <- df_profitPr[,colnames(df_profitPr)[c(308,37:306)]]
head(df_common)
```

```{r}
df_profitPr <- merge(df_profitPr,df_common, all.x = TRUE, by.x = c("date"), by.y = c("date"))
```


# KNNSearch

Note:
- normalization happend in create_X_y

## KNNSearch new df_vars 

```{r, warning=FALSE, message=FALSE}
vVariables <- unique(colnames(df_profitPr))
vVariables <- vVariables[which(!(vVariables %in% c("date","profit")))]


len <- length(vVariables)
vDates <- create_vector_dates()

df_vars <- data.frame('k' = 0,
                      'date' = vDates[1],
                      'var1' = 'var1',
                      'var2' = 'var2',
                      'p_up_0_train' = 0,
                      'p_up_0_test' = 0,
                      'p_mean_profit_train' = 0,
                      'p_mean_profit_test' = 0,
                      'n_up_0_train' = 0,
                      'n_up_0_test' = 0,
                      'n_mean_profit_train' = 0,
                      'n_mean_profit_test' = 0)

df_vars$var1 <- as.character(df_vars$var1)
df_vars$var2 <- as.character(df_vars$var2)
```

## KNNSearch fill df_vars

```{r, warning=FALSE, message=FALSE}
vVar1s <- unique(df_vars$var1)
vVar2s <- unique(df_vars$var2)

df_unique_variabels <- as.data.frame(t(combn(vVariables,2)))
df_unique_variabels$V1 <- as.character(df_unique_variabels$V1)
df_unique_variabels$V2 <- as.character(df_unique_variabels$V2)
number_var_comb <- nrow(df_unique_variabels)
new_variables_index <- which(!is.na(df_unique_variabels$V1))

selected_variables_index <- sample(new_variables_index, size = 10)
df_unique_variabels_selected <- df_unique_variabels[-selected_variables_index,]
```

```{r}
df_vars_selected <- df_vars %>%
  group_by(var1, var2) %>%
  summarise(n = n())
```

```{r}
#df_unique_variabels <- merge(df_unique_variabels,df_vars_selected, all.x = TRUE, by.x = c("V1","V2"), by.y = c("var1","var2"))
#df_unique_variabels$selected <- 1

new_variables_index <- which(is.na(df_unique_variabels$n))
```




```{r}
df_search_vars <- do.call(rbind,l_var_parallel)
```

```{r}
df_empty_var <- df_unique_variabels[selected_variables_index,]
df_empty_var <- merge(df_empty_var,df_search_vars, all.x = TRUE, by.x = c("V1","V2"), by.y = c("var1","var2"))
```


#NEW VERTION

```{r, warning=FALSE, message=FALSE}
search_variabels <- function(df_profitPr = df_profitPr,
                             selected_variables_index = selected_variables_index,
                             vDates = vDates,
                             df_unique_variabels = df_unique_variabels) {
  
    get_sample_date_index <- function(vDates, sample_size = 5) {
        
        date_index <- 1:length(vDates)
        
        if (length(date_index) < sample_size) {
                sample_size <- length(date_index)
        }
        
        sample_date_index <- sample(date_index, size = sample_size)
        
        return(list('vDatesSample' = vDates[sample_date_index],
                    'vDatesLeft' = vDates[-sample_date_index]))
    }
    
    create_X_y <- function(df = df, train_index = train_index, test_index = test_index, 
                       vVar1 = vVar1, vVar2 = vVar2, normalization = TRUE) {
        
        X_train <- df[train_index,c(vVar1,vVar2)]
        y_train <- df[train_index,c('profit')]
        X_test  <- df[test_index,c(vVar1,vVar2)]
        y_test  <- df[test_index,c('profit')]
        
        if (normalization == TRUE) {
                
                normalizeXtrainXtest <-
                        function(X_train, X_test) {
                                
                                vColNames <- colnames(X_train)
                                for (vColName in vColNames) {
                                        
                                        x_sd   <- sd(X_train[,vColName], na.rm = T)
                                        x_mean <- mean(X_train[,vColName], na.rm = T)
                                        min_x  <- x_mean - x_sd * 3
                                        
                                        X_train[, vColName] <- ((X_train[,vColName] - min_x) / (6 * x_sd))
                                        X_test[, vColName]  <- ((X_test[,vColName] - min_x) / (6 * x_sd))
                                }

                                return(list('X_train' = X_train, 
                                            'X_test' = X_test))
                        }
                
                X <- normalizeXtrainXtest(X_train,X_test)
                X_train <- X$X_train
                X_test  <- X$X_test
        }
        
        l <- list('X_train' = X_train,
                  'y_train' = y_train,
                  'X_test' = X_test,
                  'y_test' = y_test)
        
        return(l)}
    
    paste_summary <- function(X_train = X_train, X_test = X_test,
                              y_train = y_train, y_test = y_test, nk = nk,
                              vVar1 = vVar1, vVar2 = vVar2, date = date) {
      
      get_summary <- function(pred, y, pred_train) {
                df <- data.frame('pred' = pred, 'profit' = y)
                
                min25 <- quantile(pred_train, 0.25, type = 1)
                max25 <- quantile(pred_train, 0.75, type = 1)
                
                df <- df %>%
                        mutate(
                                up_0 = case_when(profit <= 0 ~ 0,
                                                 profit > 0 ~ 1),
                                gr = case_when(pred <= min25 ~ 'min25',
                                               pred >= max25 ~ 'max25',
                                               TRUE ~ 'middle')
                        ) %>%
                        group_by(gr) %>%
                        summarise(up_0 = mean(up_0),
                                  mean_profit = mean(profit))
                df <- as.data.frame(df)
                
                df[1, 'profit'] <- max25
                df[3, 'profit'] <- min25
                return(df[c(1, 3), ])
        }
        
        knn_train <- FNN::knn.reg(train=X_train,y=y_train,test=X_train,k=nk)
        knn_test  <- FNN::knn.reg(train=X_train,y=y_train,test=X_test, k=nk)
        
        train_summary <- get_summary(pred = knn_train[["pred"]], y = y_train, pred_train = knn_train[["pred"]])
        test_summary <- get_summary(pred = knn_test[["pred"]], y = y_test, pred_train = knn_train[["pred"]])
        
        df_current_summary <- data.frame(
                'k'   = nk,
                'date'   = date,
                'var1'  = as.character(vVar1),
                'var2'  = as.character(vVar2))
        df_current_summary$var1 <- as.character(df_current_summary$var1)
        df_current_summary$var2 <- as.character(df_current_summary$var2)
        
        # positive summary
        df_current_summary[1,'p_up_0_train']  = train_summary[1, 'up_0']
        df_current_summary[1,'p_up_0_test'] = test_summary[1, 'up_0']
        df_current_summary[1,'p_mean_profit_train'] = train_summary[1, 'mean_profit']
        df_current_summary[1,'p_mean_profit_test'] = test_summary[1, 'mean_profit']
        # negative summary
        df_current_summary[1,'n_up_0_train']  = 1 - train_summary[2, 'up_0']
        df_current_summary[1,'n_up_0_test'] = 1 - test_summary[2, 'up_0']
        df_current_summary[1,'n_mean_profit_train'] = train_summary[2, 'mean_profit']
        df_current_summary[1,'n_mean_profit_test'] = test_summary[2, 'mean_profit']
        
        return(df_current_summary)
    }
    
    return_df_var <- function(z, df_profitPr = df_profitPr,
                              selected_variables_index = selected_variables_index,
                              vDates = vDates,
                              df_unique_variabels = df_unique_variabels) {
      x <- selected_variables_index[z]
      vVar1 <- df_unique_variabels[x, "V1"]
      vVar2 <- df_unique_variabels[x, "V2"]
      l_var <- list()

      df <- na.omit(df_profitPr[c(vVar1, vVar2, 'profit', 'date')])

      lDates       <- get_sample_date_index(vDates)
      vDatesLeft   <- lDates$vDatesLeft
      vDatesSample <- lDates$vDatesSample
      df_var <- c()
      p_up_0_test <- 0
      n_up_0_test <- 0

      for (Ntime in 1:2) {
        for (ndate in 1:length(vDatesSample)) {
          date <- vDatesSample[ndate]
          # create X,y
          train_index <- which(df$date < date)
          test_index  <- which((df$date > (date +30)) & (df$date < (date + 90)))
          if (length(test_index) != 0) {
            l <- create_X_y(df = df, train_index = train_index, test_index = test_index,
                            vVar1 = vVar1, vVar2 = vVar2)
            # summary
            var_index  <- paste0('x_', as.character(x),"_nk_",nk,"_date_",date)
            l_var[var_index] <- list(paste_summary(l$X_train, l$X_test, l$y_train, l$y_test, nk = nk,
                                                 vVar1 = vVar1, vVar2 = vVar2, date = date))
          }
        }

        if (Ntime == 2) {
          return(df_var)
        }
        
        if (length(l_var) != 0) {
          df_var <- plyr::ldply(l_var, data.frame)
          
          p_up_0_test <- mean(df_var$p_up_0_test, na.rm = TRUE)
          n_up_0_test <- mean(df_var$n_up_0_test, na.rm = TRUE)
          
          
          if ((p_up_0_test < 0.6) & (n_up_0_test < 0.6)) {
            return(df_var)
            } else {
              vDatesSample <- lDates$vDatesLeft
              }
          
        } else {
          vDatesSample <- lDates$vDatesLeft
        }
      }

      return(df_var)
      }
    
    ##########################
    ##########################
    ##########################
    ##########################
    ##########################
    
  nk <- 100
  len = length(selected_variables_index)
  #for (x in selected_variables_index) {
  for (z in 1:len) {
  #foreach(z = 1:len, .packages="dplyr") %dopar% {
    df_var <- return_df_var(z, df_profitPr = df_profitPr,
                            selected_variables_index = selected_variables_index,
                            vDates = vDates,
                            df_unique_variabels = df_unique_variabels)
      # x <- selected_variables_index[z]
      # vVar1 <- df_unique_variabels[x, "V1"]
      # df_var <- vVar1
    df_var
  }
  df_var
  }
```

```{r}
    paste_summary <- function(X_train = X_train, X_test = X_test,
                              y_train = y_train, y_test = y_test, nk = nk,
                              vVar1 = vVar1, vVar2 = vVar2, date = date) {
      
      get_summary <- function(pred, y, point) {
                df <- data.frame('pred' = pred, 'profit' = y)
                
                index_pred <- df$pred >= point
                index_y <- df_profit >= 0
                
                TP_index <- which((df$pred >= point) & (df$profit >= 0))
                FP_index <- which((df$pred >= point) & (df$profit < 0))
                TN_index <- which((df$pred < point)  & (df$profit < 0))
                FN_index <- which((df$pred < point)  & (df$profit >= 0))
                
                return(list(TP_index,FP_index,TN_index,FN_index))
        }
        
        knn_train <- FNN::knn.reg(train=X_train,y=y_train,test=X_train,k=nk)
        knn_test  <- FNN::knn.reg(train=X_train,y=y_train,test=X_test, k=nk)
        
        point <- quantile(knn_train[["pred"]], 0.25, type = 1)
        
        train_summary <- get_summary(pred = knn_train[["pred"]], y = y_train, point = point)
        test_summary <- get_summary(pred = knn_test[["pred"]], y = y_test, point = point)
        
        df_current_summary <- data.frame(
                'k'   = nk,
                'date'   = date,
                'var1'  = as.character(vVar1),
                'var2'  = as.character(vVar2))
        df_current_summary$var1 <- as.character(df_current_summary$var1)
        df_current_summary$var2 <- as.character(df_current_summary$var2)
        
        # positive summary
        df_current_summary[1,'p_up_0_train']  = train_summary[1, 'up_0']
        df_current_summary[1,'p_up_0_test'] = test_summary[1, 'up_0']
        df_current_summary[1,'p_mean_profit_train'] = train_summary[1, 'mean_profit']
        df_current_summary[1,'p_mean_profit_test'] = test_summary[1, 'mean_profit']
        # negative summary
        df_current_summary[1,'n_up_0_train']  = 1 - train_summary[2, 'up_0']
        df_current_summary[1,'n_up_0_test'] = 1 - test_summary[2, 'up_0']
        df_current_summary[1,'n_mean_profit_train'] = train_summary[2, 'mean_profit']
        df_current_summary[1,'n_mean_profit_test'] = test_summary[2, 'mean_profit']
        
        return(df_current_summary)
    }
```

```{r}
ps <- paste_summary(l$X_train, l$X_test, l$y_train, l$y_test, nk = nk,
                    vVar1 = vVar1, vVar2 = vVar2, date = date)
```


```{r}
      get_summary <- function(pred, y, point) {
                df <- data.frame('pred' = pred, 'profit' = y)
      
                TP_index <- which((df$pred >= point) & (df$profit >= 0))
                FP_index <- which((df$pred >= point) & (df$profit < 0))
                TN_index <- which((df$pred < point)  & (df$profit < 0))
                FN_index <- which((df$pred < point)  & (df$profit >= 0))
                
                TP_sum <- sum(df[TP_index,'profit'], na.rm = T)
                FP_sum <- sum(df[FP_index,'profit'], na.rm = T)
                TN_sum <- sum(df[TN_index,'profit'], na.rm = T)
                FN_sum <- sum(df[FN_index,'profit'], na.rm = T)
                
                best_pr <- (TP_sum+FP_sum) / sum(df$pred, na.rm = T)
                names(best_pr) < 'best_pr'

                gs = c(TP_sum, FP_sum, TN_sum, FN_sum,
                       length(TP_index),length(FP_index),length(TN_index),length(FN_index))
                names(gs) = c( "TP_sum" , "FP_sum" , "TN_sum" , "FN_sum",
                                "TP_n" , "FP_n" , "TN_n" , "FN_n")
                
                sPR <- 1+gs["FP_sum"] / gs["TP_sum"]
                sP_pers <- gs["TP_sum"] / (gs["TP_sum"] + gs["FN_sum"])
                sNR <- 1+gs["FN_sum"] / gs["TN_sum"]
                sN_pers <- gs["TN_sum"] / (gs["TN_sum"] + gs["FP_sum"])
                
                nPR <- gs['TP_n'] / (gs['TP_n'] + gs['FP_n'])
                nP_pers <- gs['TP_n'] / (gs['TP_n'] + gs['FN_n'])
                nNR <- gs['TN_n'] / (gs['TN_n'] + gs['FN_n'])
                nN_pers <- gs['TN_n'] / (gs['TN_n'] + gs['FP_n'])

                vSummary <- c(sPR,sP_pers,sNR,sN_pers,
                              nPR,nP_pers,nNR,nN_pers)
                names(vSummary) <- c('sPR','sP_pers','sNR','sN_pers',
                                     'nPR','nP_pers','nNR','nN_pers')
                
                return(c(best_pr,gs,vSummary))
        }
```

# get_primary_summary

```{r}
paste_primary_summary <- function(date,
                                  df_variabels,
                                  df_profit) {
  
      create_X_y <- function(df = df, 
                             train_index = train_index, 
                             test_index = test_index,
                             vVar1 = vVar1,
                             vVar2 = vVar2,
                             normalization = TRUE) {
        
        X_train <- df[train_index,c(vVar1,vVar2)]
        y_train <- df[train_index,c('profit')]
        X_test  <- df[test_index,c(vVar1,vVar2)]
        y_test  <- df[test_index,c('profit')]
        
        if (normalization == TRUE) {
          normalizeXtrainXtest <- function(X_train, X_test) {
                          
                                vColNames <- colnames(X_train)
                                for (vColName in vColNames) {
                                        
                                        x_sd   <- sd(X_train[,vColName], na.rm = T)
                                        x_mean <- mean(X_train[,vColName], na.rm = T)
                                        min_x  <- x_mean - x_sd * 3
                                        
                                        X_train[, vColName] <- ((X_train[,vColName] - min_x) / (6 * x_sd))
                                        X_test[, vColName]  <- ((X_test[,vColName] - min_x) / (6 * x_sd))
                                }

                                return(list('X_train' = X_train, 
                                            'X_test' = X_test))
                        }
                
                X <- normalizeXtrainXtest(X_train,X_test)
                X_train <- X$X_train
                X_test  <- X$X_test
        }
        
        l <- list('X_train' = X_train,
                  'y_train' = y_train,
                  'X_test' = X_test,
                  'y_test' = y_test)
        
        return(l)}
      
      get_primary_summary <- function(pred, y) {
        df <- data.frame('pred' = pred, 'profit' = y)
        vMin <- quantile(df$pred, 0.2, type = 1)
        VMax <- quantile(df$pred, 0.2, type = 1)
        
        min_index <- which(df$pred <= vMin)
        max_index <- which(df$pred >= VMax)
        
        min_index_down0 <- which((df$pred <= vMin) & (df$profit < 0))
        min_index_up0   <- which((df$pred >= VMax) & (df$profit > 0))
        
        profit_min       <- mean(df[min_index,'profit'], na.rm = T)
        profit_max       <- mean(df[max_index,'profit'], na.rm = T)
        profit_min_down0 <- mean(df[min_index_down0,'profit'], na.rm = T)
        profit_max_up0   <- mean(df[min_index_up0,'profit'], na.rm = T)
        profit           <- mean(df[,'profit'], na.rm = T)
        
        primary_summary <- c(profit_min,profit_min_down0,profit_max,profit_max_up0,profit)
        return(primary_summary)
      }
      
      get_separate_index <- function(df, section_length = 21) {
        # form index
        double_SL <- section_length*2
        n_row <- nrow(df)
        
        vlen <- ceiling(n_row/double_SL)
        vStart <- ((1:vlen)*double_SL-(double_SL-1)); 
        vEnd <- ((1:vlen)*double_SL-(double_SL-1))+(section_length-1)
        
        index_1 <- c(); index_2 <- c()
        for (x in 1:vlen) {
          index_1 <- c(index_1,seq(from = vStart[x], to = vEnd[x]))
          index_2 <- c(index_2,seq(from = vStart[x]+section_length, to = vEnd[x]+section_length))
          }
        index_1 <- index_1[index_1 <= n_row]
        index_2 <- index_2[index_2 <= n_row]
        return(list('index_1' = index_1, 'index_2' = index_2))
        }
      
      paste_primary_summary <- function(z,
                                        df_variabels,
                                        df_profit) {
        vVar1 <- df_variabels[z, "V1"]
        vVar2 <- df_variabels[z, "V2"]
        df <- na.omit(df_profit[c(vVar1, vVar2, 'profit', 'date')])
        
        l_index <- get_separate_index(df = df, section_length = 21)
        
        # train models
        l <- create_X_y(df = df,
                        train_index = l_index$index_1,
                        test_index = l_index$index_2,
                        vVar1 = vVar1,
                        vVar2 = vVar2)
        knn_train <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=100)
        ps100_1 <- get_primary_summary(pred = knn_train[["pred"]], y = l$y_test)
        
        l <- create_X_y(df = df,
                        train_index = l_index$index_2,
                        test_index = l_index$index_1,
                        vVar1 = vVar1,
                        vVar2 = vVar2)       
        knn_train <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=100)
        ps100_2 <- get_primary_summary(pred = knn_train[["pred"]], y = l$y_test)
        
        ps <- c(vVar1,vVar2,ps100_1,ps100_2)
        names(ps) <- c('vVar1','vVar2',
                       'profit_min100_1','profit_min100_down0_1',
                       'profit_max100_1','profit_max100_up0_1','profit100_1',
                       'profit_min100_2','profit_min100_down0_2',
                       'profit_max100_2','profit_max100_up0_2','profit100_2')
        return(ps)
        }
      
      
      ###
      ###
      ###
      len = nrow(df_variabels)
      #for (z in 1:len) {
      foreach(z = 1:len, .packages="dplyr") %dopar% {
        ps = paste_primary_summary(z = z,
                                   df_variabels = df_variabels,
                                   df_profit = df_profit)
        ps
        }
}

paste_primary_summary_parallel <- function(date,
                                           df_variabels,
                                           df_profit,
                                           core = 3) {
  cl <- parallel::makeCluster(core)
  doParallel::registerDoParallel(cl)
  l_var <- tryCatch(paste_primary_summary(date = date,
                                          df_variabels = df_variabels,
                                          df_profit = df_profit), 
                    error = function(e) print(e))
  parallel::stopCluster(cl)
  l_var
}
```

```{r}
# undebug(paste_primary_summary)
# l <- paste_primary_summary(date = vDates[1],
#                            df_variabels = df_unique_variabels_selected[1:2,],
#                            df_profit = df_profitPr)
```



## culculation
```{r}
source("./scripts/get_df_unique_variabels.r")
df_variabels <- get_df_unique_variabels(vVariables)
df_unique_variabels <- df_variabels
l_vars <- list()

df_unique_variabels <- df_unique_variabels[df_unique_variabels$calculated == 0,]
vSizeGroup <- 1000
nGroups <- ceiling(nrow(df_unique_variabels)/vSizeGroup)
index <- df_profitPr$date < vDates[1]
df_profit = df_profitPr[index,]
for (n_group in 1:nGroups) {
  startindex <- ((n_group-1)*vSizeGroup)
  endindex <- ((n_group*vSizeGroup)-1)
  if (endindex > nrow(df_unique_variabels)) {
    endindex <- nrow(df_unique_variabels)
  }
  df_unique_variabels_selected <- df_unique_variabels[startindex:endindex,]
  # code
  l_var_parallel <- paste_primary_summary_parallel(date = vDates[1],
                                                   df_variabels = df_unique_variabels_selected,
                                                   df_profit = df_profit)
  df_search_vars <- as.data.frame(do.call(rbind,l_var_parallel))
  df_search_vars$vVar1 <- as.character(df_search_vars$vVar1)
  df_search_vars$vVar2 <- as.character(df_search_vars$vVar2)

  df_search_vars$profit_min100_1 <- as.numeric(as.character(df_search_vars$profit_min100_1))
  df_search_vars$profit_min100_2 <- as.numeric(as.character(df_search_vars$profit_min100_2))
  df_search_vars$profit_max100_1 <- as.numeric(as.character(df_search_vars$profit_max100_1))
  df_search_vars$profit_max100_2 <- as.numeric(as.character(df_search_vars$profit_max100_2))
  
  df_search_vars$profit_min100_down0_1 <- as.numeric(as.character(df_search_vars$profit_min100_down0_1))
  df_search_vars$profit_min100_down0_2 <- as.numeric(as.character(df_search_vars$profit_min100_down0_2))
  df_search_vars$profit_max100_up0_1 <- as.numeric(as.character(df_search_vars$profit_max100_up0_1))
  df_search_vars$profit_max100_up0_2 <- as.numeric(as.character(df_search_vars$profit_max100_up0_2))
  
  df_search_vars$profit100_1 <- as.numeric(as.character(df_search_vars$profit100_1))
  df_search_vars$profit100_2 <- as.numeric(as.character(df_search_vars$profit100_2))


  l_vars[length(l_vars)+1] <- list(df_search_vars)
  # code
  df_unique_variabels[startindex:endindex,'calculated'] <- 1
  print(n_group/nGroups)
}
#parallel::stopCluster(3)
```

```{r}
df_search_vars <- as.data.frame(do.call(rbind,l_vars))
df_search_vars$kMax100_1 <- df_search_vars$profit_max100_1/df_search_vars$profit100_1
df_search_vars$kMax100_2 <- df_search_vars$profit_max100_2/df_search_vars$profit100_2

df_search_vars$kMin100_1 <- df_search_vars$profit_min100_1/df_search_vars$profit100_1
df_search_vars$kMin100_2 <- df_search_vars$profit_min100_2/df_search_vars$profit100_2

df_search_vars$kMinDiff_1 <- 1/(df_search_vars$profit_min100_down0_1/df_search_vars$profit_min100_1)
df_search_vars$kMinDiff_2 <- 1/(df_search_vars$profit_min100_down0_2/df_search_vars$profit_min100_2)

df_search_vars$kMaxDiff_1 <- 1/(df_search_vars$profit_max100_up0_1/df_search_vars$profit_max100_1)
df_search_vars$kMaxDiff_2 <- 1/(df_search_vars$profit_max100_up0_2/df_search_vars$profit_max100_2)
```


```{r}
quan <- 0.5
min_1 <- quantile(df_search_vars$profit_min100_1, 1-quan, type = 1)
min_2 <- quantile(df_search_vars$profit_min100_2, 1-quan, type = 1)
max_1 <- quantile(df_search_vars$profit_max100_1, quan, type = 1)
max_2 <- quantile(df_search_vars$profit_max100_2, quan, type = 1)

quan <- 0.8
kmin_1 <- quantile(df_search_vars$kMinDiff_1, quan, type = 1)
kmin_2 <- quantile(df_search_vars$kMinDiff_2, quan, type = 1)
kmax_1 <- quantile(df_search_vars$kMaxDiff_1, quan, type = 1)
kmax_2 <- quantile(df_search_vars$kMaxDiff_2, quan, type = 1)


index <- ((df_search_vars$profit_max100_1 > max_1) &
            (df_search_vars$profit_max100_2 > max_2) & 
            (df_search_vars$profit_min100_1 < min_1) &
            (df_search_vars$profit_min100_2 < min_2) &
            (df_search_vars$kMinDiff_1 > kmax_1) &
            (df_search_vars$kMinDiff_2 > kmax_2) &
            (df_search_vars$kMaxDiff_1 > kmin_1) &
            (df_search_vars$kMaxDiff_2 > kmin_2))
df_search_vars_shoosen <- df_search_vars[index,]

nrow(df_search_vars_shoosen)
```

```{r}
ggplot(data = df_search_vars) +
  geom_histogram(aes(x = kMaxDiff_1), bins = 100)

ggplot(data = df_search_vars) +
  geom_histogram(aes(x = kMaxDiff_2), bins = 100)

ggplot(data = df_search_vars) +
  geom_histogram(aes(x = kMinDiff_1), bins = 100)

ggplot(data = df_search_vars) +
  geom_histogram(aes(x = kMinDiff_2), bins = 100)
```

```{r}
df_search_vars_shoosen %>%
  head(5)
```
## plot
```{r}
vVar1 <- 'capitalization_RTSI_mean_Pr_10'
vVar2 <- 'capitalization_RTSTRN_sd_Pr_10'

df <- df_profitPr[,c(vVar1,vVar2,"profit")]
colnames(df) <- c('var1','var2',"profit")
df <- na.omit(df)

var1 <- seq(min(df$var1, na.rm = T), max(df$var1, na.rm = T), length.out=100)
var2 <- seq(min(df$var2, na.rm = T), max(df$var2, na.rm = T), length.out=100)
df_test <- expand.grid(var1,var2)
colnames(df_test) <- c("var1","var2")

knn <- knn.reg(train=df[c("var1","var2")],
               y=df$profit,
               test=df[c("var1","var2")],
               k=50)
df$pred <- knn[["pred"]]

gg_pred50 <- ggplot() +
  geom_point(aes(x = var1, y = var2, 
                 color = pred, alpha = 0.1), 
             shape=15, size = 2, data = df) +
  scale_color_gradient2(midpoint=0, limit = c(-.3,.3), space = "Lab",
                        low="red", mid="white", high="green") +
  geom_density2d(aes(x = var1, y = var2, alpha = 0.099), data = df) +
  xlab(vVar1)+ylab(vVar2) +
  ggtitle('pred50')

knn <- knn.reg(train=df[c("var1","var2")],
               y=df$profit,
               test=df[c("var1","var2")],
               k=100)
df$pred <- knn[["pred"]]

gg_pred100 <- ggplot() +
  geom_point(aes(x = var1, y = var2, 
                 color = pred, alpha = 0.1), 
             shape=15, size = 2, data = df) +
  scale_color_gradient2(midpoint=0, limit = c(-.3,.3), space = "Lab",
                        low="red", mid="white", high="green") +
  geom_density2d(aes(x = var1, y = var2, alpha = 0.099), data = df) +
  xlab(vVar1)+ylab(vVar2) +
  ggtitle('pred100')

knn <- knn.reg(train=df[c("var1","var2")],
               y=df$profit,
               test=df[c("var1","var2")],
               k=150)
df$pred <- knn[["pred"]]

gg_pred150 <- ggplot() +
  geom_point(aes(x = var1, y = var2, 
                 color = pred, alpha = 0.1), 
             shape=15, size = 2, data = df) +
  scale_color_gradient2(midpoint=0, limit = c(-.3,.3), space = "Lab",
                        low="red", mid="white", high="green") +
  geom_density2d(aes(x = var1, y = var2, alpha = 0.099), data = df) +
  xlab(vVar1)+ylab(vVar2) +
  ggtitle('pred150')

gg_profit <- ggplot() +
  geom_point(aes(x = var1, y = var2, 
                 color = profit, alpha = 0.1), 
             shape=15, size = 2, data = df) +
  scale_color_gradient2(midpoint=0, limit = c(-.3,.3), space = "Lab",
                        low="red", mid="white", high="green") +
  geom_density2d(aes(x = var1, y = var2, alpha = 0.099), data = df) +
  xlab(vVar1)+ylab(vVar2)

grid.arrange(gg_profit,  gg_pred50,
             gg_pred100, gg_pred150, ncol = 2)
```

## debuging

```{r}
vVar1 <- df_unique_variabels[1586, "V1"]
vVar2 <- df_unique_variabels[1586, "V2"]
df <- na.omit(df_profitPr[c(vVar1, vVar2, 'profit', 'date')])

lDates       <- get_sample_date_index(vDates)
vDatesLeft   <- lDates$vDatesLeft
vDatesSample <- lDates$vDatesSample
date <- vDates[2]

train_index <- which(df$date < date)
test_index  <- which(df$date > (date + 30))

l <- create_X_y(df = df,train_index = train_index,test_index = test_index,vVar1 = vVar1,vVar2 = vVar2)
knn_train <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_train, k=150)
knn_test  <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=150)

get_primary_summary(pred = knn_train[["pred"]], y = l$y_train, dates = l$date_train)
undebug(get_primary_summary)
get_primary_summary(pred = knn_test[["pred"]], y = l$y_test, dates = l$date_test)
```

```{r}
knn_train <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_train, k=150)
l_sum <- list()
for (x in seq(from = 0.01, to = .99, length.out = 100 )) {
  point <- quantile(knn_train[["pred"]], x, type = 1)
  l_sum[as.character(point)] <- list(get_summary(pred = knn_train[["pred"]], y = l$y_train, point = point))
}
```

```{r, warning=FALSE, message=FALSE}
#debug(search_variabels)
l_var <- search_variabels(df_profitPr = df_profitPr,
                          selected_variables_index = selected_variables_index,
                          vDates = vDates,
                          df_unique_variabels = df_unique_variabels)
```


```{r}
source("./scripts/get_separate_index.r")
source("./scripts/get_primary_summary.r")

date <- vDates[1]
point<- 0.02
index_train <- df$date < (date  %m-% days(26))
df_split_train <- df[index_train,]
l_index <- get_separate_index(df = df_split_train, section_length = 21)
# train models
l <- create_X_y(df = df_split_train,
                train_index = l_index$index_1,
                test_index = l_index$index_2,
                vVar1 = vVar1,
                vVar2 = vVar2)
knn_train <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=100)
#undebug(get_primary_summary)
ps100_1 <- get_primary_summary(pred = knn_train[["pred"]], y = l$y_test, point = point)

l <- create_X_y(df = df_split_train,
                train_index = l_index$index_2,
                test_index = l_index$index_1,
                vVar1 = vVar1,
                vVar2 = vVar2)
knn_train <- FNN::knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=100)
ps100_2 <- get_primary_summary(pred = knn_train[["pred"]], y = l$y_test, point = point)

ps <- as.numeric(c(ps100_1,ps100_2))
names(ps) <- c('profit_min100_1','profit_min100_down0_1',
               'profit_max100_1','profit_max100_up0_1','profit100_1',
               'profit_min100_2','profit_min100_down0_2',
               'profit_max100_2','profit_max100_up0_2','profit100_2')

k_down <- sum(c(ps["profit_min100_1"],ps["profit_min100_2"]), na.rm = T
              )/sum(c(ps["profit_min100_down0_1"],ps["profit_min100_down0_2"]), na.rm = T)
k_up <- sum(c(ps["profit_max100_1"],ps["profit_max100_2"]), na.rm = T
            )/sum(c(ps["profit_max100_up0_1"],ps["profit_max100_up0_2"]), na.rm = T)
k_scater <- c(k_down, k_up)

k_scater
```

# Vouting

```{r}
create_df_vote <- function() {
  df_vote <- data.frame("var1" = "var1",
                        "var2" = "var2",
                        "prob0_up" = 0,
                        "prob0_down" = 0,
                        "k_down" = 0,
                        "k_up" = 0)
  df_vote$var1 <- as.character(df_vote$var1)
  df_vote$var2 <- as.character(df_vote$var2)
  return(df_vote)
  }

create_vVars <- function(df_topVars = df_topVars,
                         index = index) {
  
  vVar1 <- df_topVars[index,"vVar1"][[1]]
  vVar2 <- df_topVars[index,"vVar2"][[1]]
  vVars <- c(vVar1,vVar2)
  
  return(vVars)
}

create_lxy <- function(df_profitPr = df_profitPr,
                       date = date,
                       vVars = vVars) {
  
  df <- na.omit(df_profitPr[c(vVars,'profit','date')])
  
  index_train <- df$date < (date  %m-% days(26))
  index_predict <- which(df$date == date)
  
  if (length(index_predict) == 0) {return(NA)}
  
  df_split_train <- df[index_train,]
  l_index <- get_separate_index(df = df_split_train, section_length = 21)
  
  l_predict <- create_X_y(df = df,
                          train_index = index_train,
                          test_index = index_predict,
                          vVars = vVars)
  
  l_train_1 <- create_X_y(df = df_split_train,
                          train_index = l_index$index_1,
                          test_index = l_index$index_2,
                          vVars = vVars)
  
  l_train_2 <- create_X_y(df = df_split_train,
                          train_index = l_index$index_2,
                          test_index = l_index$index_1,
                          vVars = vVars)
  
  l <- list('l_predict' = l_predict,
            'l_train_1' = l_train_1,
            'l_train_2' = l_train_2)
  
  return(l)
  }

get_prob0_summary <- function(l) {
  
  l_predict = l$l_predict
  
  knn_train  <- knn.reg(train=l_predict$X_train, 
                        y=l_predict$y_train, 
                        test=l_predict$X_train, 
                        k=100)
  df_train <- data.frame('pred' = knn_train[["pred"]], 'profit' = l_predict$y_train)
  
  knn_test  <- knn.reg(train=l_predict$X_train, 
                       y=l_predict$y_train, 
                       test=l_predict$X_test, k=100)
  
  vPred <- knn_test[["pred"]]
  vPredIndex <- (df_train$pred >= vPred)
  vPredIndex_up0 <- (df_train$pred >= vPred) & (df_train$profit > 0)
  vPredIndex_down0 <- (df_train$pred < vPred) & (df_train$profit < 0)
  
  prob0_up <- sum(df_train[vPredIndex,"profit"])/sum(df_train[vPredIndex_up0,"profit"])
  prob0_down <- sum(df_train[!vPredIndex,"profit"])/sum(df_train[vPredIndex_down0,"profit"]) 
  
  prob0 <- c(prob0_up,prob0_down)
  names(prob0) <- c("prob0_up","prob0_down")
  
  return(prob0)
}

get_scater_prob0_summary <- function(l) {
  
  l_train_1 <- l$l_train_1
  knn_train <- FNN::knn.reg(train=l_train_1$X_train,
                            y=l_train_1$y_train,
                            test=l_train_1$X_test,
                            k=100)
  ps100_1 <- get_primary_summary(pred = knn_train[["pred"]], y = l_train_1$y_test, point = vPred)
  
  l_train_2 <- l$l_train_2
  knn_train <- FNN::knn.reg(train=l_train_2$X_train,
                            y=l_train_2$y_train,
                            test=l_train_2$X_test, 
                            k=100)
  ps100_2 <- get_primary_summary(pred = knn_train[["pred"]], y = l_train_2$y_test, point = vPred)
  
  ps <- as.numeric(c(ps100_1,ps100_2))
  names(ps) <- c('profit_min100_1','profit_min100_down0_1',
                 'profit_max100_1','profit_max100_up0_1','profit100_1',
                 'profit_min100_2','profit_min100_down0_2',
                 'profit_max100_2','profit_max100_up0_2','profit100_2')
  k_down <- sum(c(ps["profit_min100_1"],ps["profit_min100_2"]), na.rm = T
                )/sum(c(ps["profit_min100_down0_1"],ps["profit_min100_down0_2"]), na.rm = T)
  k_up   <- sum(c(ps["profit_max100_1"],ps["profit_max100_2"]), na.rm = T
                )/sum(c(ps["profit_max100_up0_1"],ps["profit_max100_up0_2"]), na.rm = T)
  
  if (is.nan(k_down) | is.na(k_down)) {k_down <- 0}
  if (is.nan(k_up) | is.na(k_up)) {k_up <- 0}
  
  k <- c(k_down,k_up)
  names(k) <- c('k_down','k_up')
  
  return(k)
}


get_df_vote_m <- function(df_profitPr = df_profitPr,
                          df_topVars = df_topVars,
                          x = x) {
  date <- df_profitPr[x,"date"]
  df_vote <- create_df_vote()
  
  for (index in 1:nrow(df_topVars)) {
    
    vVars <- create_vVars(df_topVars = df_topVars, index = index)
    
    l <- create_lxy(df_profitPr = df_profitPr,
                    date = date, vVars = vVars)
    if (is.na(l)) {next}
    
    df_vote[index,"var1"] <- vVars[1]
    df_vote[index,"var2"] <- vVars[2]
    
    prob0_summary <- get_prob0_summary(l = l)
    df_vote[index,"prob0_up"] <- prob0_summary["prob0_up"]
    df_vote[index,"prob0_down"] <- prob0_summary["prob0_down"]
    #undebug(get_scater_prob0_summary)
    scater_prob0_summary <- get_scater_prob0_summary(l = l)
    df_vote[index,"k_down"] <- scater_prob0_summary["k_down"]
    df_vote[index,"k_up"] <- scater_prob0_summary["k_up"]
  }
  
  df_vote_m <- df_vote %>%
    summarise(prob0_up_sd = sd(prob0_up, na.rm = T),
              prob0_down_sd = sd(prob0_down, na.rm = T),
              scater_prob0_up = sum(k_up*prob0_up, na.rm = T)/sum(k_up, na.rm = T),
              scater_prob0_down = sum(k_down*prob0_down, na.rm = T)/sum(k_down, na.rm = T),
              prob0_up = mean(prob0_up, na.rm = T),
              prob0_down = mean(prob0_down, na.rm = T),
              x = x)
    
    return(df_vote_m)
}

get_df_vote_m_parallel <- function(df_profitPr = df_profitPr,
                                   df_topVars = df_topVars,
                                   x = x) {
  cl <- parallel::makeCluster(core)
  doParallel::registerDoParallel(cl)
  l_var <- tryCatch(paste_primary_summary(date = date,
                                          df_variabels = df_variabels,
                                          df_profit = df_profit), 
                    error = function(e) print(e))
  parallel::stopCluster(cl)
  l_var
}
```



```{r, message=FALSE,warning=FALSE}
df_topVars <- df_search_vars_shoosen

vVoteIndex <- which(df_profitPr$date >= vDates[1])

for (x in vVoteIndex[1:10]) {

  df_vote_m <- get_df_vote_m(df_profitPr = df_profitPr,
                             df_topVars = df_topVars,
                             x = x)
  
  df_profitPr[x,'prob0_up']   <- df_vote_m[1,'prob0_up']
  df_profitPr[x,'prob0_down'] <- df_vote_m[1,'prob0_down']
  df_profitPr[x,'prob0_up_sd']   <- df_vote_m[1,'prob0_up_sd']
  df_profitPr[x,'prob0_down_sd'] <- df_vote_m[1,'prob0_down_sd']
  df_profitPr[x,'scater_prob0_up']   <- df_vote_m[1,'scater_prob0_up']
  df_profitPr[x,'scater_prob0_down'] <- df_vote_m[1,'scater_prob0_down']
}
```


```{r}
View(df_profitPr[vVoteIndex[1:10],c("date","profit",
                              "prob0_up","prob0_down",
                              "prob0_up_sd",'prob0_down_sd',
                              'scater_prob0_up','scater_prob0_down')])
```


```{r}
ggplot(aes(x = pred, y = profit), data = df_train) +
  geom_point() +
  geom_vline(xintercept = vPred, linetype="dotted", 
                color = "red", size=1.5) +
  geom_hline(yintercept=0, linetype="dotted", 
             color = "red", size=1.5)
```


```{r}
vVars = c('prob0_up','prob0_up_sd','scater_prob0_up')

for (x in 1770:2440) {
  
  date <- df_profitPr[x,"date"]
  df <- df_profitPr[c(vVars,'profit','date')]
  df[sapply(df, is.nan)] <- NA
  df <- na.omit(df)
  index_tain <- df$date < (date)
  index_predict <- which(df$date == date)
  if (length(index_predict) == 0) {next}
    
  l <- create_X_y(df = df,
                  train_index = index_tain,
                  test_index = index_predict,
                  vVars = vVars)
  
  knn_test  <- knn.reg(train=l$X_train, y=l$y_train, test=l$X_test, k=10)
  df_profitPr[x,'profit_pred'] <- knn_test[['pred']]
}

df_profitPr_count <- df_profitPr[1770:2440,]
index <- which(df_profitPr_count$profit_pred > 0)
df_profitPr_count[,"trade_index"] <- 'NOT TRADE'
df_profitPr_count[index,"trade_index"] <- 'TRADE'


df_profitPr_count %>%
        mutate(profit_model = if_else(trade_index == 'TRADE', profit_by_day, 0)) %>%
        summarise(total_profit = sum(profit_by_day), total_profit_model = sum(profit_model, na.rm = TRUE),
                  mean_day_profit = mean(profit_by_day), mean_day_profit_model = mean(profit_model, na.rm = TRUE),
                  k = abs((mean_day_profit_model-mean_day_profit)/mean_day_profit))

df_profitPr_count %>%
        mutate(profit_model = if_else(trade_index == 'TRADE', profit_by_day, 0)) %>%
        group_by(year, month) %>%
        summarise(total_profit = sum(profit_by_day), total_profit_model = sum(profit_model, na.rm = TRUE),
                  mean_day_profit = mean(profit_by_day), mean_day_profit_model = mean(profit_model, na.rm = TRUE),
                  k = abs((mean_day_profit_model-mean_day_profit)/mean_day_profit))

df_profitPr_count %>%
        mutate(profit_model = if_else(trade_index == 'TRADE', profit_by_day, 0)) %>%
        group_by(year) %>%
        summarise(total_profit = sum(profit_by_day), total_profit_model = sum(profit_model, na.rm = TRUE),
                  mean_day_profit = mean(profit_by_day), mean_day_profit_model = mean(profit_model, na.rm = TRUE),
                  k = abs((mean_day_profit_model-mean_day_profit)/mean_day_profit))

df_profitPr_count %>%
  ggplot() +
  geom_point(aes(x = profit_pred, y = profit, color = profit_pred), 
             shape=15, size = 2) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('date')+ylab('profit_MA25') +
  ggtitle('Pred_Profit25')

money <- 100
money_model <- 100
rownames(df_profitPr_count) <- NULL
k <- 1
for (x in 1:nrow(df_profitPr_count)) {
  if (df_profitPr_count[x,"trade_index"] == 'TRADE') {
    money_model <- (k*money_model*df_profitPr_count[x,"profit_by_day"]/100+money_model)
  } else {
    money_model <- money_model
  }
  money <- (k*money*df_profitPr_count[x,"profit_by_day"]/100+money)
  
  df_profitPr_count[x,'money_model'] <- money_model
  df_profitPr_count[x,'money'] <- money
}

ymax <- max(c(df_profitPr_count[,'money_model'],df_profitPr_count[,'money']), na.rm = T)
df_profitPr_count %>%
  ggplot() +
  geom_point(aes(x = date, y = money), color = 'red', alpha = 0.2) +
  geom_point(aes(x = date, y = money_model), color = 'green', alpha = 0.2) +
  ylim(0,ymax)
```




# Plot

```{r}
ggplot() +
  geom_point(aes(x = profit_pred, y = profit_by_day, color = profit_pred), 
             shape=15, size = 2, data = df_profitPr) +
  scale_color_gradient2(midpoint=0, space = "Lab",
                        low="red", mid="white", high="green") +
  xlab('profit_pred')+ylab('profit')  +
  ggtitle('Pred_Profit25')
```

















































































